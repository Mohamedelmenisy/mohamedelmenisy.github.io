<!DOCTYPE html>
<html class="dark" data-hash="2025-06-24T15:30" dir="ltr" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>InfiniBase - Command Center</title>
  <!-- Fonts & CDNs -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* --------------------
       THEME / TOKENS (IMPROVED CONTRAST & SPACING)
       -------------------- */
    :root{
      --primary-600: #4f46e5;
      --primary-500: #6C5DD3;
      --primary-400: #8374FF;
      --bg: #0b1220;
      --card: #0f1724;
      --muted: #9aa3b2;
      --text: #E6EEF8;
      --danger: #ef4444;
      --success: #16a34a;
      --warning: #ffb020;
      --glass: rgba(255,255,255,0.03);
      --radius: 12px;
      --gap: 14px;
      --max-width: 1200px;
      --font-sans: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue';
      --font-ar: 'Cairo', sans-serif;
      --btn-padding: 10px 14px;
      --shadow-soft: 0 6px 20px rgba(2,6,23,0.55);
      --shadow-strong: 0 12px 36px rgba(2,6,23,0.65);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font-sans);
      background: linear-gradient(180deg,#061024 0%, #071428 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.45;
      font-size:15.5px;
    }
    [lang="ar"]{ font-family: var(--font-ar); direction: rtl; }

    .container{ max-width:var(--max-width); margin:0 auto; padding:18px; }

    /* Header */
    .app-header{
      display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:50;
      padding:10px 18px; background: rgba(8,12,20,0.6); backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }
    .brand{ color:var(--primary-400); font-weight:700; font-size:18px; display:flex; gap:10px; align-items:center; }

    /* Layout */
    .container-fluid { display:flex; min-height:calc(100vh - 60px); }
    .sidebar{
      width:260px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:18px; border-radius:12px; height: calc(100vh - 60px); position:sticky; top:70px; overflow:auto;
      box-shadow: var(--shadow-soft); border:1px solid rgba(255,255,255,0.02);
    }
    .content-wrapper{ flex:1; padding:18px; min-height:calc(100vh - 60px); overflow-y:auto; margin-left: 20px; }

    /* Cards & UI */
    .card{
      background: var(--card); border-radius:var(--radius); padding:16px; box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.03); margin-bottom:var(--gap);
    }
    .button, button{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      background: linear-gradient(135deg,var(--primary-500),var(--primary-400));
      color: white; border: none; border-radius:10px; padding: var(--btn-padding); cursor:pointer; font-weight:600;
      box-shadow: var(--shadow-soft); text-decoration:none;
    }
    .button-secondary{
      background: transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text); padding:10px 12px;
      border-radius:10px;
    }
    .button-danger{ background:var(--danger); padding:10px 12px; border-radius:10px; color:white; }

    /* Stats grid */
    .dashboard-stats-grid{ display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); margin-bottom:14px; }
    .dashboard-stat-card{ display:flex; gap:12px; align-items:center; padding:14px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    .icon-circle{ width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(131,116,255,0.12);border:1px solid rgba(131,116,255,0.14); font-size:20px; color:var(--primary-400); }
    .stat-info .stat-value{ display:block; font-size:20px; font-weight:700; color:var(--text); }
    .stat-info .stat-label{ color:var(--muted); font-size:13px; }

    /* Dashboard main grid */
    .dashboard-main-grid{ display:grid; gap:14px; grid-template-columns: 2fr 1fr; }
    @media(max-width:1024px){ .dashboard-main-grid{ grid-template-columns: 1fr; } }

    .chart-container{ min-height:360px; padding:14px; border-radius:12px; background:var(--card); border:1px solid rgba(255,255,255,0.02); }

    /* Activity log */
    .activity-log-item{ display:flex; align-items:center; gap:12px; padding:10px 8px; border-radius:8px; }
    .activity-log-item:hover{ background: rgba(255,255,255,0.02); }

    /* Top users */
    .top-users-list{ list-style:none; padding:0; margin:0; }
    .top-user-item{ display:flex; justify-content:space-between; padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.02); }

    /* Empty states */
    .empty-state{ text-align:center; padding:28px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px dashed rgba(255,255,255,0.03); color:var(--muted); }
    .empty-state h3{ color:var(--text); margin-bottom:8px; }

    /* Search */
    .search-container { position:relative; }
    .search-container input[type="search"]{ padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); color:var(--text); min-width:220px; }
    .search-icon{ position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--muted); }

    /* Modal */
    .modal-overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.6); visibility:hidden; opacity:0; transition:all 160ms; z-index:80; }
    .modal-overlay.open{ visibility:visible; opacity:1; }
    .modal-content{ width:100%; max-width:640px; background:var(--card); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); }

    /* Misc */
    .hidden{ display:none !important; }
    footer{ text-align:center; padding:20px; color:var(--muted); font-size:13px; }
  </style>
</head>
<body id="pageBody">
  <header class="app-header">
    <div class="brand"><span style="font-weight:700">InfiniBase</span><small style="font-weight:500; color:var(--muted);">Knowledge Center</small></div>
    <nav style="display:flex; gap:10px; align-items:center;">
      <a class="button-secondary" href="app.html">Home</a>
      <a class="button-secondary" href="insights.html">Insights</a>
      <span id="role-badge" style="padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)">guest</span>
    </nav>
  </header>

  <div class="container-fluid">
    <aside class="sidebar" id="sidebar">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='4' fill='%236366f1'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='18' font-weight='bold' fill='white'%3EIB%3C/text%3E%3C/svg%3E" style="width:42px;height:42px;border-radius:8px"/>
        <div style="font-weight:700">InfiniBase</div>
      </div>
      <nav id="navigationMenu">
        <div id="sidebarLoader" style="padding:10px;color:var(--muted)"><i class="fas fa-spinner fa-spin"></i> Loading Areas...</div>
      </nav>

      <div style="margin-top:auto;padding-top:12px">
        <button class="button button-danger" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</button>
        <div style="margin-top:10px;color:var(--muted);font-size:13px">Role: <span id="currentUserRoleSpan"></span></div>
      </div>
    </aside>

    <div class="content-wrapper" id="contentWrapper">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;position:sticky;top:70px;z-index:40;background:transparent;padding-bottom:12px">
        <div>
          <h1 id="currentSectionTitle" style="margin:0;font-size:20px">Welcome</h1>
          <div id="breadcrumbs" style="color:var(--muted);font-size:13px">Home</div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="search-container">
            <span class="search-icon"><i class="fas fa-search"></i></span>
            <input id="globalSearchInput" placeholder="Search the knowledge base..." type="search"/>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div id="userAvatar" style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary-500),var(--primary-400));display:flex;align-items:center;justify-content:center;font-weight:700">U</div>
            <div id="userNameDisplayHeader" style="font-weight:600">User</div>
          </div>
        </div>
      </header>

      <main id="pageContentArea">
        <div id="dashboardOverviewContainer" class="hidden">
          <!-- populated by JS -->
        </div>

        <div id="standardSectionContentPlaceholder">
          <!-- populated by JS -->
        </div>

        <div id="itemDetailViewPlaceholder" class="hidden"></div>
      </main>

      <footer>
        ¬© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.
      </footer>
    </div>
  </div>

  <div id="toastContainer"></div>

  <!-- ===========================
       SCRIPTS (FULL, NO SHORTCUTS)
       =========================== -->
  <script type="module">
    import { supabase } from './supabase.js';

    /* -----------------------
       Utilities
       ----------------------- */
    function escapeHTML(str){ if (str===undefined || str===null) return ''; const d=document.createElement('div'); d.textContent = String(str); return d.innerHTML; }
    function formatReadableDateISO(isoString){
      if(!isoString) return 'N/A';
      try {
        return new Date(isoString).toLocaleString('en-EG',{ day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit', hour12:true, timeZone:'Africa/Cairo' });
      } catch(e){ return isoString; }
    }
    function shortDateISO(iso){
      if(!iso) return null;
      const d = new Date(iso);
      // get yyyy-mm-dd (local Cairo offset isn't strictly required for grouping; this is simpler)
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function daysAgoDate(n){
      const now = new Date();
      now.setDate(now.getDate() - n);
      return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    }
    function showToast(message, type='info', duration=3000){
      const t = document.createElement('div');
      t.className = 'card';
      t.style.position = 'fixed'; t.style.right = '20px'; t.style.bottom = '20px'; t.style.zIndex = 2000; t.style.minWidth = '220px';
      t.innerHTML = `<strong style="display:block;margin-bottom:6px">${escapeHTML(message)}</strong>`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(10px)'; setTimeout(()=>t.remove(),250); }, duration);
    }

    /* -----------------------
       App state
       ----------------------- */
    let currentUser = null;
    let kbSystemData = { sections: [] };
    let dashboardData = { activityLog: [], articles: [], feedback: [], users: [], overallInsights: {}, weeklyActivity: [], topUsers: [] };
    let activityChartInstance = null;

    /* -----------------------
       Data fetchers (replaced missing v_* views)
       ----------------------- */
    async function getCurrentUserProfile(){
      try {
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        if(authError || !user) return null;
        const { data: profile, error } = await supabase.from('users').select('*').eq('id', user.id).single();
        if(error) return { id: user.id, email: user.email, role: 'viewer', name: user.email };
        return profile;
      } catch(e){
        console.error('getCurrentUserProfile error', e);
        return null;
      }
    }

    async function fetchSubCategories(){
      const { data, error } = await supabase.from('sub_categories').select('*').order('position');
      if(error){ console.error('fetchSubCategories', error); return []; }
      return data || [];
    }

    async function fetchArticles(){
      const { data, error } = await supabase.from('cases')
        .select('id, sub_category_id, title_en, description_en, content_en, title_ar, description_ar, content_ar, tags, type, url, parent_id, created_at, last_modified, is_published, slug')
        .eq('is_published', true)
        .order('created_at', { ascending: false });
      if(error){ console.error('fetchArticles', error); return []; }
      return data || [];
    }

    /* ---------- NEW: central dashboard fetch that uses actual tables ---------- */
    async function fetchDashboardData(){
      // use Promise.allSettled to be resilient
      const limitActivity = 500; // safe limit
      const results = await Promise.allSettled([
        supabase.from('activity_log').select('*').order('created_at', { ascending: false }).limit(limitActivity),
        supabase.from('cases').select('id, is_published, created_at, title_en'),
        supabase.from('kb_feedback').select('*'),
        supabase.from('users').select('id, name, full_name, username, email').limit(200)
      ]);

      const activity = results[0]?.status==='fulfilled' ? results[0].value.data || [] : [];
      const articles = results[1]?.status==='fulfilled' ? results[1].value.data || [] : [];
      const feedback = results[2]?.status==='fulfilled' ? results[2].value.data || [] : [];
      const users = results[3]?.status==='fulfilled' ? results[3].value.data || [] : [];

      if(results.some(r => r.status === 'rejected')){
        console.warn('Some dashboard queries failed', results.map(r => r.status==='rejected' ? r.reason : null));
        showToast('ÿ®ÿπÿ∂ ŸàŸäÿØÿ¨ÿßÿ™ ÿßŸÑÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ ŸÑŸÖ ÿ™Ÿèÿ≠ŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠ (ÿ±ÿßÿ¨ÿπ ÿßŸÑŸÑŸàÿ¨).', 'info', 3500);
      }

      // Basic computed metrics
      const totalArticles = Array.isArray(articles) ? articles.length : 0;
      const viewsArray = activity.filter(a => (a.action || '').toLowerCase() === 'viewed');
      const totalViews = viewsArray.length;
      const totalEdits = activity.filter(a => (a.action || '').toLowerCase() === 'updated').length;

      // Active users this week -> unique user_id from last 7 days
      const sevenDaysAgo = daysAgoDate(6); // includes today
      const recentActivity = activity.filter(a => {
        const t = a.created_at || a.timestamp || a.logged_at || null;
        if(!t) return false;
        const d = new Date(t);
        return d >= sevenDaysAgo;
      });
      const activeUsersSet = new Set(recentActivity.map(a => a.user_id).filter(Boolean));
      const activeUsersThisWeek = activeUsersSet.size;

      // Edits this week
      const editsThisWeek = recentActivity.filter(a => (a.action || '').toLowerCase() === 'updated').length;

      // Feedback KPIs
      const ratings = feedback.map(f => typeof f.rating === 'string' ? Number(f.rating) : f.rating).filter(v => !isNaN(v));
      const avgFeedbackRating = ratings.length ? (ratings.reduce((s,v)=>s+v,0)/ratings.length) : null;
      const helpfulRatings = feedback.filter(f => (f.rating || 0) >= 4).length;
      const notHelpfulRatings = feedback.filter(f => (f.rating || 0) < 3 && f.rating !== null && f.rating !== undefined).length;

      // TOP USERS: count 'viewed' per user (last 30 days), map to user records
      const thirtyDaysAgo = daysAgoDate(29);
      const recent30 = activity.filter(a => {
        const t = a.created_at || a.timestamp || a.logged_at;
        if(!t) return false;
        return (new Date(t)) >= thirtyDaysAgo;
      }).filter(a => (a.action || '').toLowerCase() === 'viewed' && a.user_id);

      const userStats = {};
      recent30.forEach(a => {
        const uid = a.user_id;
        if(!userStats[uid]) userStats[uid] = { user_id: uid, total_articles_viewed: 0 };
        userStats[uid].total_articles_viewed++;
      });

      const topUsersList = Object.values(userStats)
        .map(s => {
          const user = users.find(u => u.id === s.user_id);
          const user_name = user?.name || user?.full_name || user?.username || user?.email || `User ${s.user_id}`;
          return { user_name, total_articles_viewed: s.total_articles_viewed };
        })
        .sort((a,b) => b.total_articles_viewed - a.total_articles_viewed)
        .slice(0,5);

      // WEEKLY ACTIVITY aggregation for last 7 days (by date)
      const dates = [];
      for(let i=6;i>=0;i--){
        const d = daysAgoDate(i);
        const iso = d.toISOString().slice(0,10);
        dates.push(iso);
      }
      const weeklyActivity = dates.map(dateIso => {
        const itemsForDay = activity.filter(a => {
          const t = a.created_at || a.timestamp || a.logged_at;
          if(!t) return false;
          return shortDateISO(t) === dateIso;
        });
        const total_views = itemsForDay.filter(a => (a.action||'').toLowerCase() === 'viewed').length;
        const active_users = new Set(itemsForDay.map(a => a.user_id).filter(Boolean)).size;
        return { activity_date_egypt: dateIso, total_views, active_users };
      });

      // Build result
      const overallInsights = {
        total_articles: totalArticles,
        total_views_all: totalViews,
        total_edits: totalEdits,
        active_users_this_week: activeUsersThisWeek,
        edits_this_week: editsThisWeek,
        avg_feedback_rating: avgFeedbackRating
      };

      return {
        activityLog: activity,
        articles,
        feedback,
        users,
        overallInsights,
        weeklyActivity,
        topUsers: topUsersList,
        feedbackKpis: { helpful_ratings: helpfulRatings, not_helpful_ratings: notHelpfulRatings }
      };
    }

    /* -----------------------
       Rendering helpers
       ----------------------- */
    function renderEmptyState(container, title = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™', subtitle = '') {
      container.innerHTML = `<div class="empty-state"><h3>${escapeHTML(title)}</h3><p style="margin-top:6px">${escapeHTML(subtitle)}</p></div>`;
    }

    function renderTopUsers(topUsers){
      const container = document.getElementById('topUsersContainer');
      if(!container) return;
      if(!topUsers || topUsers.length === 0){
        container.innerHTML = `<h3>üî• Most Active Users This Week</h3><div class="card empty-state"><p>No user activity this week.</p></div>`;
        return;
      }
      const html = topUsers.map((u, i) => `
        <div class="top-user-item">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="width:36px;height:36px;border-radius:8px;background:rgba(131,116,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700">${i+1}</div>
            <div style="font-weight:600">${escapeHTML(u.user_name)}</div>
          </div>
          <div style="font-weight:700;color:var(--primary-400)">${u.total_articles_viewed} views</div>
        </div>
      `).join('');
      container.innerHTML = `<h3 style="margin:0 0 10px 0">üî• Most Active Users (30 days)</h3><div>${html}</div>`;
    }

    function renderActivityLog(activity){
      const container = document.getElementById('recentActivityContainer');
      if(!container) return;
      if(!activity || activity.length===0){
        container.innerHTML = `<h3>Recent Activity</h3><div class="card empty-state"><p>No recent activity found.</p></div>`;
        return;
      }
      const items = activity.slice(0, 40).map(log => {
        const action = escapeHTML(log.action || 'action');
        const userName = escapeHTML(log.user_name || log.user || 'Unknown');
        const title = log.item_title ? ` on <strong>${escapeHTML((log.item_title||'').slice(0,60))}</strong>` : '';
        const time = formatReadableDateISO(log.created_at || log.timestamp || log.logged_at);
        const icon = {
          created: '<i class="fas fa-plus-circle" style="color:var(--success)"></i>',
          updated: '<i class="fas fa-pen" style="color:var(--warning)"></i>',
          deleted: '<i class="fas fa-trash-alt" style="color:var(--danger)"></i>',
          viewed: '<i class="fas fa-eye" style="color:var(--primary-400)"></i>'
        }[(log.action||'').toLowerCase()] || '<i class="fas fa-history" style="color:var(--muted)"></i>';

        return `<div class="activity-log-item card" style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="width:38px;text-align:center">${icon}</div>
            <div style="line-height:1.2">
              <div style="font-weight:600">${userName} <span style="font-weight:400;color:var(--muted);"> ${action} ${title}</span></div>
              <div style="color:var(--muted);font-size:13px">${escapeHTML((log.section||'')+'')}</div>
            </div>
          </div>
          <div style="color:var(--muted);font-size:13px">${time}</div>
        </div>`;
      }).join('');
      container.innerHTML = `<h3>Recent Activity</h3><div>${items}</div>`;
    }

    function renderDashboardCharts(data){
      const ctx = document.getElementById('activityChart')?.getContext('2d');
      if(!ctx){ return; }
      if(activityChartInstance) activityChartInstance.destroy();

      const weekly = data.weeklyActivity || [];
      if(!weekly || weekly.length===0){
        // clear canvas area and show empty state
        document.getElementById('activityChart').style.display = 'none';
        const placeholder = document.querySelector('.chart-placeholder');
        if(placeholder) placeholder.innerHTML = `<div class="empty-state"><h3>No activity data</h3><p>Not enough data to render chart.</p></div>`;
        return;
      } else {
        document.getElementById('activityChart').style.display = '';
      }

      const labels = weekly.map(d => {
        // format YYYY-MM-DD -> Mon DD
        const t = new Date(d.activity_date_egypt + 'T00:00:00');
        return t.toLocaleDateString('en-US', { month:'short', day:'numeric' });
      });
      const views = weekly.map(d => d.total_views || 0);
      const activeUsers = weekly.map(d => d.active_users || 0);

      activityChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Total Views',
              data: views,
              borderRadius: 6,
              backgroundColor: 'rgba(131,116,255,0.9)',
              borderColor: 'rgba(131,116,255,1)',
            },
            {
              label: 'Active Users',
              data: activeUsers,
              type: 'line',
              tension: 0.35,
              borderColor: 'rgba(22,163,74,0.95)',
              backgroundColor: 'rgba(22,163,74,0.12)',
              yAxisID: 'y1',
              pointRadius: 3,
              pointHoverRadius: 5,
            }
          ]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          plugins: {
            legend:{ labels:{ color: getComputedStyle(document.documentElement).getPropertyValue('--text') } }
          },
          scales: {
            x: { grid:{ display:false }, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted') } },
            y: { ticks:{ color: getComputedStyle(document.documentElement).getPropertyValue('--muted') }, grid:{ color:'rgba(255,255,255,0.03)' } },
            y1: { position:'right', grid:{ drawOnChartArea:false }, ticks:{ color: getComputedStyle(document.documentElement).getPropertyValue('--muted') } }
          }
        }
      });
    }

    /* -----------------------
       Build dashboard UI (inject full contents)
       ----------------------- */
    async function renderDynamicDashboard(){
      // fetch
      const data = await fetchDashboardData();
      dashboardData = data;

      // populate overview
      const insights = data.overallInsights || {};
      const overview = document.getElementById('dashboardOverviewContainer');
      overview.classList.remove('hidden');

      overview.innerHTML = `
        <div class="dashboard-stats-grid">
          <div class="dashboard-stat-card">
            <div class="icon-circle"><i class="fas fa-newspaper"></i></div>
            <div class="stat-info"><span class="stat-value">${insights.total_articles || 0}</span><span class="stat-label">Total Articles</span></div>
          </div>
          <div class="dashboard-stat-card">
            <div class="icon-circle"><i class="fas fa-eye"></i></div>
            <div class="stat-info"><span class="stat-value">${insights.total_views_all || 0}</span><span class="stat-label">Total Views</span></div>
          </div>
          <div class="dashboard-stat-card">
            <div class="icon-circle"><i class="fas fa-users"></i></div>
            <div class="stat-info"><span class="stat-value">${insights.active_users_this_week || 0}</span><span class="stat-label">Active Users (Week)</span></div>
          </div>
          <div class="dashboard-stat-card">
            <div class="icon-circle"><i class="fas fa-star"></i></div>
            <div class="stat-info"><span class="stat-value">${insights.avg_feedback_rating ? Number(insights.avg_feedback_rating).toFixed(2) : 'N/A'}</span><span class="stat-label">Avg. Feedback</span></div>
          </div>
          <div class="dashboard-stat-card">
            <div class="icon-circle"><i class="fas fa-edit"></i></div>
            <div class="stat-info"><span class="stat-value">${insights.edits_this_week || 0}</span><span class="stat-label">Edits This Week</span></div>
          </div>
        </div>

        <div class="dashboard-main-grid">
          <div class="chart-container card">
            <h3 style="margin:0 0 10px 0">Content Activity (Last 7 Days)</h3>
            <div class="chart-placeholder" style="min-height:260px">
              <canvas id="activityChart" style="width:100%;height:240px"></canvas>
            </div>
          </div>

          <div id="topUsersContainer" class="card">
            <!-- top users -->
          </div>

          <div id="recentActivityContainer" class="card" style="grid-column:1 / -1">
            <!-- recent activity -->
          </div>
        </div>
      `;

      // render charts & lists
      renderDashboardCharts(data);
      renderTopUsers(data.topUsers || []);
      renderActivityLog(data.activityLog || []);
    }

    /* -----------------------
       Sidebar / sections
       ----------------------- */
    async function loadAndStructureData(){
      const [categories, articles] = await Promise.all([ fetchSubCategories(), fetchArticles() ]);
      const sections = (categories || []).map(c => ({ ...c, slug: (c.name||'').toLowerCase().replace(/\s+/g,'-'), items: [] }));
      (articles || []).forEach(a => {
        const s = sections.find(x => x.id === a.sub_category_id);
        if(s) s.items.push(a);
      });
      kbSystemData.sections = sections;
      populateSidebar();
    }

    function populateSidebar(){
      const nav = document.getElementById('navigationMenu');
      const home = `<a href="#home" style="display:block;padding:10px;border-radius:8px;color:var(--text);text-decoration:none">üè† Home</a>`;
      let html = home;
      const secs = kbSystemData.sections || [];
      if(secs.length===0){
        html += `<div style="color:var(--muted);margin-top:8px">No knowledge areas yet.</div>`;
      } else {
        html += `<div style="margin-top:8px;font-weight:700;color:var(--muted);font-size:12px">KNOWLEDGE AREAS</div>`;
        secs.forEach(s=>{
          html += `<a href="#${s.slug}" class="sidebar-link" style="display:block;padding:8px;margin-top:6px;border-radius:8px;color:var(--text);text-decoration:none">${escapeHTML(s.name)}</a>`;
        });
      }
      nav.innerHTML = html;
    }

    /* -----------------------
       Navigation and init
       ----------------------- */
    function highlightSidebarLink(){} // kept placeholder if needed

    async function displayDashboard(){
      document.getElementById('dashboardOverviewContainer').classList.remove('hidden');
      document.getElementById('standardSectionContentPlaceholder').classList.add('hidden');
      document.getElementById('itemDetailViewPlaceholder').classList.add('hidden');
      document.getElementById('currentSectionTitle').textContent = 'Dashboard';
      await renderDynamicDashboard();
    }

    /* -----------------------
       Init
       ----------------------- */
    async function initializeApp(){
      try {
        currentUser = await getCurrentUserProfile();
        if(!currentUser){ window.location.href = '/login.html'; return; }
        document.getElementById('userNameDisplayHeader').textContent = currentUser.name || currentUser.email || 'User';
        const initials = (currentUser.name || 'U').split(' ').map(p=>p[0]).join('').slice(0,2).toUpperCase();
        document.getElementById('userAvatar').textContent = initials;
        document.getElementById('currentUserRoleSpan').textContent = currentUser.role || 'viewer';

        await loadAndStructureData();
        setupEventListeners();
        await displayDashboard();

        showToast(`Welcome back, ${currentUser.name || currentUser.email}!`, 'info', 2000);
      } catch (e){
        console.error('initializeApp error', e);
        document.getElementById('pageContentArea').innerHTML = `<div class="card"><h2>Application Error</h2><p>ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©. ÿ¨ÿ±ÿ® ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ.</p></div>`;
      }
    }

    function setupEventListeners(){
      document.getElementById('logoutButton')?.addEventListener('click', async ()=> {
        try {
          await supabase.auth.signOut();
          window.location.href = '/login.html';
        } catch(e){
          console.error('logout error', e); showToast('Logout failed', 'info');
        }
      });

      document.getElementById('globalSearchInput').addEventListener('input', (e)=>{
        const q = e.target.value.trim().toLowerCase();
        const placeholder = document.getElementById('standardSectionContentPlaceholder');
        if(!q){ placeholder.innerHTML = ''; return; }
        const allItems = kbSystemData.sections.flatMap(s => s.items.map(i => ({...i, sectionName: s.name})));
        const res = allItems.filter(i => (i.title_en||'').toLowerCase().includes(q) || (i.description_en||'').toLowerCase().includes(q));
        if(res.length === 0){
          placeholder.innerHTML = `<div class="card empty-state"><h3>No results</h3><p>No items match "${escapeHTML(q)}".</p></div>`;
        } else {
          placeholder.innerHTML = `<div class="cards-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px">${res.map(it=>`<div class="card" style="cursor:pointer"><h3>${escapeHTML(it.title_en)}</h3><p style="color:var(--muted)">${escapeHTML((it.description_en||'').slice(0,140))}</p></div>`).join('')}</div>`;
        }
        placeholder.classList.remove('hidden');
        document.getElementById('dashboardOverviewContainer').classList.add('hidden');
      });
    }

    // Expose for debug if needed
    window.fetchDashboardData = fetchDashboardData;
    window.renderDynamicDashboard = renderDynamicDashboard;

    // start
    initializeApp();
  </script>
</body>
</html>
