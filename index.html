<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/919/919820.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark body {
            background-image: linear-gradient(to bottom right, #111827, #1f2937);
            background-color: #111827;
            color: #d1d5db;
        }
        body:not(.dark) {
            background-image: linear-gradient(to bottom right, #ffffff, #e5e7eb);
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .sidebar {
            width: 16rem;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            padding: 1.5rem;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            z-index: 40;
        }
        .dark .sidebar { background-color: #1f2937; color: #9ca3af; border-right: 1px solid #374151; }
        body:not(.dark) .sidebar { background-color: #ffffff; color: #4b5563; border-right: 1px solid #e5e7eb; }
        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }
        .dark .sidebar-header { color: #ffffff; }
        body:not(.dark) .sidebar-header { color: #1f2937; }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
        }
        .dark .sidebar-link { color: #9ca3af; }
        body:not(.dark) .sidebar-link { color: #4b5563; }
        .dark .sidebar-link:hover { background-color: #374151; color: #ffffff; }
        body:not(.dark) .sidebar-link:hover { background-color: #e5e7eb; color: #1f2937; }
        .sidebar-link.active {
            font-weight: 600;
            background-color: #2563eb;
            color: #ffffff;
        }
        .sidebar-link i { margin-right: 0.75rem; width: 1.25rem; text-align: center; }
        .sidebar-section-title {
            padding-left: 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .dark .sidebar-section-title { color: #6b7280; }
        body:not(.dark) .sidebar-section-title { color: #9ca3af; }
        .content-wrapper {
            margin-left: 16rem;
            height: 100vh;
            overflow-y: auto;
            transition: margin-left 0.3s ease-in-out;
        }
        .content-header {
            position: sticky;
            top: 0;
            padding: 1.25rem 2rem;
            z-index: 20;
            backdrop-filter: blur(8px);
        }
        .dark .content-header { background-color: rgba(17, 24, 39, 0.9); border-bottom: 1px solid #374151; }
        body:not(.dark) .content-header { background-color: rgba(243, 244, 246, 0.9); border-bottom: 1px solid #e5e7eb; }
        .card {
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .dark .card { background-color: #1f2937; }
        body:not(.dark) .card { background-color: #ffffff; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .modal-content {
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 48rem;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .dark .modal-content { background-color: #1f2937; }
        body:not(.dark) .modal-content { background-color: #ffffff; }
        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-content-sm { 
            max-width: 28rem;
        }
        .quill-editor-container { height: 200px; margin-bottom: 1rem; border-radius: 0.375rem; overflow: hidden; }
        .dark .quill-editor-container .ql-toolbar { background: #374151; border-color: #4b5563 !important; }
        .dark .quill-editor-container .ql-container { background: #2d3748; border-color: #4b5563 !important; color: #d1d5db; }
        body:not(.dark) .quill-editor-container .ql-toolbar { background: #f9fafb; border-color: #d1d5db !important; }
        body:not(.dark) .quill-editor-container .ql-container { background: #ffffff; border-color: #d1d5db !important; color: #1f2937; }
        .chart-container {
            position: relative;
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .dark .chart-container { background-color: #1f2937; }
        body:not(.dark) .chart-container { background-color: #ffffff; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .content-wrapper { margin-left: 0; }
            .sidebar-toggle-button { display: block; }
        }
        .hidden { display: none !important; }
        input:focus, button:focus, select:focus, textarea:focus, a:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .dark input:focus, .dark button:focus, .dark select:focus, .dark textarea:focus, .dark a:focus {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.6);
        }
        mark { padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold; }
        .dark mark { background-color: #78350f; color: #f3f4f6; }
        body:not(.dark) mark { background-color: #fde047; color: #1f2937; }
    </style>
</head>
<body class="bg-gradient-to-br from-white to-gray-100 dark:from-gray-900 dark:to-gray-800">
    <!-- Add New Content Modal -->
    <div id="addContentModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-indigo-700 dark:text-indigo-300">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="p-2 rounded-full hover:bg-indigo-100 dark:hover:bg-indigo-900 transition-colors">
                    <i class="fas fa-times text-xl text-indigo-600 dark:text-indigo-400"></i>
                </button>
            </div>
            <form id="addContentForm">
                <div class="mb-5">
                    <label for="contentType" class="block text-sm font-medium mb-2 text-indigo-700 dark:text-indigo-300">Content Type</label>
                    <select id="contentType" class="p-3 w-full border rounded-lg bg-white dark:bg-gray-800 border-indigo-200 dark:border-indigo-600 text-gray-900 dark:text-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="case">Case</option>
                    <option value="sheet">Sheet</option>
                    <option value="form">Form</option>
                    <option value="video">Video</option>
                    <option value="design">Design</option>
                </select>
            </div>
            <div class="mb-5">
                <label for="contentTitle" class="block text-sm font-medium mb-2 text-indigo-700 dark:text-indigo-300">Title</label>
                <input type="text" id="contentTitle" class="p-3 w-full border rounded-lg bg-white dark:bg-gray-800 border-indigo-200 dark:border-indigo-600 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>
            <div class="mb-5">
                <label for="contentSummary" class="block text-sm font-medium mb-2 text-indigo-700 dark:text-indigo-300">Summary</label>
                <textarea id="contentSummary" class="p-3 w-full border rounded-lg bg-white dark:bg-gray-800 border-indigo-200 dark:border-indigo-600 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500" rows="4" required></textarea>
            </div>
            <div class="mb-5 hidden" id="contentUrlContainer">
                <label for="contentUrl" class="block text-sm font-medium mb-2 text-indigo-700 dark:text-indigo-300">URL (for Sheet/Form/Video/Design)</label>
                <input type="url" id="contentUrl" class="p-3 w-full border rounded-lg bg-white dark:bg-gray-800 border-indigo-200 dark:border-indigo-600 text-gray-900 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mb-6 hidden" id="resolutionStepsContainer">
                <label class="block text-sm font-medium mb-2 text-indigo-700 dark:text-indigo-300">Resolution Steps (for Case)</label>
                <div id="quillEditor" class="quill-editor-container"></div>
                <label class="block text-sm font-medium mb-3 text-indigo-700 dark:text-indigo-300">Attach File/Link</label>
                <input type="file" id="caseFileUpload" accept=".pdf,.docx" class="mt-2 block w-full text-sm text-gray-500 dark:text-gray-400 file:w-full file:py-2 file:px-4 file:border file:rounded-lg file:border-indigo-200 dark:file:border-indigo-600 file:bg-indigo-50 dark:file:bg-indigo-700/20 file:text-sm file:font-semibold file:text-indigo-700 dark:file:text-indigo-300 hover:file:bg-indigo-100 dark:hover:file:bg-indigo-600 transition-colors">
                <input type="url" id="caseDriveLink" placeholder="Paste Google Drive Link" class="mt-2 p-3 w-full border rounded-lg bg-white dark:bg-gray-800 border-indigo-200 dark:border-indigo-600 text-gray-900 dark:text-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mb-5 hidden" id="caseAttachmentsContainer">
                <label class="block text-sm font-medium mb-2 text-indigo-700 dark:text-indigo-300">Attachments (Optional)</label>
                <div class="space-y-4 p-4 border border-indigo-200 dark:border-indigo-600 rounded-lg bg-indigo-50 dark:bg-indigo-700/10">
                    <div>
                        <label for="caseFileUpload" class="block text-xs font-semibold text-indigo-600 dark:text-indigo-400">Upload File (PDF, DOCX, TXT, Images)</label>
                        <input type="file" id="caseFileUpload" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" class="mt-2 block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-3 file:px-4 file:rounded-lg file:border file:border-indigo-300 dark:file:border-indigo-600 file:text-sm file:font-semibold file:bg-indigo-100 dark:file:bg-indigo-700 file:text-indigo-700 dark:file:text-indigo-300 hover:file:bg-indigo-200 dark:hover:file:bg-indigo-600 transition-colors">
                    </div>
                    <div>
                        <label for="caseDriveLink" class="block text-xs font-semibold text-indigo-600 dark:text-indigo-400">Or Paste External Link (Google Drive)</label>
                        <input type="url" id="caseDriveLink" placeholder="https://ui-abc.com" class="mt-2 p-3 w-full border rounded-lg bg-white dark:bg-gray-800 border-indigo-200 dark:border-indigo-600 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900 dark:text-gray-300">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 pt-4 border-t border-indigo-200 dark:border-t border-gray-200 dark-t border-gray-700">
                <button type="button" id="cancelAddContentBtn" class="px-5 py-3 border rounded-lg bg-gray-300 hover:bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200">Cancel</button>
                    <button type="submit" id="saveContentBtn" class="px-5 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Logout Modal -->
    <div id="logoutConfirmModal" class="modal-overlay hidden">
        <div class="modal-content modal-content-sm">
            <div class="text-center">
                <i class="fas fa-exclamation fa-exclamation-triangle text-yellow-400 text-4xl mb-4"></i>
                <h3 class="text-xl font-semibold mb-2 text-indigo-700 dark:text-indigo-300">Confirm Logout</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Are you sure you want to log out?</p>
                <div class="flex justify-center space-x-4">
                    <button id="cancelLogoutBtn" class="px-6 py-2.5 bg-gray-300 hover:bg-gray-400 text-indigo-800 dark:text-gray-200 dark:bg-gray-600 dark:hover:bg-gray-500 rounded-lg">Cancel</button>
                    <button id="confirmLogoutBtn" class="px-6 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="logoutConfirm" id="fixed inset-0 bg-black bg-opacity-50 flex items-center items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl text-center shadow-lg">
            <p class="text-lg font-semibold mb-4 text-indigo-700 dark:text-indigo-300">Are you sure you want to log out?</p>
            <div class="flex justify-center space-x-4">
                <button onclick="document.getElementById('logoutConfirmModal').classList.class('hidden')" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-white rounded">Cancel</button>
                <button onclick="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">Logout</button>
            </div>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-64" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database mr-3 text-indigo-400"></i> InfiniBase
            </div>
            <nav id="navigationMenu">
                <div class="sidebar-section-title">Main</div>
                <a href="#home" class="sidebar-link active" data-section="home"><i class="fas fa-home text-indigo-400"></i>Home</a>
                <div class="sidebar-section-title">Knowledge Areas</div>
                <a href="#support" class="sidebar-link" data-section="support"><i class="fas fa-headset text-indigo-400"></i>Support</a>
                <a href="#partner_care" class="sidebar-link" data-section="partner_care"><i class="fas fa-handshake text-indigo-400"></i>Partner Care</a>
                <a href="#logistics" class="sidebar-link" data-section="logistics"><i class="fas fa-truck text-indigo-400"></i>Logistics</a>
                <a href="#customer_care" class="sidebar-link" data-section="customer_care"><i class="fas fa-users text-indigo-400"></i>Customer Care</a>
                <a href="#dist_follow_up" class="sidebar-link" data-section="dist_follow_up"><i class="fas fa-people-carry text-indigo-400"></i>Distribution & Follow-up</a>
                <a href="#logistics_driver" class="sidebar-link" data-section="logistics_driver"><i class="fas fa-shipping-fast text-indigo-400"></i>Logistics (Driver Complaints)</a>
                <a href="#logistics_3pl" class="sidebar-link" data-section="logistics_3pl"><i class="fas fa-boxes text-indigo-400"></i>Logistics-3PL</a>
                <a href="#order_at_store" class="sidebar-link" data-section="order_at_store"><i class="fas fa-store text-indigo-400"></i>Order at Store (Mac)</a>
                <a href="#logistics_admin" class="sidebar-link" data-section="logistics_admin"><i class="fas fa-user-shield text-indigo-400"></i>Logistics-Admin</a>
                <a href="#os" class="sidebar-link" data-section="os"><i class="fab fa-windows text-indigo-400"></i>Operating Systems</a>
                <div class="sidebar-section-title">Resources & Policies</div>
                <a href="#compensation" class="sidebar-link" data-section="compensation"><i class="fas fa-hand-holding-usd text-indigo-400"></i>Compensation Policies</a>
                <a href="#op_instructions" class="sidebar-link" data-section="op_instructions"><i class="fas fa-clipboard-list text-indigo-400"></i>Operational Instructions</a>
                <a href="#forms_templates" class="sidebar-link" data-section="forms_templates"><i class="fas fa-file-alt text-indigo-400"></i>Forms/Templates</a>
            </nav>
            <div class="absolute bottom-6 left-0 right-0 px-6">
                <button id="themeSwitcher" class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition shadow-sm border border-indigo-300 dark:border-indigo-600 hover:bg-indigo-100 dark:hover:bg-indigo-700">
                    <i id="themeIcon" class="fas fa-moon mr-2 text-indigo-400"></i> <span id="themeText">Dark Mode</span>
                </button>
                <button id="logoutButton" class="w-full mt-3 flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition shadow-sm bg-red-600 hover:bg-red-700 text-white">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Mobile Sidebar Toggle -->
        <button id="mobileSidebarToggle" class="sidebar-toggle-button p-2 rounded-md bg-indigo-700 text-white md:hidden fixed top-4 left-4 z-50">
            <i class="fas fa-bars text-xl"></i>
        </button>

        <div class="content-wrapper ml-64" id="contentWrapper">
            <header class="content-header">
                <div class="flex justify-between items-center w-full">
                    <div>
                        <h1 id="currentSectionTitle" class="text-2xl md:text-3xl font-bold text-indigo-700 dark:text-indigo-300">Welcome</h1>
                        <div id="breadcrumbs" class="text-sm mt-1 text-indigo-500 dark:text-indigo-400">Home</div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="search" id="globalSearchInput" placeholder="Search KB..." class="py-2.5 pl-10 pr-4 w-64 md:w-96 border rounded-full bg-white dark:bg-gray-800 border-indigo-300 dark:border-indigo-600 focus:ring-indigo-500 focus:border-indigo-500 text-gray-900 dark:text-gray-200">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-indigo-400"></i></span>
                            <div id="searchResultsContainer" class="hidden absolute mt-1 w-full max-h-80 overflow-y-auto rounded-md shadow-lg bg-white dark:bg-gray-800 border border-indigo-200 dark:border-indigo-600 z-10"></div>
                        </div>
                        <div id="userProfileContainer" class="flex items-center space-x-2">
                            <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=4f46e5&color=fff&rounded=true" alt="User" class="w-9 h-9 rounded-full">
                            <span id="userNameDisplayHeader" class="font-medium hidden sm:block text-indigo-700 dark:text-indigo-300">User</span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="p-6 md:p-8" id="pageContentArea">
                <div id="dashboardOverviewContainer" class="hidden space-y-8 max-w-full">
                    <div class="card bg-gradient-to-r from-indigo-600 to-indigo-800 text-white">
                        <h2 class="text-3xl font-bold mb-2" id="welcomeUserNameDashboard">Welcome, User!</h2>
                        <p class="text-indigo-200">Overview of knowledge base activity.</p>
                        <p class="text-sm text-indigo-300 mt-1">InfiniBase v<span id="kbVersionDashboard"></span> | Last Update: <span id="lastKbUpdateDashboard"></span></p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-8">
                            <div class="card chart-container h-72 md:h-80">
                                <h3 class="text-lg font-semibold mb-2 text-center text-indigo-700 dark:text-indigo-300">User Activity</h3>
                                <canvas id="usersChart"></canvas>
                            </div>
                            <div class="card chart-container h-72 md:h-80">
                                <h3 class="text-lg font-semibold mb-2 text-center text-indigo-700 dark:text-indigo-300">Case Views</h3>
                                <canvas id="casesChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-3 text-indigo-700 dark:text-indigo-300">Recent Updates</h3>
                            <div class="h-40 overflow-y-auto p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md">
                                <ul id="recentUpdatesList" class="space-y-1 text-sm"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-700 dark:text-indigo-300">Advanced Data Filters</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="filterDate" class="block text-sm font-medium mb-1 text-indigo-700 dark:text-indigo-300">Date</label>
                                <input type="date" id="filterDate" class="p-2 w-full border rounded-md bg-white dark:bg-gray-800 border-indigo-300 dark:border-indigo-600 text-gray-900 dark:text-gray-200">
                            </div>
                            <div>
                                <label for="filterUser" class="block text-sm font-medium mb-1 text-indigo-700 dark:text-indigo-300">User</label>
                                <select id="filterUser" class="p-2 w-full border rounded-md bg-white dark:bg-gray-800 border-indigo-300 dark:border-indigo-600 text-gray-900 dark:text-gray-200">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterInteraction" class="block text-sm font-medium mb-1 text-indigo-700 dark:text-indigo-300">Interaction Type</label>
                                <select id="filterInteraction" class="p-2 w-full border rounded-md bg-white dark:bg-gray-800 border-indigo-300 dark:border-indigo-600 text-gray-900 dark:text-gray-200">
                                    <option value="">All Types</option>
                                    <option value="article_view">Article View</option>
                                    <option value="case_created">Case Created</option>
                                    <option value="navigation">Navigation</option>
                                </select>
                            </div>
                            <button id="applyFilterBtn" class="px-4 py-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 h-10">Apply Filters</button>
                        </div>
                    </div>
                </div>
                <div id="standardSectionContentPlaceholder" class="space-y-8 max-w-full"></div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm text-indigo-500 dark:text-indigo-400 border-t border-indigo-200 dark:border-indigo-700">
                <p>Â© <script>document.write(new Date().getFullYear())</script> InfiniBase.elmenisy. All rights reserved.</p>
            </footer>
        </div>
    </div>

    <script type="module">
        // Simulated Supabase
        const supabase = {
            from: (table) => ({
                select: async (columns = '*') => {
                    console.log(`Simulated Supabase: SELECT ${columns} FROM ${table}`);
                    if (table === 'views_log') {
                        return { data: [
                            { id: 1, item_id: 'case001', item_type: 'case_created', user_identifier: 'user1@sim.com', viewed_at: '2025-05-25T10:00:00Z' },
                            { id: 2, item_id: 'sup001', item_type: 'article_view', user_identifier: 'user2@sim.com', viewed_at: '2025-05-25T11:00:00Z' },
                            { id: 3, item_id: 'home', item_type: 'navigation', user_identifier: 'user1@sim.com', viewed_at: '2025-05-25T09:00:00Z' },
                        ], error: null };
                    }
                    if (table === 'cases') return { data: [], error: null };
                    return { data: [], error: null };
                },
                insert: async (records) => {
                    console.log(`Simulated Supabase: INSERT INTO ${table}`, records);
                    const newId = Math.floor(Math.random() * 10000);
                    return { data: [{ id: newId, ...records[0] }], error: null };
                },
                rpc: async (fnName, params) => {
                    if (fnName === 'get_distinct_viewers') {
                        return { data: [
                            { user_identifier: 'user1@sim.com' },
                            { user_identifier: 'user2@sim.com' },
                            { user_identifier: 'test@sim.com' }
                        ], error: null };
                    }
                    return { data: null, error: { message: "RPC not found" } };
                }
            })
        };

        // Simulated Auth
        const Auth = {
            isAuthenticated: () => true,
            getCurrentUser: () => ({ email: 'testuser@example.com', fullName: 'Test User', role: 'admin' }),
            logout: () => { window.location.href = 'login.html'; },
            protectPage: () => { if (!Auth.isAuthenticated()) { alert('Not Authorized'); window.location.href = '/login.html'; throw 'Stop Execution'; } }
        };

        // Simulated KB Data
        const kbSystemData = {
            meta: { version: '0.1.2', lastGlobalUpdate: '2023-11-28T12:00:00Z' },
            sections: [
                { id: 'support', name: 'Support', icon: 'fas fa-headset', themeColor: 'indigo', description: 'Support resources.', articles: [{ id: 'sup001', title: 'High Priority Ticket', summary: 'Handling P1s.', tags: ['p1'], contentPath: '#' }], cases: [{ id: 'case001', title: 'User Alpha Disconnects', summary: 'Frequent disconnects.', status: 'Pending', tags: ['connectivity'] }], subCategories: [{ id: 'tools', name: 'Tools' }], glossary: [{ term: 'SLA', definition: 'Service Level Agreement' }] },
                { id: 'partner_care', name: 'Partner Care', icon: 'fas fa-handshake', themeColor: 'indigo', description: 'Partner support.', articles: [], cases: [], subCategories: [] },
                { id: 'logistics', name: 'Logistics', icon: 'fas fa-truck', themeColor: 'indigo', description: 'Logistics info.', articles: [], cases: [], subCategories: [] },
                { id: 'customer_care', name: 'Customer Care', icon: 'fas fa-users', themeColor: 'indigo', description: 'Customer support.', articles: [], cases: [], subCategories: [] },
                { id: 'dist_follow_up', name: 'Distribution & Follow-up', icon: 'fas fa-people-carry', themeColor: 'indigo', description: 'Follow-up resources.', articles: [], cases: [], subCategories: [] },
                { id: 'logistics_driver', name: 'Logistics (Driver Complaints)', icon: 'fas fa-shipping-fast', themeColor: 'indigo', description: 'Driver issues.', articles: [], cases: [], subCategories: [] },
                { id: 'logistics_3pl', name: 'Logistics-3PL', icon: 'fas fa-boxes', themeColor: 'indigo', description: 'Third-party logistics.', articles: [], cases: [], subCategories: [] },
                { id: 'order_at_store', name: 'Order at Store (Mac)', icon: 'fas fa-store', themeColor: 'indigo', description: 'Store orders.', articles: [], cases: [], subCategories: [] },
                { id: 'logistics_admin', name: 'Logistics-Admin', icon: 'fas fa-user-shield', themeColor: 'indigo', description: 'Admin logistics.', articles: [], cases: [], subCategories: [] },
                { id: 'os', name: 'Operating Systems', icon: 'fab fa-windows', themeColor: 'indigo', description: 'OS support.', articles: [], cases: [], subCategories: [] },
                { id: 'compensation', name: 'Compensation Policies', icon: 'fas fa-hand-holding-usd', themeColor: 'indigo', description: 'Compensation info.', articles: [], cases: [], subCategories: [], items: [] },
                { id: 'op_instructions', name: 'Operational Instructions', icon: 'fas fa-clipboard-list', themeColor: 'indigo', description: 'Instructions.', articles: [], cases: [], subCategories: [], items: [] },
                { id: 'forms_templates', name: 'Forms/Templates', icon: 'fas fa-file-alt', themeColor: 'indigo', description: 'Forms and templates.', articles: [], cases: [], subCategories: [], items: [] }
            ]
        };

        let contentEditorQuill;
        let usersChartInstance, casesChartInstance;
        const TABLES = { CASES: 'cases', VIEWS_LOG: 'views_log' };
        let currentSectionId = 'home';

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const contentWrapper = document.getElementById('contentWrapper');
        const pageContentArea = document.getElementById('pageContentArea');
        const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
        const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
        const currentSectionTitleEl = document.getElementById('currentSectionTitle');
        const breadcrumbsContainer = document.getElementById('breadcrumbs');
        const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
        const userAvatar = document.getElementById('userAvatar');
        const welcomeUserNameDashboard = document.getElementById('welcomeUserNameDashboard');
        const kbVersionDashboard = document.getElementById('kbVersionDashboard');
        const lastKbUpdateDashboard = document.getElementById('lastKbUpdateDashboard');
        const footerKbVersion = document.getElementById('footerKbVersion');
        const recentUpdatesList = document.getElementById('recentUpdatesList');

        // Initial Setup
        Auth.protectPage();
        const currentUser = Auth.getCurrentUser();

        if (currentUser) {
            const displayName = currentUser.fullName || currentUser.email || 'User';
            userNameDisplayHeader.textContent = displayName;
            welcomeUserNameDashboard.textContent = `Welcome, ${displayName}!`;
            userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&size=36&background=4f46e5&color=fff&rounded=true`;
        }
        if (kbSystemData.meta) {
            kbVersionDashboard.textContent = kbSystemData.meta.version;
            lastKbUpdateDashboard.textContent = new Date(kbSystemData.meta.lastGlobalUpdate).toLocaleDateString();
            footerKbVersion.textContent = kbSystemData.meta.version;
        }

        // Theme Switcher
        const themeSwitcher = document.getElementById('themeSwitcher');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const htmlElement = document.documentElement;

        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                themeText.textContent = 'Light Mode';
            } else {
                htmlElement.classList.remove('dark');
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                themeText.textContent = 'Dark Mode';
            }
            [usersChartInstance, casesChartInstance].forEach(chart => {
                if (chart) {
                    chart.options.plugins.legend.labels.color = theme === 'dark' ? '#e2e8f0' : '#1a202c';
                    if (chart.options.scales && chart.options.scales.y) {
                        chart.options.scales.y.ticks.color = theme === 'dark' ? '#94a3b8' : '#4a5568';
                        chart.options.scales.y.grid.color = theme === 'dark' ? '#374151' : '#e5e7eb';
                        chart.options.scales.x.ticks.color = theme === 'dark' ? '#94a3b8' : '#4a5568';
                        chart.options.scales.x.grid.color = theme === 'dark' ? '#374151' : '#e5e7eb';
                    }
                    chart.update();
                }
            });
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
        }
        themeSwitcher.addEventListener('click', () => {
            const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        loadTheme();

        // Mobile Sidebar Toggle
        mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
        sidebar.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.getAttribute('data-section');
                window.location.hash = sectionId;
                if (window.innerWidth < 768) sidebar.classList.remove('open');
                handleNavigation();
            });
        });

        // Logout Modal
        const logoutConfirmModal = document.getElementById('logoutConfirm');
        const logoutButton = document.getElementById('logoutButton');

        function confirmLogout() {
            Auth.logout();
        }

        logoutButton.addEventListener('click', () => {
            logoutConfirmModal.classList.remove('hidden');
        });

        // Add Content Modal
        const addContentModalOverlay = document.getElementById('addContentModalOverlay');
        const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
        const addContentForm = document.getElementById('addContentForm');
        const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
        const contentTypeSelect = document.getElementById('contentType');
        const contentUrlContainer = document.getElementById('contentUrlContainer');
        const resolutionStepsContainer = document.getElementById('resolutionStepsContainer');
        const caseAttachmentsContainer = document.getElementById('caseAttachmentsContainer');

        function openAddContentModal(sectionId) {
            currentSectionId = sectionId;
            addContentModalOverlay.classList.remove('hidden');
            if (!contentEditorQuill) {
                contentEditorQuill = new Quill('#quillEditor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['image', 'video', 'link'],
                            ['code-block'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Resolution steps...'
                });
            }
            addContentForm.reset();
            if (contentEditorQuill) contentEditorQuill.setText('');
            const fileInput = document.getElementById('caseFileUpload');
            if (fileInput) fileInput.value = '';
            contentTypeSelect.value = 'case';
            contentTypeSelect.dispatchEvent(new Event('change'));
            document.getElementById('contentTitle').focus();
        }
        function closeAddContentModal() {
            addContentModalOverlay.classList.add('hidden');
        }

        contentTypeSelect.addEventListener('change', () => {
            const type = contentTypeSelect.value;
            if (type === 'case') {
                contentUrlContainer.classList.add('hidden');
                resolutionStepsContainer.classList.remove('hidden');
                caseAttachmentsContainer.classList.remove('hidden');
            } else {
                contentUrlContainer.classList.remove('hidden');
                resolutionStepsContainer.classList.add('hidden');
                caseAttachmentsContainer.classList.add('hidden');
            }
        });

        closeAddContentModalBtn.addEventListener('click', closeAddContentModal);
        cancelAddContentBtn.addEventListener('click', closeAddContentModal);
        addContentForm.addEventListener('submit', async e => {
            e.preventDefault();
            await saveContentToSupabase();
        });

        function renderNewCase(title, date) {
            const html = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded shadow mb-2">
                    <h4 class="text-lg font-bold text-indigo-700 dark:text-indigo-300">${escapeHTML(title)}</h4>
                    <p class="text-sm text-indigo-500 dark:text-indigo-400">${new Date(date).toLocaleString()}</p>
                </div>`;
            if (recentUpdatesList && dashboardOverviewContainer && !dashboardOverviewContainer.classList.contains('hidden')) {
                recentUpdatesList.insertAdjacentHTML('afterbegin', html);
                while (recentUpdatesList.children.length > 10) {
                    recentUpdatesList.removeChild(recentUpdatesList.lastChild);
                }
            }
        }

        async function saveContentToSupabase() {
            const type = contentTypeSelect.value;
            const title = document.getElementById('contentTitle').value.trim();
            const summary = document.getElementById('contentSummary').value.trim();
            let contentData = { title, summary, type };

            if (type === 'case') {
                contentData.resolution_steps = contentEditorQuill.root.innerHTML;
                contentData.status = 'New';
            } else {
                contentData.url = document.getElementById('contentUrl').value.trim();
                if (!contentData.url) {
                    alert('URL is required for this content type.');
                    return;
                }
            }

            const user = Auth.getCurrentUser();
            contentData.created_by_email = user.email;
            contentData.created_by_name = user.fullName;

            const section = kbSystemData.sections.find(s => s.id === currentSectionId);
            let savedItemData;

            if (type === 'case') {
                const { data, error } = await supabase.from(TABLES.CASES).insert([contentData]).select();
                if (error) {
                    alert(`Error saving case: ${error.message}`);
                    console.error(error);
                    return;
                }
                savedItemData = data[0];
                section.cases.push({ ...savedItemData, id: savedItemData.id.toString() });
                logUserView(savedItemData.id, 'case_created');
                renderNewCase(savedItemData.title, new Date().toISOString());
            } else {
                if (!section.items) section.items = [];
                const newId = `item_${Date.now()}`;
                savedItemData = { ...contentData, id: newId };
                section.items.push(savedItemData);
                logUserView(newId, 'item_added');
            }

            alert('Content saved!');
            closeAddContentModal();
            displaySectionContent(currentSectionId);

            if (type === 'case' && savedItemData) {
                const newCaseLogEntry = {
                    item_id: savedItemData.id.toString(),
                    item_type: 'case_created',
                    user_identifier: user.email,
                    viewed_at: new Date().toISOString()
                };
                if (recentUpdatesList && dashboardOverviewContainer && !dashboardOverviewContainer.classList.contains('hidden')) {
                    const newLi = document.createElement('li');
                    newLi.className = "py-2 px-1 border-b border-indigo-200 dark:border-indigo-700 last:border-b-0";
                    let iconClass = 'fas fa-plus-circle text-indigo-500';
                    let actionText = 'created case';
                    newLi.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <i class="${iconClass} text-base text-indigo-400 dark:text-indigo-500"></i>
                            <div class="flex-1">
                                <span class="text-indigo-800 dark:text-indigo-200">
                                    <strong class="font-medium">${escapeHTML(newCaseLogEntry.user_identifier)}</strong> ${actionText}
                                    <strong class="font-medium">${escapeHTML(newCaseLogEntry.item_id)}</strong>
                                </span>
                                <span class="text-xs text-indigo-500 dark:text-indigo-400 block">${new Date(newCaseLogEntry.viewed_at).toLocaleString()}</span>
                            </div>
                        </div>`;
                    if (recentUpdatesList.firstChild) {
                        recentUpdatesList.insertBefore(newLi, recentUpdatesList.firstChild);
                    } else {
                        recentUpdatesList.appendChild(newLi);
                    }
                    while (recentUpdatesList.children.length > 10) {
                        recentUpdatesList.removeChild(recentUpdatesList.lastChild);
                    }
                }
            }
        }

        // Chart Initialization
        async function initCharts(viewData = []) {
            const isDark = htmlElement.classList.contains('dark');
            const legendColor = isDark ? '#e2e8f0' : '#1a202c';
            const ticksColor = isDark ? '#94a3b8' : '#4a5568';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            const chartOptions = (type) => ({
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: legendColor } } },
                scales: type === 'bar' ? {
                    y: { ticks: { color: ticksColor, beginAtZero: true }, grid: { color: gridColor } },
                    x: { ticks: { color: ticksColor }, grid: { color: gridColor } }
                } : {}
            });

            const userCounts = viewData.reduce((acc, view) => {
                acc[view.user_identifier] = (acc[view.user_identifier] || 0) + 1;
                return acc;
            }, {});

            if (usersChartInstance) usersChartInstance.destroy();
            const usersCtx = document.getElementById('usersChart')?.getContext('2d');
            if (usersCtx) {
                usersChartInstance = new Chart(usersCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(userCounts),
                        datasets: [{ label: 'User Views', data: Object.values(userCounts), backgroundColor: 'rgba(79, 70, 229, 0.7)' }]
                    },
                    options: chartOptions('bar')
                });
            }

            if (casesChartInstance) casesChartInstance.destroy();
            const casesCtx = document.getElementById('casesChart')?.getContext('2d');
            if (casesCtx) {
                const caseViews = viewData.filter(v => v.item_type === 'case_created' || v.item_type === 'case_viewed').reduce((acc, view) => {
                    acc[view.item_id] = (acc[view.item_id] || 0) + 1;
                    return acc;
                }, {});
                casesChartInstance = new Chart(casesCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(caseViews),
                        datasets: [{ data: Object.values(caseViews), backgroundColor: ['#4f46e5', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6'] }]
                    },
                    options: chartOptions('pie')
                });
            }

            recentUpdatesList.innerHTML = viewData
                .sort((a,b) => new Date(b.viewed_at) - new Date(a.viewed_at))
                .slice(0, 10)
                .map(v => {
                    let iconClass = 'fas fa-eye text-indigo-400';
                    let actionText = 'viewed';
                    let itemStrong = `<strong class="font-medium">${escapeHTML(v.item_id)}</strong>`;

                    if (v.item_type === 'case_created') {
                        iconClass = 'fas fa-plus-circle text-indigo-500';
                        actionText = 'created case';
                    } else if (v.item_type === 'navigation') {
                        iconClass = 'fas fa-route text-indigo-500';
                        actionText = 'navigated to';
                    } else if (v.item_type === 'item_added') {
                        iconClass = 'fas fa-file-medical text-indigo-500';
                        actionText = 'added item';
                    } else if (v.item_type === 'article_view') {
                        iconClass = 'fas fa-file-alt text-indigo-500';
                        actionText = 'viewed article';
                    }

                    return `
                        <li class="py-2 px-1 border-b border-indigo-200 dark:border-indigo-700 last:border-b-0">
                            <div class="flex items-center space-x-3">
                                <i class="${iconClass} text-base dark:text-indigo-500"></i>
                                <div class="flex-1">
                                    <span class="text-indigo-800 dark:text-indigo-200">
                                        <strong class="font-medium">${escapeHTML(v.user_identifier)}</strong> ${actionText} ${itemStrong}
                                    </span>
                                    <span class="text-xs text-indigo-500 dark:text-indigo-400 block">${new Date(v.viewed_at).toLocaleString()}</span>
                                </div>
                            </div>
                        </li>`;
                }).join('');
        }

        // Filters
        const filterUserSelect = document.getElementById('filterUser');
        async function populateUserFilter() {
            const { data, error } = await supabase.rpc('get_distinct_viewers');
            if (error) {
                console.error('Error fetching distinct viewers:', error);
                return;
            }
            if (data && filterUserSelect) {
                filterUserSelect.innerHTML = '<option value="">All Users</option>';
                data.forEach(u => filterUserSelect.add(new Option(u.user_identifier, u.user_identifier)));
            }
        }
        document.getElementById('applyFilterBtn').addEventListener('click', async () => {
            const date = document.getElementById('filterDate').value;
            const user = filterUserSelect.value;
            const interaction = document.getElementById('filterInteraction').value;
            let query = supabase.from(TABLES.VIEWS_LOG).select('*');
            if (date) query = query.gte('viewed_at', `${date}T00:00:00Z`).lte('viewed_at', `${date}T23:59:59Z`);
            if (user) query = query.eq('user_identifier', user);
            if (interaction) query = query.eq('item_type', interaction);
            const { data: filteredData, error } = await query;
            if (error) console.error('Error fetching filtered data:', error);
            else initCharts(filteredData || []);
        });

        // Helper Functions
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;' }[m]));
        }
        function highlightText(text, query) {
            if (!text) return '';
            const safeText = escapeHTML(text);
            if (!query) return safeText;
            try {
                const rgx = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                return safeText.replace(rgx, '<mark>$1</mark>');
            } catch (e) {
                return safeText;
            }
        }
        function truncateText(text, len) {
            if (!text || text.length <= len) return text;
            return text.substring(0, len) + '...';
        }
        function stripHtml(html) {
            const tmp = document.createElement('DIV');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }
        function getThemeColors(themeColor = 'indigo') {
            const colorMap = {
                indigo: { 
                    bg: 'bg-indigo-100 dark:bg-indigo-900', 
                    text: 'text-indigo-600 dark:text-indigo-400', 
                    iconContainer: 'bg-indigo-100 dark:bg-indigo-800/50', 
                    icon: 'text-indigo-500 dark:text-indigo-400', 
                    cta: 'text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300', 
                    border: 'border-indigo-500', 
                    tagBg: 'bg-indigo-100 dark:bg-indigo-500/20', 
                    tagText: 'text-indigo-700 dark:text-indigo-300', 
                    statusBg: 'bg-indigo-100 dark:bg-indigo-500/20', 
                    statusText: 'text-indigo-700 dark:text-indigo-400' 
                }
            };
            return colorMap[themeColor.toLowerCase()] || colorMap.indigo;
        }

        // Card Rendering
        function renderArticleCard(article, sectionData) {
            const theme = getThemeColors(sectionData.themeColor);
            const cardIconClass = sectionData.icon || 'fas fa-file-alt';
            return `
            <div class="card border-t-4 ${theme.border}" data-item-id="${article.id}" data-item-type="article">
                <div class="flex items-center mb-3">
                    <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="${cardIconClass} text-xl ${theme.icon}"></i></div>
                    <h3 class="font-semibold text-lg leading-tight">${escapeHTML(article.title)}</h3>
                </div>
                <p class="text-sm mb-4 flex-grow text-indigo-600 dark:text-indigo-400">${escapeHTML(article.summary) || 'No summary.'}</p>
                ${article.tags && article.tags.length ? `<div class="mb-4">${article.tags.map(tag => `<span class="text-xs ${theme.tagBg} ${theme.tagText} px-2 py-1 rounded-full mr-1 mb-1 font-medium">${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                <div class="mt-auto flex justify-between items-center pt-3 border-t border-indigo-200 dark:border-indigo-700">
                    <div></div>
                    <a href="${escapeHTML(article.contentPath || '#')}" target="_blank" class="text-sm font-medium ${theme.cta}">Read More <i class="fas fa-arrow-right ml-1 text-xs"></i></a>
                </div>
            </div>`;
        }
        function renderCaseCard(caseItem, sectionData) {
            const theme = getThemeColors(sectionData.themeColor);
            return `
            <div class="card border-t-4 ${theme.border}" data-item-id="${caseItem.id}" data-item-type="case">
                <div class="flex items-center mb-3">
                    <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="fas fa-briefcase text-xl ${theme.icon}"></i></div>
                    <h3 class="font-semibold text-lg leading-tight">${escapeHTML(caseItem.title)}</h3>
                </div>
                <p class="text-sm mb-2 flex-grow text-indigo-600 dark:text-indigo-400">${escapeHTML(caseItem.summary) || 'No summary.'}</p>
                ${caseItem.resolution_steps ? `<p class="text-xs italic mb-3 text-indigo-500 dark:text-indigo-500">${escapeHTML(truncateText(stripHtml(caseItem.resolution_steps), 100))}</p>` : ''}
                <div class="mt-auto flex justify-between items-center pt-3 border-t border-indigo-200 dark:border-indigo-700">
                    <span class="text-sm font-medium px-3 py-1 rounded-full ${theme.statusBg} ${theme.statusText}">${escapeHTML(caseItem.status)}</span>
                    <a href="#${sectionData.id}/${caseItem.id}" class="text-sm font-medium ${theme.cta}">Details <i class="fas fa-arrow-right ml-1 text-xs"></i></a>
                </div>
            </div>`;
        }
        function renderItemCard(item, sectionData) {
            const theme = getThemeColors(sectionData.themeColor);
            return `
            <div class="card border-t-4 ${theme.border}" data-item-id="${item.id}" data-item-type="item">
                <div class="flex items-center mb-3">
                    <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="${sectionData.icon || 'fas fa-archive'} text-xl ${theme.icon}"></i></div>
                    <h3 class="font-semibold text-lg leading-tight">${escapeHTML(item.title)}</h3>
                </div>
                <p class="text-sm mb-4 flex-grow text-indigo-600 dark:text-indigo-400">${escapeHTML(item.summary) || 'No description.'}</p>
                <div class="mt-auto flex justify-between items-center pt-3 border-t border-indigo-200 dark:border-indigo-700">
                    <span class="text-xs ${theme.tagBg} ${theme.tagText} px-3 py-1 rounded-full uppercase font-semibold">${escapeHTML(item.type)}</span>
                    <a href="${escapeHTML(item.url)}" target="_blank" class="text-sm font-medium ${theme.cta}">Open <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>
                </div>
            </div>`;
        }

        // Role-Based Permissions
        function checkUserRoleAccess(sectionId) {
            const user = Auth.getCurrentUser();
            const section = kbSystemData.sections.find(s => s.id === sectionId);
            if (!section) return true;
            if (user.role === 'super_admin') return true;
            if (user.role === 'admin' && !['logistics_admin'].includes(sectionId)) return true;
            if (user.role === 'viewer' && ['support', 'partner_care', 'customer_care'].includes(sectionId)) return true;
            if (sectionId === 'home') return true;
            return false;
        }

        // View Logging
        async function logUserView(itemId, itemType) {
            const user = Auth.getCurrentUser();
            const logEntry = {
                item_id: itemId.toString(),
                item_type: itemType,
                user_identifier: user.email,
                viewed_at: new Date().toISOString()
            };
            const { error } = await supabase.from(TABLES.VIEWS_LOG).insert([logEntry]);
            if (error) console.error('Error logging view:', error);
        }

        // Content Display
        async function displaySectionContent(sectionId, itemIdToFocus = null, subCategoryFilter = null) {
            console.log(`Navigating to section: ${sectionId}, item: ${itemIdToFocus}, subCategory: ${subCategoryFilter}`);
            if (!checkUserRoleAccess(sectionId)) {
                standardSectionContentPlaceholder.innerHTML = `<div class="p-6 text-center"><h2 class="text-xl font-semibold text-red-500">Access Denied</h2><p>You do not have permission to view this section.</p></div>`;
                dashboardOverviewContainer.classList.add('hidden');
                standardSectionContentPlaceholder.classList.remove('hidden');
                currentSectionTitleEl.textContent = 'Access Denied';
                breadcrumbsContainer.innerHTML = `<span class="font-medium">Access Denied</span>`;
                return;
            }

            dashboardOverviewContainer.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden');
            standardSectionContentPlaceholder.innerHTML = '';

            if (sectionId === 'home') {
                dashboardOverviewContainer.classList.remove('hidden');
                standardSectionContentPlaceholder.classList.add('hidden');
                currentSectionTitleEl.textContent = 'Dashboard Overview';
                breadcrumbsContainer.innerHTML = `<span class="font-medium">Home</span>`;
                const { data: viewData } = await supabase.from(TABLES.VIEWS_LOG).select('*');
                initCharts(viewData || []);
                populateUserFilter();
                logUserView('home', 'navigation');
                return;
            }

            const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
            if (!sectionData) {
                standardSectionContentPlaceholder.innerHTML = `<div class="p-6 text-center"><h2 class="text-xl font-semibold">Section Not Found: ${escapeHTML(sectionId)}</h2></div>`;
                currentSectionTitleEl.textContent = 'Not Found';
                breadcrumbsContainer.innerHTML = `<span class="font-medium">Not Found</span>`;
                return;
            }

            currentSectionTitleEl.textContent = sectionData.name;
            let bcHTML = `<a href="#home" class="hover:underline">Home</a> <span class="mx-1">></span> <span class="font-medium">${escapeHTML(sectionData.name)}</span>`;
            if (subCategoryFilter) {
                const subCatName = sectionData.subCategories?.find(sc => sc.id === subCategoryFilter)?.name || subCategoryFilter;
                bcHTML = `<a href="#home" class="hover:underline">Home</a> <span class="mx-1">></span> <a href="#${sectionData.id}" class="hover:underline">${escapeHTML(sectionData.name)}</a> <span class="mx-1">></span> <span class="font-medium">${escapeHTML(subCatName)}</span>`;
            }
            if (itemIdToFocus) {
                const item = (sectionData.cases || []).find(c => c.id === itemIdToFocus) || 
                             (sectionData.articles || []).find(a => a.id === itemIdToFocus) || 
                             (sectionData.items || []).find(i => i.id === itemIdToFocus);
                if (item) {
                    bcHTML += ` <span class="mx-1">></span> <span class="font-medium">${escapeHTML(item.title)}</span>`;
                }
            }
            breadcrumbsContainer.innerHTML = bcHTML;

            let contentHTML = `<div class="space-y-8">`;
            const theme = getThemeColors(sectionData.themeColor);

            if (['admin', 'super_admin'].includes(currentUser.role)) {
                contentHTML += `
                <div class="flex justify-end">
                    <button onclick="openAddContentModal('${sectionData.id}')" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Add Content
                    </button>
                </div>`;
            }

            const articles = (sectionData.articles || []).filter(a => !subCategoryFilter || a.tags?.includes(subCategoryFilter));
            const cases = (sectionData.cases || []).filter(c => !subCategoryFilter || c.tags?.includes(subCategoryFilter));
            const items = (sectionData.items || []).filter(i => !subCategoryFilter || i.type === subCategoryFilter);

            if (itemIdToFocus) {
                const caseItem = cases.find(c => c.id === itemIdToFocus);
                if (caseItem) {
                    contentHTML += `
                    <div class="card border-t-4 ${theme.border}">
                        <h2 class="text-2xl font-semibold mb-4">${escapeHTML(caseItem.title)}</h2>
                        <p class="text-sm mb-4 text-indigo-600 dark:text-indigo-400">${escapeHTML(caseItem.summary)}</p>
                        <div class="mb-4">
                            <span class="text-sm font-medium px-3 py-1 rounded-full ${theme.statusBg} ${theme.statusText}">${escapeHTML(caseItem.status)}</span>
                        </div>
                        ${caseItem.resolution_steps ? `<div class="prose dark:prose-invert mb-4">${caseItem.resolution_steps}</div>` : ''}
                        ${caseItem.tags && caseItem.tags.length ? `<div class="mb-4">${caseItem.tags.map(tag => `<span class="text-xs ${theme.tagBg} ${theme.tagText} px-2 py-1 rounded-full mr-1 mb-1 font-medium">${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                        <a href="#${sectionData.id}" class="text-sm font-medium ${theme.cta}">Back to ${escapeHTML(sectionData.name)}</a>
                    </div>`;
                    logUserView(caseItem.id, 'case_viewed');
                } else {
                    contentHTML += `<div class="p-6 text-center"><h2 class="text-xl font-semibold">Item Not Found: ${escapeHTML(itemIdToFocus)}</h2></div>`;
                }
            } else {
                if (articles.length) {
                    contentHTML += `<h3 class="text-2xl font-semibold mb-4 border-b pb-2 border-indigo-300 dark:border-indigo-700">Articles</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-x-10 gap-y-8">`;
                    articles.forEach(article => contentHTML += renderArticleCard(article, sectionData));
                    contentHTML += `</div>`;
                }
                if (cases.length) {
                    contentHTML += `<h3 class="text-2xl font-semibold mt-8 mb-4 border-b pb-2 border-indigo-300 dark:border-indigo-700">Cases</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-x-10 gap-y-8">`;
                    cases.forEach(caseItem => contentHTML += renderCaseCard(caseItem, sectionData));
                    contentHTML += `</div>`;
                }
                if (items.length) {
                    contentHTML += `<h3 class="text-2xl font-semibold mt-8 mb-4 border-b pb-2 border-indigo-300 dark:border-indigo-700">Resources</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-x-10 gap-y-8">`;
                    items.forEach(item => contentHTML += renderItemCard(item, sectionData));
                    contentHTML += `</div>`;
                }
                if (!subCategoryFilter && sectionData.subCategories && sectionData.subCategories.length > 0) {
                    contentHTML += `<h3 class="text-2xl font-semibold mt-8 mb-4 border-b pb-2 border-indigo-300 dark:border-indigo-700">Subcategories</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-x-10 gap-y-8">`;
                    sectionData.subCategories.forEach(subCat => {
                        contentHTML += `
                        <div class="card border-t-4 ${theme.border}">
                            <div class="flex items-center mb-3">
                                <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="${sectionData.icon || 'fas fa-folder'} text-xl ${theme.icon}"></i></div>
                                <h3 class="font-semibold text-lg leading-tight">${escapeHTML(subCat.name)}</h3>
                            </div>
                            <p class="text-sm mb-4 flex-grow text-indigo-600 dark:text-indigo-400">${escapeHTML(subCat.description || 'No description available.')}</p>
                            <div class="mt-auto flex justify-end pt-3 border-t border-indigo-200 dark:border-indigo-700">
                                <a href="#${sectionData.id}/${subCat.id}" class="text-sm font-medium ${theme.cta}">Explore <i class="fas fa-arrow-right ml-1 text-xs"></i></a>
                            </div>
                        </div>`;
                    });
                    contentHTML += `</div>`;
                }
                if (sectionData.glossary && sectionData.glossary.length && !subCategoryFilter && !itemIdToFocus) {
                    contentHTML += `<h3 class="text-2xl font-semibold mt-8 mb-4 border-b pb-2 border-indigo-300 dark:border-indigo-700">Glossary</h3><div class="space-y-4">`;
                    sectionData.glossary.forEach(term => {
                        contentHTML += `
                        <div class="card">
                            <h4 class="font-semibold text-lg mb-2">${escapeHTML(term.term)}</h4>
                            <p class="text-sm text-indigo-600 dark:text-indigo-400">${escapeHTML(term.definition)}</p>
                        </div>`;
                    });
                    contentHTML += `</div>`;
                }
                if (!articles.length && !cases.length && !items.length && (!sectionData.subCategories || !sectionData.subCategories.length) && !itemIdToFocus && !subCategoryFilter) {
                    contentHTML += `<div class="text-center py-8"><p class="text-lg text-indigo-500 dark:text-indigo-400">No content available for this section.</p></div>`;
                }
            }

            contentHTML += `</div>`;
            standardSectionContentPlaceholder.innerHTML = contentHTML;
            logUserView(sectionId, 'navigation');
        }

            // Search Functionality
        const globalSearchInput = document.getElementById('globalSearchInput');
        const searchResultsContainer = document.getElementById('searchResultsContainer');

        function performSearch(query) {
            if (!query || query.length < 2) {
                searchResultsContainer.classList.add('hidden');
                searchResultsContainer.innerHTML = '';
                return;
            }

            const results = [];
            kbSystemData.sections.forEach(section => {
                if (!checkUserRoleAccess(section.id)) return;

                (section.articles || []).forEach(article => {
                    if (article.title.toLowerCase().includes(query.toLowerCase()) || 
                        article.summary?.toLowerCase().includes(query.toLowerCase()) ||
                        article.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase()))) {
                        results.push({ type: 'article', section, item: article });
                    }
                });

                (section.cases || []).forEach(caseItem => {
                    if (caseItem.title.toLowerCase().includes(query.toLowerCase()) || 
                        caseItem.summary?.toLowerCase().includes(query.toLowerCase()) ||
                        stripHtml(caseItem.resolution_steps || '').toLowerCase().includes(query.toLowerCase()) ||
                        caseItem.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase()))) {
                        results.push({ type: 'case', section, item: caseItem });
                    }
                });

                (section.items || []).forEach(item => {
                    if (item.title.toLowerCase().includes(query.toLowerCase()) || 
                        item.summary?.toLowerCase().includes(query.toLowerCase()) ||
                        item.type.toLowerCase().includes(query.toLowerCase())) {
                        results.push({ type: 'item', section, item });
                    }
                });

                (section.glossary || []).forEach(term => {
                    if (term.term.toLowerCase().includes(query.toLowerCase()) || 
                        term.definition.toLowerCase().includes(query.toLowerCase())) {
                        results.push({ type: 'glossary', section, item: term });
                    }
                });
            });

            searchResultsContainer.innerHTML = results.length ? 
                results.slice(0, 10).map(result => {
                    const theme = getThemeColors(result.section.themeColor);
                    const iconClass = result.type === 'article' ? 'fa-file-alt' :
                                    result.type === 'case' ? 'fa-briefcase' :
                                    result.type === 'item' ? 'fa-archive' : 'fa-book';
                    const href = result.type === 'article' ? result.item.contentPath || `#${result.section.id}` :
                                result.type === 'case' ? `#${result.section.id}/${result.item.id}` :
                                result.type === 'item' ? result.item.url || `#${result.section.id}` :
                                `#${result.section.id}`;
                    return `
                        <a href="${href}" class="block px-4 py-3 hover:bg-indigo-100 dark:hover:bg-indigo-700/50 border-b border-indigo-200 dark:border-indigo-700 last:border-b-0">
                            <div class="flex items-center">
                                <i class="fas ${iconClass} ${theme.icon} mr-3"></i>
                                <div>
                                    <div class="text-sm font-medium text-indigo-700 dark:text-indigo-300">${highlightText(result.item.title || result.item.term, query)}</div>
                                    <div class="text-xs text-indigo-500 dark:text-indigo-400">${highlightText(truncateText(result.item.summary || result.item.definition || stripHtml(result.item.resolution_steps) || result.section.name, 50), query)}</div>
                                    <div class="text-xs text-indigo-400 dark:text-indigo-500">${escapeHTML(result.section.name)} > ${escapeHTML(result.type)}</div>
                                </div>
                            </div>
                        </a>`;
                }).join('') :
                `<div class="px-4 py-3 text-sm text-indigo-600 dark:text-indigo-400">No results found for "${escapeHTML(query)}".</div>`;

            searchResultsContainer.classList.remove('hidden');
        }

        globalSearchInput.addEventListener('input', debounce(e => {
            performSearch(e.target.value.trim());
        }, 300));

        globalSearchInput.addEventListener('focus', () => {
            if (globalSearchInput.value.trim()) performSearch(globalSearchInput.value.trim());
        });

        globalSearchInput.addEventListener('blur', () => {
            setTimeout(() => searchResultsContainer.classList.add('hidden'), 200);
        });

        // Navigation Handling
        function handleNavigation() {
            const hash = window.location.hash.slice(1);
            const [sectionId, subCategoryOrItemId] = hash.split('/');
            currentSectionId = sectionId || 'home';

            sidebar.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.toggle('active', link.getAttribute('data-section') === currentSectionId);
            });

            if (subCategoryOrItemId) {
                const section = kbSystemData.sections.find(s => s.id === sectionId);
                const isSubCategory = section?.subCategories?.some(sc => sc.id === subCategoryOrItemId);
                displaySectionContent(sectionId, isSubCategory ? null : subCategoryOrItemId, isSubCategory ? subCategoryOrItemId : null);
            } else {
                displaySectionContent(currentSectionId);
            }
        }

        window.addEventListener('hashchange', handleNavigation);
        window.addEventListener('load', handleNavigation);

        // Debounce Utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Logout Modal Handlers
        const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
        const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');

        confirmLogoutBtn.addEventListener('click', confirmLogout);
        cancelLogoutBtn.addEventListener('click', () => {
            logoutConfirmModal.classList.add('hidden');
        });

        // Click Outside to Close Modals
        addContentModalOverlay.addEventListener('click', e => {
            if (e.target === addContentModalOverlay) closeAddContentModal();
        });

        logoutConfirmModal.addEventListener('click', e => {
            if (e.target === logoutConfirmModal) logoutConfirmModal.classList.add('hidden');
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', e => {
            if (e.key === '/' && document.activeElement !== globalSearchInput) {
                e.preventDefault();
                globalSearchInput.focus();
            }
            if (e.key === 'Escape') {
                closeAddContentModal();
                logoutConfirmModal.classList.add('hidden');
                searchResultsContainer.classList.add('hidden');
            }
        });

        // Dynamic Content Loading for Infinite Scroll
        let isLoadingMore = false;
        pageContentArea.addEventListener('scroll', async () => {
            if (isLoadingMore || currentSectionId === 'home') return;
            const { scrollTop, scrollHeight, clientHeight } = pageContentArea;
            if (scrollTop + clientHeight >= scrollHeight - 100) {
                isLoadingMore = true;
                const section = kbSystemData.sections.find(s => s.id === currentSectionId);
                if (section) {
                    const currentItems = standardSectionContentPlaceholder.querySelectorAll('.card').length;
                    const moreItems = (section.cases || []).slice(currentItems, currentItems + 10).map(item => renderCaseCard(item, section))
                        .concat((section.articles || []).slice(currentItems, currentItems + 10).map(item => renderArticleCard(item, section)))
                        .concat((section.items || []).slice(currentItems, currentItems + 10).map(item => renderItemCard(item, section)));
                    if (moreItems.length) {
                        const container = document.createElement('div');
                        container.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-x-10 gap-y-8 mt-8';
                        container.innerHTML = moreItems.join('');
                        standardSectionContentPlaceholder.appendChild(container);
                    }
                }
                isLoadingMore = false;
            }
        });

        // Initialize
        handleNavigation();
        populateUserFilter();
    </script>
</body>
</html>
