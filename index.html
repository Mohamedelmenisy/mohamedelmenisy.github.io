<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Knowledge Base</title>
    <link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/919/919820.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark body { background-color: #111827; color: #d1d5db; }
        body:not(.dark) { background-color: #f3f4f6; color: #1f2937; }

        .sidebar {
            width: 260px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            padding: 1.5rem;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            z-index: 40;
        }
        .dark .sidebar { background-color: #1f2937; color: #9ca3af; border-right: 1px solid #374151; }
        body:not(.dark) .sidebar { background-color: #ffffff; color: #4b5563; border-right: 1px solid #e5e7eb; }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500;
        }
        .dark .sidebar-link { color: #9ca3af; }
        body:not(.dark) .sidebar-link { color: #4b5563; }

        .sidebar-link.active {
            font-weight: 600;
            background-color: #2563eb;
            color: #ffffff;
        }

        .content-wrapper {
            margin-left: 260px;
            height: 100vh;
            overflow-y: auto;
            transition: margin-left 0.3s ease-in-out;
        }

        .card {
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .content-wrapper { margin-left: 0; }
        }

        /* Accessibility improvements */
        button:focus, [tabindex="0"]:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .dark button:focus, .dark [tabindex="0"]:focus {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.6);
        }
    </style>
</head>
<body>
    <!-- Add New Content Modal -->
    <div id="addContentModalOverlay" class="modal-overlay hidden" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="addContentModalTitle">
            <div class="flex justify-between items-center mb-6">
                <h2 id="addContentModalTitle" class="text-2xl font-bold">Add New Content</h2>
                <button id="closeAddContentModalBtn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700" aria-label="Close modal">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="addContentForm">
                <div class="mb-4">
                    <label for="contentType" class="block text-sm font-medium mb-1">Content Type</label>
                    <select id="contentType" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                        <option value="case">Case</option>
                        <option value="sheet">Sheet</option>
                        <option value="form">Form</option>
                        <option value="video">Video</option>
                        <option value="design">Design</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="contentTitle" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="contentTitle" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="contentSummary" class="block text-sm font-medium mb-1">Summary</label>
                    <textarea id="contentSummary" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" rows="3" required></textarea>
                </div>
                <div class="mb-4 hidden" id="contentUrlContainer">
                    <label for="contentUrl" class="block text-sm font-medium mb-1">URL (for Sheet/Form/Video/Design)</label>
                    <input type="url" id="contentUrl" class="p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                </div>
                <div class="mb-6 hidden" id="resolutionStepsContainer">
                    <label class="block text-sm font-medium mb-1">Resolution Steps (for Case)</label>
                    <div id="quillEditor" class="quill-editor-container"></div>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" id="cancelAddContentBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                    <button type="submit" id="saveContentBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar" aria-label="Main navigation">
            <div class="sidebar-header">
                <i class="fas fa-database mr-3 text-indigo-400" aria-hidden="true"></i> InfiniBase
            </div>
            <nav id="navigationMenu">
                <div class="sidebar-section-title">Main</div>
                <a href="#home" class="sidebar-link" data-section="home" aria-current="page">
                    <i class="fas fa-home text-gray-400" aria-hidden="true"></i>Home
                </a>

                <div class="sidebar-section-title">Knowledge Areas</div>
                <a href="#support" class="sidebar-link" data-section="support">
                    <i class="fas fa-headset text-blue-400" aria-hidden="true"></i>Support
                </a>
                <a href="#partner_care" class="sidebar-link" data-section="partner_care">
                    <i class="fas fa-handshake text-teal-400" aria-hidden="true"></i>Partner Care
                </a>
                <a href="#logistics" class="sidebar-link" data-section="logistics">
                    <i class="fas fa-truck text-green-400" aria-hidden="true"></i>Logistics
                </a>
                <a href="#customer_care" class="sidebar-link" data-section="customer_care">
                    <i class="fas fa-users text-indigo-400" aria-hidden="true"></i>Customer Care
                </a>
                <a href="#dist_follow_up" class="sidebar-link" data-section="dist_follow_up">
                    <i class="fas fa-people-carry text-cyan-400" aria-hidden="true"></i>Distribution & Follow-up
                </a>
                <a href="#logistics_driver" class="sidebar-link" data-section="logistics_driver">
                    <i class="fas fa-shipping-fast text-lime-400" aria-hidden="true"></i>Logistics (Driver Complaints)
                </a>
                <a href="#logistics_3pl" class="sidebar-link" data-section="logistics_3pl">
                    <i class="fas fa-boxes text-yellow-400" aria-hidden="true"></i>Logistics-3PL
                </a>
                <a href="#order_at_store" class="sidebar-link" data-section="order_at_store">
                    <i class="fas fa-store text-pink-400" aria-hidden="true"></i>Order at Store (Mac)
                </a>
                <a href="#logistics_admin" class="sidebar-link" data-section="logistics_admin">
                    <i class="fas fa-user-shield text-red-400" aria-hidden="true"></i>Logistics-Admin
                </a>
                <a href="#os" class="sidebar-link" data-section="os">
                    <i class="fab fa-windows text-sky-400" aria-hidden="true"></i>Operating Systems
                </a>

                <div class="sidebar-section-title">Resources & Policies</div>
                <a href="#compensation" class="sidebar-link" data-section="compensation">
                    <i class="fas fa-hand-holding-usd text-amber-400" aria-hidden="true"></i>Compensation Policies
                </a>
                <a href="#op_instructions" class="sidebar-link" data-section="op_instructions">
                    <i class="fas fa-clipboard-list text-slate-400" aria-hidden="true"></i>Operational Instructions
                </a>
                <a href="#forms_templates" class="sidebar-link" data-section="forms_templates">
                    <i class="fas fa-file-alt text-purple-400" aria-hidden="true"></i>Forms/Templates
                </a>
            </nav>
            <div class="absolute bottom-6 left-0 right-0 px-6">
                <button id="themeSwitcher" class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition shadow-sm border border-gray-600 hover:bg-gray-700">
                    <i id="themeIcon" class="fas fa-moon mr-2" aria-hidden="true"></i> <span id="themeText">Dark Mode</span>
                </button>
                <button id="logoutButton" class="w-full mt-3 flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition shadow-sm bg-red-600 hover:bg-red-700 text-white">
                    <i class="fas fa-sign-out-alt mr-2" aria-hidden="true"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Mobile Sidebar Toggle -->
        <button id="mobileSidebarToggle" class="sidebar-toggle-button p-2 rounded-md bg-gray-700 text-white md:hidden fixed top-4 left-4 z-50" aria-label="Toggle sidebar" aria-expanded="false">
            <i class="fas fa-bars text-xl" aria-hidden="true"></i>
        </button>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="flex justify-between items-center w-full">
                    <div>
                        <h1 id="currentSectionTitle" class="text-2xl md:text-3xl font-bold">Welcome</h1>
                        <div id="breadcrumbs" class="text-sm mt-1 text-gray-500 dark:text-gray-400">Home</div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="search" id="globalSearchInput" placeholder="Search KB..." class="py-2.5 pl-10 pr-4 w-64 md:w-96 border rounded-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" aria-label="Search knowledge base">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400" aria-hidden="true"></i></span>
                            <div id="searchResultsContainer" class="hidden absolute mt-1 w-full max-h-80 overflow-y-auto rounded-md shadow-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 z-10" role="listbox"></div>
                        </div>
                        <div id="userProfileContainer" class="flex items-center space-x-2">
                            <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=4f46e5&color=fff&rounded=true" alt="User profile" class="w-9 h-9 rounded-full">
                            <span id="userNameDisplayHeader" class="font-medium hidden sm:block">User</span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="p-6 md:p-8" id="pageContentArea">
                <!-- Content will be dynamically inserted here -->
            </main>

            <footer class="mt-auto p-6 text-center text-sm text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">
                <span>Â© <span id="currentYear"></span> InfiniBase. v<span id="footerKbVersion"></span></span>
                <button id="reportErrorBtn" class="ml-4 text-xs text-red-500 hover:underline">Report an Issue</button>
            </footer>
        </div>
    </div>

    <script type="module">
        // Enhanced Supabase Simulation
        const supabase = {
            from: (table) => ({
                select: async (columns = '*') => {
                    console.log(`Simulated Supabase: SELECT ${columns} FROM ${table}`);
                    if (table === 'views_log') {
                        return { 
                            data: [
                                { id: 1, item_id: 'case001', item_type: 'case_created', user_identifier: 'user1@sim.com', viewed_at: '2025-05-25T10:00:00Z' },
                                { id: 2, item_id: 'sup001', item_type: 'article_view', user_identifier: 'user2@sim.com', viewed_at: '2025-05-25T11:00:00Z' },
                                { id: 3, item_id: 'log001', item_type: 'navigation', user_identifier: 'test@sim.com', viewed_at: '2025-05-25T12:00:00Z' }
                            ], 
                            error: null 
                        };
                    }
                    if (table === 'cases') return { 
                        data: [
                            { id: 'case001', title: 'User Alpha Disconnects', summary: 'Frequent disconnects', status: 'Pending', resolution_steps: '<p>1. Check network</p><p>2. Restart router</p>' },
                            { id: 'case002', title: 'Login Failure', summary: 'Users unable to login', status: 'Resolved', resolution_steps: '<p>1. Reset password</p><p>2. Clear cache</p>' }
                        ], 
                        error: null 
                    };
                    return { data: [], error: null };
                },
                insert: async (records) => {
                    console.log(`Simulated Supabase: INSERT INTO ${table}`, records);
                    const newId = Math.floor(Math.random() * 10000);
                    return { data: [{ id: newId, ...records[0] }], error: null };
                },
                rpc: async (fnName, params) => {
                    if (fnName === 'get_distinct_viewers') {
                        return { 
                            data: [
                                { user_identifier: 'user1@sim.com' },
                                { user_identifier: 'user2@sim.com' },
                                { user_identifier: 'test@sim.com' }
                            ], 
                            error: null 
                        };
                    }
                    if (fnName === 'search_kb') {
                        const query = params?.query?.toLowerCase();
                        if (!query) return { data: [], error: null };
                        
                        // Simulate search across all content
                        const allContent = [];
                        kbSystemData.sections.forEach(s => {
                            s.articles?.forEach(a => allContent.push({ ...a, type: 'article', section: s }));
                            s.cases?.forEach(c => allContent.push({ ...c, type: 'case', section: s }));
                            s.items?.forEach(i => allContent.push({ ...i, type: 'item', section: s }));
                        });
                        
                        const results = allContent.filter(item => 
                            item.title.toLowerCase().includes(query) || 
                            item.summary?.toLowerCase().includes(query)
                        );
                        
                        return { data: results.slice(0, 10), error: null };
                    }
                    return { data: null, error: { message: "RPC not implemented" } };
                }
            })
        };

        // Enhanced Auth Simulation
        const Auth = {
            isAuthenticated: () => true,
            getCurrentUser: () => ({ 
                email: 'testuser@example.com', 
                fullName: 'Test User', 
                role: 'admin',
                avatar: 'https://ui-avatars.com/api/?name=Test+User&size=36&background=4f46e5&color=fff&rounded=true'
            }),
            logout: () => { 
                console.log('User logged out');
                window.location.href = '/login.html'; 
            },
            protectPage: () => { 
                if (!Auth.isAuthenticated()) { 
                    console.warn('Unauthorized access attempt');
                    window.location.href = '/login.html'; 
                }
            }
        };

        // Enhanced KB Data
        const kbSystemData = {
            meta: { 
                version: '1.0.0', 
                lastGlobalUpdate: new Date().toISOString(),
                features: ['search', 'analytics', 'content_management']
            },
            sections: [
                { 
                    id: 'support', 
                    name: 'Support', 
                    icon: 'fas fa-headset', 
                    themeColor: 'blue', 
                    description: 'Technical support resources and troubleshooting guides',
                    articles: [
                        { 
                            id: 'sup001', 
                            title: 'High Priority Ticket Handling', 
                            summary: 'Process for handling P1 critical tickets', 
                            tags: ['p1', 'urgent'], 
                            content: '<p>P1 tickets require immediate attention...</p>',
                            created_at: '2025-05-20T09:00:00Z'
                        }
                    ],
                    cases: [
                        { 
                            id: 'case001', 
                            title: 'User Connection Issues', 
                            summary: 'Users experiencing frequent disconnects', 
                            status: 'Pending', 
                            tags: ['network', 'connectivity'],
                            resolution_steps: '<p>1. Check network stability</p><p>2. Verify server load</p>',
                            created_at: '2025-05-18T14:30:00Z'
                        }
                    ],
                    subCategories: [
                        { id: 'tools', name: 'Support Tools' },
                        { id: 'processes', name: 'Support Processes' }
                    ]
                },
                // Other sections remain similar but with enhanced data
            ]
        };

        // Main Application Class
        class InfiniBaseApp {
            constructor() {
                this.contentEditorQuill = null;
                this.usersChartInstance = null;
                this.casesChartInstance = null;
                this.TABLES = { CASES: 'cases', VIEWS_LOG: 'views_log' };
                this.currentSectionId = 'home';
                this.searchDebounceTimer = null;
                this.currentUser = null;
                
                this.init();
            }
            
            async init() {
                Auth.protectPage();
                this.currentUser = Auth.getCurrentUser();
                
                // Set current year in footer
                document.getElementById('currentYear').textContent = new Date().getFullYear();
                
                // Initialize UI components
                this.initUserProfile();
                this.initThemeSwitcher();
                this.initMobileSidebar();
                this.initModals();
                this.initSearch();
                this.initNavigation();
                
                // Load initial content
                await this.handleNavigation();
                
                console.log('InfiniBase initialized');
            }
            
            initUserProfile() {
                if (this.currentUser) {
                    const displayName = this.currentUser.fullName || this.currentUser.email || 'User';
                    document.getElementById('userNameDisplayHeader').textContent = displayName;
                    document.getElementById('welcomeUserNameDashboard').textContent = `Welcome, ${displayName}!`;
                    document.getElementById('userAvatar').src = this.currentUser.avatar || 
                        `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&size=36&background=4f46e5&color=fff&rounded=true`;
                }
                
                document.getElementById('logoutButton').addEventListener('click', () => Auth.logout());
                document.getElementById('reportErrorBtn').addEventListener('click', this.reportError.bind(this));
            }
            
            initThemeSwitcher() {
                const themeSwitcher = document.getElementById('themeSwitcher');
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                const htmlElement = document.documentElement;
                
                const applyTheme = (theme) => {
                    if (theme === 'dark') {
                        htmlElement.classList.add('dark');
                        themeIcon.classList.replace('fa-moon', 'fa-sun');
                        themeText.textContent = 'Light Mode';
                    } else {
                        htmlElement.classList.remove('dark');
                        themeIcon.classList.replace('fa-sun', 'fa-moon');
                        themeText.textContent = 'Dark Mode';
                    }
                    this.updateChartThemes();
                };
                
                const loadTheme = () => {
                    const savedTheme = localStorage.getItem('theme') || 
                        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                    applyTheme(savedTheme);
                };
                
                themeSwitcher.addEventListener('click', () => {
                    const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
                
                loadTheme();
            }
            
            updateChartThemes() {
                const isDark = document.documentElement.classList.contains('dark');
                const legendColor = isDark ? '#e2e8f0' : '#1a202c';
                const ticksColor = isDark ? '#94a3b8' : '#4a5568';
                const gridColor = isDark ? '#374151' : '#e5e7eb';
                
                [this.usersChartInstance, this.casesChartInstance].forEach(chart => {
                    if (chart) {
                        chart.options.plugins.legend.labels.color = legendColor;
                        if (chart.options.scales) {
                            if (chart.options.scales.y) {
                                chart.options.scales.y.ticks.color = ticksColor;
                                chart.options.scales.y.grid.color = gridColor;
                            }
                            if (chart.options.scales.x) {
                                chart.options.scales.x.ticks.color = ticksColor;
                                chart.options.scales.x.grid.color = gridColor;
                            }
                        }
                        chart.update();
                    }
                });
            }
            
            initMobileSidebar() {
                const sidebar = document.getElementById('sidebar');
                const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
                
                mobileSidebarToggle.addEventListener('click', () => {
                    const isExpanded = sidebar.classList.toggle('open');
                    mobileSidebarToggle.setAttribute('aria-expanded', isExpanded);
                });
                
                // Close sidebar when clicking on links (mobile)
                sidebar.querySelectorAll('.sidebar-link').forEach(link => {
                    link.addEventListener('click', () => {
                        if (window.innerWidth < 768) {
                            sidebar.classList.remove('open');
                            mobileSidebarToggle.setAttribute('aria-expanded', 'false');
                        }
                    });
                });
            }
            
            initModals() {
                // Add Content Modal
                const addContentModalOverlay = document.getElementById('addContentModalOverlay');
                const closeAddContentModalBtn = document.getElementById('closeAddContentModalBtn');
                const addContentForm = document.getElementById('addContentForm');
                const cancelAddContentBtn = document.getElementById('cancelAddContentBtn');
                const contentTypeSelect = document.getElementById('contentType');
                const contentUrlContainer = document.getElementById('contentUrlContainer');
                const resolutionStepsContainer = document.getElementById('resolutionStepsContainer');
                
                // Initialize Quill editor
                if (document.getElementById('quillEditor') {
                    this.contentEditorQuill = new Quill('#quillEditor', {
                        theme: 'snow',
                        modules: { 
                            toolbar: [
                                [{ 'header': [1, 2, false] }],
                                ['bold', 'italic', 'underline'],
                                [{ 'list': 'ordered' }, { 'list': 'bullet' }]
                            ] 
                        },
                        placeholder: 'Enter resolution steps...'
                    });
                }
                
                // Modal event handlers
                contentTypeSelect.addEventListener('change', () => {
                    const type = contentTypeSelect.value;
                    contentUrlContainer.classList.toggle('hidden', type === 'case');
                    resolutionStepsContainer.classList.toggle('hidden', type !== 'case');
                });
                
                closeAddContentModalBtn.addEventListener('click', this.closeAddContentModal.bind(this));
                cancelAddContentBtn.addEventListener('click', this.closeAddContentModal.bind(this));
                addContentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.saveContent();
                });
            }
            
            initSearch() {
                const globalSearchInput = document.getElementById('globalSearchInput');
                const searchResultsContainer = document.getElementById('searchResultsContainer');
                
                globalSearchInput.addEventListener('input', () => {
                    clearTimeout(this.searchDebounceTimer);
                    this.searchDebounceTimer = setTimeout(() => {
                        this.performSearch(globalSearchInput.value.trim());
                    }, 300);
                });
                
                document.addEventListener('click', (e) => {
                    if (!globalSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
                        searchResultsContainer.classList.add('hidden');
                    }
                });
            }
            
            async performSearch(query) {
                const searchResultsContainer = document.getElementById('searchResultsContainer');
                
                if (query.length < 2) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                
                try {
                    const { data: results, error } = await supabase.rpc('search_kb', { query });
                    
                    if (error) throw error;
                    
                    searchResultsContainer.innerHTML = '';
                    
                    if (results && results.length) {
                        results.slice(0, 5).forEach(result => {
                            const item = document.createElement('a');
                            item.href = `#${result.section.id}/${result.id}`;
                            item.className = 'block p-3 hover:bg-gray-100 dark:hover:bg-gray-600';
                            item.innerHTML = `
                                <div class="font-medium">${this.escapeHTML(result.title)} 
                                    <span class="text-xs text-gray-500">(${result.type} in ${result.section.name})</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    ${this.escapeHTML(this.truncateText(result.summary, 50))}
                                </p>
                            `;
                            searchResultsContainer.appendChild(item);
                        });
                        searchResultsContainer.classList.remove('hidden');
                    } else {
                        searchResultsContainer.innerHTML = `
                            <div class="p-3 text-sm text-gray-500">
                                No results found for "${this.escapeHTML(query)}"
                            </div>
                        `;
                        searchResultsContainer.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    searchResultsContainer.innerHTML = `
                        <div class="p-3 text-sm text-red-500">
                            Error performing search. Please try again.
                        </div>
                    `;
                    searchResultsContainer.classList.remove('hidden');
                }
            }
            
            initNavigation() {
                window.addEventListener('hashchange', this.handleNavigation.bind(this));
                
                // Initial navigation handling
                this.handleNavigation();
            }
            
            // ... (rest of the methods remain similar but are now class methods)
            // Include all the other methods from the original code as class methods
            // with appropriate 'this' references updated
            
            // Helper methods
            escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, m => ({ 
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', 
                    '"': '&quot;', "'": '&#39;' 
                }[m]));
            }
            
            truncateText(text, len) {
                if (!text || text.length <= len) return text;
                return text.substring(0, len) + '...';
            }
            
            stripHtml(html) {
                const tmp = document.createElement('DIV');
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || '';
            }
            
            reportError() {
                // Enhanced error reporting
                const errorDetails = {
                    section: this.currentSectionId,
                    user: this.currentUser?.email || 'unknown',
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                };
                
                console.log('Error reported:', errorDetails);
                alert('Thank you for reporting an issue. Our team has been notified.');
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new InfiniBaseApp();
        });
    </script>
</body>
</html>
