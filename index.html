<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark, JS can toggle -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniBase - Dashboard</title>
    <!-- Tailwind CSS (Using the CDN you provided) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        /* Reset and Base Styles - More akin to Tailwind's preflight but simplified */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Theme (Applied by default via html class) */
        .dark body { background-color: #111827; color: #d1d5db; } /* bg-gray-900 text-gray-300 */
        /* Light Theme */
        body:not(.dark) { background-color: #f3f4f6; color: #1f2937; } /* bg-gray-100 text-gray-800 */

        /* Sidebar Styling - Inspired by original Tailwind design */
        .sidebar {
            width: 288px; /* w-72 */
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            padding: 1.5rem; /* p-6 */
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            z-index: 40; /* Higher than content, lower than modal overlay */
        }
        .dark .sidebar { background-color: #000000; color: #9ca3af; border-right: 1px solid #374151;} /* bg-black text-gray-400 border-gray-700 */
        body:not(.dark) .sidebar { background-color: #1f2937; color: #d1d5db; border-right: 1px solid #374151;} /* bg-gray-800 text-gray-300 */

        .sidebar-header {
            font-size: 1.875rem; /* text-3xl */
            font-weight: 700; /* font-bold */
            margin-bottom: 2rem; /* mb-8 */
            padding-bottom: 1rem; /* pb-4 */
            display: flex;
            align-items: center;
        }
        .dark .sidebar-header { color: #ffffff; border-color: #4b5563; } /* text-white border-gray-600 */
        body:not(.dark) .sidebar-header { color: #ffffff; border-color: #4b5563; } /* text-white border-gray-700 */

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 0.75rem; /* py-3 px-3 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s ease, color 0.2s ease;
            font-weight: 500; /* font-medium */
        }
        .dark .sidebar-link { color: #9ca3af; } /* text-gray-400 */
        body:not(.dark) .sidebar-link { color: #d1d5db; } /* text-gray-300 */

        .dark .sidebar-link:hover { background-color: #374151; color: #ffffff; } /* hover:bg-gray-700 hover:text-white */
        body:not(.dark) .sidebar-link:hover { background-color: #4b5563; color: #ffffff; } /* hover:bg-gray-700 hover:text-white */

        .sidebar-link.active { font-weight: 600; /* font-semibold */ }
        .dark .sidebar-link.active { background-color: #1f2937; color: #ffffff; } /* dark:bg-gray-800 (adjust if needed) */
        body:not(.dark) .sidebar-link.active { background-color: #374151; color: #ffffff; } /* active:bg-gray-700 */

        .sidebar-link i { margin-right: 0.75rem; width: 1.25rem; text-align: center; }

        .sidebar-section-title {
            padding-left: 0.75rem; /* px-3 */
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            text-transform: uppercase;
            letter-spacing: 0.05em; /* tracking-wider */
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .dark .sidebar-section-title { color: #6b7280; } /* text-gray-500 */
        body:not(.dark) .sidebar-section-title { color: #9ca3af; } /* text-gray-400 */


        /* Main Content Area */
        .content-wrapper {
            margin-left: 288px; /* w-72 */
            height: 100vh;
            overflow-y: auto;
            transition: margin-left 0.3s ease-in-out;
        }
        /* Header within content */
        .content-header {
            position: sticky;
            top: 0;
            padding: 1.25rem 2.5rem; /* py-5 md:px-10 */
            margin-bottom: 2rem; /* mb-8 */
            z-index: 20;
            backdrop-filter: blur(8px);
        }
        .dark .content-header { background-color: rgba(17, 24, 39, 0.85); border-bottom: 1px solid #374151; } /* dark:bg-gray-900/85 dark:border-gray-700 */
        body:not(.dark) .content-header { background-color: rgba(243, 244, 246, 0.85); border-bottom: 1px solid #e5e7eb; } /* bg-gray-100/85 border-gray-200 */

        /* Cards */
        .card {
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .dark .card { background-color: #1f2937; } /* dark:bg-gray-800 */
        body:not(.dark) .card { background-color: #ffffff; } /* bg-white */
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }

        /* Case Editor Modal (Tailwind style) */
        .case-editor-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        .case-editor-modal-content {
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: 100%;
            max-width: 48rem; /* max-w-3xl */
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .dark .case-editor-modal-content { background-color: #1f2937; } /* dark:bg-gray-800 */
        body:not(.dark) .case-editor-modal-content { background-color: #ffffff; }

        .case-editor-modal-overlay:not(.hidden) .case-editor-modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .quill-editor-container { height: 200px; margin-bottom: 1rem; border-radius: 0.375rem; overflow: hidden; }
        .dark .quill-editor-container .ql-toolbar { background: #374151; border-color: #4b5563 !important;}
        .dark .quill-editor-container .ql-container { background: #2d3748; border-color: #4b5563 !important; color: #d1d5db;}
        .dark .quill-editor-container .ql-editor { color: #d1d5db; }
        body:not(.dark) .quill-editor-container .ql-toolbar { background: #f9fafb; border-color: #d1d5db !important;}
        body:not(.dark) .quill-editor-container .ql-container { background: #ffffff; border-color: #d1d5db !important; color: #1f2937;}


        /* Chart styling */
        .chart-container {
            position: relative;
            /* height: 280px; /* Control height */
            /* width: 100%; */
            padding: 1rem;
            border-radius: 0.75rem;
        }
        .dark .chart-container { background-color: #1f2937; }
        body:not(.dark) .chart-container { background-color: #ffffff; }


        /* Responsive Sidebar Toggle (You'll need a button for this in HTML if you want it) */
        .sidebar-toggle-button {
            /* Styles for a burger menu button if you add one */
            display: none; /* Hidden by default, shown on small screens */
            position: fixed;
            top: 1.25rem;
            left: 1.25rem;
            z-index: 60;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .content-wrapper { margin-left: 0; }
            .sidebar-toggle-button { display: block; }
        }

        /* Utility for hidden */
        .hidden { display: none !important; }

        /* Focus Rings for accessibility */
        input:focus, button:focus, select:focus, textarea:focus, a:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Tailwind's ring-blue-500 */
        }
        .dark input:focus, .dark button:focus, .dark select:focus, .dark textarea:focus, .dark a:focus {
             box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.6); /* Tailwind's ring-blue-400 */
        }

        /* Search results highlighting */
        mark { padding: 0.1em 0.2em; border-radius: 0.2em; font-weight: bold; }
        .dark mark { background-color: #78350f; color: #f3f4f6; }
        body:not(.dark) mark { background-color: #fde047; color: #1f2937; }

    </style>
</head>
<body>
    <!-- Case Editor Modal (New Structure) -->
    <div id="caseEditorModalOverlay" class="case-editor-modal-overlay hidden">
        <div class="case-editor-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">New Case</h2>
                <button id="closeCaseModalBtn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="caseForm">
                <div class="mb-4">
                    <label for="caseTitle" class="block text-sm font-medium mb-1">Title</label>
                    <input type="text" id="caseTitle" class="mt-1 p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="caseSummary" class="block text-sm font-medium mb-1">Summary</label>
                    <textarea id="caseSummary" class="mt-1 p-2.5 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:border-indigo-500 focus:ring-indigo-500" rows="3" required></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-1">Resolution Steps</label>
                    <div id="quillEditor" class="quill-editor-container"></div>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="button" id="cancelCaseBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition">Cancel</button>
                    <button type="submit" id="saveCaseBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">Save Case</button>
                </div>
            </form>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database mr-3 text-indigo-400"></i> InfiniBase
            </div>
            <nav id="navigationMenu">
                <div class="sidebar-section-title">Main</div>
                <a href="#" class="sidebar-link" data-section="home"><i class="fas fa-home text-gray-400"></i>Home</a>

                <div class="sidebar-section-title">Knowledge Areas</div>
                <a href="#" class="sidebar-link" data-section="support"><i class="fas fa-headset text-blue-400"></i>Support</a>
                <a href="#" class="sidebar-link" data-section="partner_care"><i class="fas fa-handshake text-teal-400"></i>Partner Care</a>
                <a href="#" class="sidebar-link" data-section="logistics"><i class="fas fa-truck text-green-400"></i>Logistics</a>
                <a href="#" class="sidebar-link" data-section="customer_care"><i class="fas fa-users text-indigo-400"></i>Customer Care</a>
                <a href="#" class="sidebar-link" data-section="dist_follow_up"><i class="fas fa-people-carry text-cyan-400"></i>Distribution & Follow-up</a>
                <a href="#" class="sidebar-link" data-section="logistics_driver"><i class="fas fa-shipping-fast text-lime-400"></i>Logistics (Driver Complaints)</a>
                <a href="#" class="sidebar-link" data-section="logistics_3pl"><i class="fas fa-boxes text-yellow-400"></i>Logistics-3PL</a>
                <a href="#" class="sidebar-link" data-section="order_at_store"><i class="fas fa-store text-pink-400"></i>Order at Store (Mac)</a>
                <a href="#" class="sidebar-link" data-section="logistics_admin"><i class="fas fa-user-shield text-red-400"></i>Logistics-Admin</a>
                <a href="#" class="sidebar-link" data-section="os"><i class="fab fa-windows text-sky-400"></i>Operating Systems</a>

                <div class="sidebar-section-title">Resources & Policies</div>
                <a href="#" class="sidebar-link" data-section="compensation"><i class="fas fa-hand-holding-usd text-amber-400"></i>Compensation Policies</a>
                <a href="#" class="sidebar-link" data-section="op_instructions"><i class="fas fa-clipboard-list text-slate-400"></i>Operational Instructions</a>
                <a href="#" class="sidebar-link" data-section="forms_templates"><i class="fas fa-file-alt text-purple-400"></i>Forms/Templates</a>
                
                <div class="mt-6 pt-4 border-t border-gray-700 dark:border-gray-600">
                    <button id="openNewCaseModalBtn" class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition shadow-sm bg-indigo-600 hover:bg-indigo-700 text-white">
                        <i class="fas fa-plus-circle mr-2"></i> New Case
                    </button>
                </div>
            </nav>
            <div class="absolute bottom-6 left-0 right-0 px-6">
                 <button id="themeSwitcher" class="w-full flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition shadow-sm border border-gray-600 hover:bg-gray-700">
                    <i id="themeIcon" class="fas fa-moon mr-2"></i> <span id="themeText">Dark Mode</span>
                </button>
                <button id="logoutButton" class="w-full mt-3 flex items-center justify-center py-2.5 px-4 text-sm font-medium rounded-lg transition shadow-sm bg-red-600 hover:bg-red-700 text-white">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Mobile Sidebar Toggle Button (Example) -->
        <button id="mobileSidebarToggle" class="sidebar-toggle-button p-2 rounded-md bg-gray-700 text-white md:hidden">
            <i class="fas fa-bars text-xl"></i>
        </button>

        <div class="content-wrapper" id="contentWrapper">
            <header class="content-header">
                <div class="flex justify-between items-center w-full">
                    <div>
                        <h1 id="currentSectionTitle" class="text-2xl md:text-3xl font-bold">Welcome</h1>
                        <div id="breadcrumbs" class="text-sm mt-1 text-gray-500 dark:text-gray-400">Home</div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="search" id="globalSearchInput" placeholder="Search KB..." class="py-2.5 pl-10 pr-4 w-64 md:w-96 border rounded-full bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:border-indigo-500 focus:ring-indigo-500">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                            <div id="searchResultsContainer" class="hidden absolute mt-1 w-full max-h-80 overflow-y-auto rounded-md shadow-lg bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 z-10"></div>
                        </div>
                        <div id="userProfileContainer" class="flex items-center space-x-2">
                            <img id="userAvatar" src="https://ui-avatars.com/api/?name=U&size=36&background=4f46e5&color=fff&rounded=true" alt="User" class="w-9 h-9 rounded-full">
                            <span id="userNameDisplayHeader" class="font-medium hidden sm:block">User</span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="p-6 md:p-10" id="pageContentArea">
                <!-- Content will be injected here -->
                 <div id="dashboardOverviewContainer" class="hidden space-y-8">
                    <!-- Welcome Message (can be dynamic) -->
                     <div class="card bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                        <h2 class="text-3xl font-bold mb-2" id="welcomeUserNameDashboard">Welcome, User!</h2>
                        <p class="text-indigo-200">Overview of knowledge base activity.</p>
                        <p class="text-sm text-indigo-300 mt-1">InfiniBase v<span id="kbVersionDashboard"></span> | Last Update: <span id="lastKbUpdateDashboard"></span></p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="card chart-container h-72 md:h-80"> <h3 class="text-lg font-semibold mb-2 text-center">User Activity (Sample)</h3> <canvas id="usersChart"></canvas> </div>
                            <div class="card chart-container h-72 md:h-80"> <h3 class="text-lg font-semibold mb-2 text-center">Case Views (Sample)</h3> <canvas id="casesChart"></canvas> </div>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-3">Recent Updates</h3>
                            <ul id="recentUpdatesList" class="space-y-2 text-sm">
                                <li class="text-gray-400 dark:text-gray-500">No updates to show yet.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4">Advanced Data Filters</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="filterDate" class="block text-sm font-medium mb-1">Date</label>
                                <input type="date" id="filterDate" class="p-2 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                            </div>
                            <div>
                                <label for="filterUser" class="block text-sm font-medium mb-1">User</label>
                                <select id="filterUser" class="p-2 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600"><option value="">All Users</option></select>
                            </div>
                            <div>
                                <label for="filterInteraction" class="block text-sm font-medium mb-1">Interaction Type</label>
                                <select id="filterInteraction" class="p-2 w-full border rounded-md bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600">
                                    <option value="">All Types</option><option value="article_view">Article View</option><option value="case_created">Case Created</option>
                                </select>
                            </div>
                            <button id="applyFilterBtn" class="px-4 py-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 h-10">Apply</button>
                        </div>
                    </div>
                </div>
                <div id="standardSectionContentPlaceholder" class="space-y-8">
                    <!-- Fallback for other sections -->
                </div>
            </main>

            <footer class="mt-auto p-6 text-center text-sm text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">
                <span>Â© <script>document.write(new Date().getFullYear())</script> InfiniBase. v<span id="footerKbVersion"></span></span>
                <button id="reportErrorBtn" class="ml-4 text-xs text-red-500 hover:underline">Report an Issue</button>
            </footer>
        </div>
    </div>

    <script type="module">
        // --- SIMULATED MODULES (Replace with actual imports for production) ---
        const supabase = { // Simulated Supabase
            from: (table) => ({
                select: async (columns = '*') => {
                    console.log(`Simulated Supabase: SELECT ${columns} FROM ${table}`);
                    if (table === 'views_log') return { data: [{ user_identifier: "user1@sim.com" }, { user_identifier: "user2@sim.com" }], error: null };
                    if (table === 'cases') return { data: [], error: null }; // For initial load of cases if needed
                    return { data: [], error: null };
                },
                insert: async (records) => {
                    console.log(`Simulated Supabase: INSERT INTO ${table}`, records);
                    const newId = Math.floor(Math.random() * 10000);
                    return { data: [{ id: newId, ...records[0] }], error: null };
                },
                rpc: async (fnName, params) => { // Simulate RPC for distinct viewers
                    if (fnName === 'get_distinct_viewers') {
                         return { data: [{ user_identifier: "user1@sim.com" }, { user_identifier: "user2@sim.com" }, {user_identifier: "test@sim.com"}], error: null };
                    }
                    return {data: null, error: {message: "RPC not found"}};
                }
            })
        };

        const Auth = { // Simulated Auth
            isAuthenticated: () => true, // Assume always authenticated for this combined file
            getCurrentUser: () => ({ email: "testuser@example.com", fullName: "Test User", role: "admin" }),
            logout: () => { alert("Simulated Logout"); window.location.reload(); },
            protectPage: () => { if (!Auth.isAuthenticated()) { alert("Not Authorized (Simulated)"); window.location.href = "/login.html"; throw "Stop Execution"; } }
        };

        const kbSystemData = { /* ... PASTE YOUR FULL kbSystemData OBJECT HERE ... (from your data.js.txt or the one I provided) */
            meta: { version: "0.1.2", lastGlobalUpdate: "2023-11-28T12:00:00Z" },
            sections: [ { id: "support", name: "Support", icon: "fas fa-headset", themeColor: "blue", description: "Support resources.", articles: [{ id: "sup001", title: "High Priority Ticket", summary: "Handling P1s.", tags: ["p1"], contentPath:"#"}], cases: [{id: "case001", title:"User Alpha Disconnects", summary: "Frequent disconnects.", status:"Pending", tags:["connectivity"]}], subCategories: [{id:"tools", name:"Tools"}], glossary:[{term:"SLA", definition:"Service Level Agreement"}]}, {id:"partner_care", name:"Partner Care", icon:"fas fa-handshake", themeColor:"teal", description:"Partner support.", articles:[] } /* Add all other sections */ ]
        };
        // --- END OF SIMULATED MODULES ---

        // --- START OF APP LOGIC (Adapted from previous app.js) ---
        let caseEditorQuill;
        let usersChartInstance, casesChartInstance;
        const TABLES = { CASES: 'cases', VIEWS_LOG: 'views_log' };

        // DOM Elements
        const sidebar = document.getElementById('sidebar');
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const contentWrapper = document.getElementById('contentWrapper');
        const pageContentArea = document.getElementById('pageContentArea');
        const dashboardOverviewContainer = document.getElementById('dashboardOverviewContainer');
        const standardSectionContentPlaceholder = document.getElementById('standardSectionContentPlaceholder');
        const currentSectionTitleEl = document.getElementById('currentSectionTitle');
        const breadcrumbsContainer = document.getElementById('breadcrumbs');
        
        const userNameDisplayHeader = document.getElementById('userNameDisplayHeader');
        const userAvatar = document.getElementById('userAvatar');
        const welcomeUserNameDashboard = document.getElementById('welcomeUserNameDashboard');
        const kbVersionDashboard = document.getElementById('kbVersionDashboard');
        const lastKbUpdateDashboard = document.getElementById('lastKbUpdateDashboard');
        const footerKbVersion = document.getElementById('footerKbVersion');

        // Initial Setup
        Auth.protectPage();
        const currentUser = Auth.getCurrentUser();

        if (currentUser) {
            const displayName = currentUser.fullName || currentUser.email || "User";
            if (userNameDisplayHeader) userNameDisplayHeader.textContent = displayName;
            if (welcomeUserNameDashboard) welcomeUserNameDashboard.textContent = `Welcome, ${displayName}!`;
            if (userAvatar) userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&size=36&background=4f46e5&color=fff&rounded=true`;
        }
        if (kbSystemData.meta) {
            if (kbVersionDashboard) kbVersionDashboard.textContent = kbSystemData.meta.version;
            if (lastKbUpdateDashboard) lastKbUpdateDashboard.textContent = new Date(kbSystemData.meta.lastGlobalUpdate).toLocaleDateString();
            if (footerKbVersion) footerKbVersion.textContent = kbSystemData.meta.version;
        }
        
        // Theme Switcher
        const themeSwitcher = document.getElementById('themeSwitcher');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const htmlElement = document.documentElement;

        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                if (themeIcon) themeIcon.classList.replace('fa-moon', 'fa-sun');
                if (themeText) themeText.textContent = 'Light Mode';
            } else {
                htmlElement.classList.remove('dark');
                if (themeIcon) themeIcon.classList.replace('fa-sun', 'fa-moon');
                if (themeText) themeText.textContent = 'Dark Mode';
            }
             // Update chart colors if they exist
            [usersChartInstance, casesChartInstance].forEach(chart => {
                if (chart) {
                    chart.options.plugins.legend.labels.color = theme === 'dark' ? '#e2e8f0' : '#1a202c';
                    if (chart.options.scales && chart.options.scales.y) { // Bar chart has scales
                        chart.options.scales.y.ticks.color = theme === 'dark' ? '#94a3b8' : '#4a5568';
                        chart.options.scales.y.grid.color = theme === 'dark' ? '#374151' : '#e5e7eb';
                        chart.options.scales.x.ticks.color = theme === 'dark' ? '#94a3b8' : '#4a5568';
                        chart.options.scales.x.grid.color = theme === 'dark' ? '#374151' : '#e5e7eb';
                    }
                    chart.update();
                }
            });
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
        }
        if (themeSwitcher) {
            themeSwitcher.addEventListener('click', () => {
                const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        }
        loadTheme(); // Load theme on init

        // Mobile Sidebar Toggle
        if (mobileSidebarToggle && sidebar) {
            mobileSidebarToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
            // Close sidebar when a link is clicked on mobile
            sidebar.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 768) sidebar.classList.remove('open');
                });
            });
        }
        
        // Logout
        document.getElementById('logoutButton')?.addEventListener('click', () => Auth.logout());
        // Report Error
        document.getElementById('reportErrorBtn')?.addEventListener('click', () => alert('Report Error (Placeholder)'));

        // Case Editor Modal
        const caseEditorModalOverlay = document.getElementById('caseEditorModalOverlay');
        const openNewCaseModalBtn = document.getElementById('openNewCaseModalBtn');
        const closeCaseModalBtn = document.getElementById('closeCaseModalBtn');
        const caseForm = document.getElementById('caseForm');
        const cancelCaseBtn = document.getElementById('cancelCaseBtn');

        function openCaseEditor() {
            caseEditorModalOverlay.classList.remove('hidden');
            if (!caseEditorQuill) {
                caseEditorQuill = new Quill('#quillEditor', {
                    theme: 'snow',
                    modules: { toolbar: [[{ 'header': [1, 2, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }]] },
                    placeholder: 'Resolution steps...'
                });
            }
            caseForm.reset();
            if(caseEditorQuill) caseEditorQuill.setText('');
            document.getElementById('caseTitle')?.focus();
        }
        function closeCaseEditor() { caseEditorModalOverlay.classList.add('hidden'); }

        if(openNewCaseModalBtn) openNewCaseModalBtn.addEventListener('click', openCaseEditor);
        if(closeCaseModalBtn) closeCaseModalBtn.addEventListener('click', closeCaseEditor);
        if(cancelCaseBtn) cancelCaseBtn.addEventListener('click', closeCaseEditor);
        if(caseForm) caseForm.addEventListener('submit', async e => { e.preventDefault(); await saveCaseToSupabase(); });

        async function saveCaseToSupabase() {
            const title = document.getElementById('caseTitle').value.trim();
            const summary = document.getElementById('caseSummary').value.trim();
            const resolution_steps = caseEditorQuill ? caseEditorQuill.root.innerHTML : '';
            if (!title || !summary) { alert("Title and Summary are required."); return; }

            const user = Auth.getCurrentUser();
            const caseData = { title, summary, resolution_steps, status: 'New', created_by_email: user.email, created_by_name: user.fullName };
            const { data, error } = await supabase.from(TABLES.CASES).insert([caseData]).select();
            if (error) { alert(`Error saving case: ${error.message}`); console.error(error); }
            else {
                alert('Case saved!'); closeCaseEditor(); logUserView(data[0].id, 'case_created');
                // Add to local data and refresh if on relevant page (simplified)
                const currentSectionId = window.location.hash.split('/')[0].substring(1);
                const section = kbSystemData.sections.find(s => s.id === currentSectionId);
                if(section && section.cases) {
                    section.cases.unshift({ ...data[0], id: data[0].id.toString()}); // Make sure ID is string
                    displaySectionContent(currentSectionId);
                }
            }
        }

        // Chart Initialization
        function initCharts(viewData = []) {
            const isDark = htmlElement.classList.contains('dark');
            const legendColor = isDark ? '#e2e8f0' : '#1a202c';
            const ticksColor = isDark ? '#94a3b8' : '#4a5568';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            const chartOptions = (type) => ({
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: legendColor } } },
                scales: type === 'bar' ? {
                    y: { ticks: { color: ticksColor, beginAtZero: true }, grid: { color: gridColor } },
                    x: { ticks: { color: ticksColor }, grid: { color: gridColor } }
                } : {}
            });
            // Process viewData to get actual chart data - This is highly dependent on your views_log structure
            // Example: Count views per user for usersChart
            const userCounts = viewData.reduce((acc, view) => {
                acc[view.user_identifier] = (acc[view.user_identifier] || 0) + 1;
                return acc;
            }, {});

            if(usersChartInstance) usersChartInstance.destroy();
            const usersCtx = document.getElementById('usersChart')?.getContext('2d');
            if (usersCtx) {
                usersChartInstance = new Chart(usersCtx, {
                    type: 'bar',
                    data: { labels: Object.keys(userCounts), datasets: [{ label: 'User Views', data: Object.values(userCounts), backgroundColor: 'rgba(59, 130, 246, 0.7)' }] },
                    options: chartOptions('bar')
                });
            }
            if(casesChartInstance) casesChartInstance.destroy();
            const casesCtx = document.getElementById('casesChart')?.getContext('2d');
            if (casesCtx) { // Sample data for cases pie chart
                casesChartInstance = new Chart(casesCtx, {
                    type: 'pie',
                    data: { labels: ['Support Cases', 'Partner Cases', 'Logistics Issues'], datasets: [{ data: [15, 10, 5], backgroundColor: ['#10b981', '#f59e0b', '#ef4444'] }] },
                    options: chartOptions('pie')
                });
            }
        }
        
        // Filters
        const filterUserSelect = document.getElementById('filterUser');
        async function populateUserFilter() {
            const { data, error } = await supabase.rpc('get_distinct_viewers');
            if (error) { console.error("Error fetching distinct viewers:", error); return; }
            if (data && filterUserSelect) {
                filterUserSelect.innerHTML = '<option value="">All Users</option>';
                data.forEach(u => filterUserSelect.add(new Option(u.user_identifier, u.user_identifier)));
            }
        }
        document.getElementById('applyFilterBtn')?.addEventListener('click', async () => {
            const date = document.getElementById('filterDate').value;
            const user = filterUserSelect.value;
            const interaction = document.getElementById('filterInteraction').value;
            console.log("Filtering with:", {date, user, interaction});
            // Actual data fetching and chart update based on filters
            let query = supabase.from(TABLES.VIEWS_LOG).select('*');
            if(date) query = query.gte('viewed_at', `${date}T00:00:00Z`).lte('viewed_at', `${date}T23:59:59Z`);
            if(user) query = query.eq('user_identifier', user);
            if(interaction) query = query.eq('item_type', interaction);
            const {data: filteredData, error} = await query;
            if(error) console.error("Error fetching filtered data:", error);
            else initCharts(filteredData || []); // Re-init charts
        });

        // Helper Functions (escapeHTML, highlightText, truncateText, stripHtml, getThemeColors)
        function escapeHTML(str) { if (typeof str !== 'string') return ''; return str.replace(/[&<>"']/g, m=>({'&':'&','<':'<','>':'>','"':'"',"'":'''}[m]));}
        function highlightText(text, query) { if (!text) return ''; const safeText=escapeHTML(text); if(!query) return safeText; try { const rgx=new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&')})`, 'gi'); return safeText.replace(rgx, '<mark>$1</mark>');} catch(e){return safeText;}}
        function truncateText(text, len) { if(!text || text.length <= len) return text; return text.substring(0,len)+'...';}
        function stripHtml(html){ const tmp=document.createElement("DIV"); tmp.innerHTML=html; return tmp.textContent||tmp.innerText||""; }
        function getThemeColors(themeColor = 'gray') {
            const color = typeof themeColor === 'string' ? themeColor.toLowerCase() : 'gray';
            const colorMap = { /* ... Same as your provided colorMap ... */ 
            blue: { bg: 'bg-blue-100 dark:bg-blue-900', text: 'text-blue-600 dark:text-blue-400', iconContainer: 'bg-blue-100 dark:bg-blue-800/50', icon: 'text-blue-500 dark:text-blue-400', cta: 'text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300', border: 'border-blue-500', tagBg: 'bg-blue-100 dark:bg-blue-500/20', tagText: 'text-blue-700 dark:text-blue-300', statusBg: 'bg-blue-100 dark:bg-blue-500/20', statusText: 'text-blue-700 dark:text-blue-400' }, teal: { bg: 'bg-teal-100 dark:bg-teal-900', text: 'text-teal-600 dark:text-teal-400', iconContainer: 'bg-teal-100 dark:bg-teal-800/50', icon: 'text-teal-500 dark:text-teal-400', cta: 'text-teal-600 hover:text-teal-700 dark:text-teal-400 dark:hover:text-teal-300', border: 'border-teal-500', tagBg: 'bg-teal-100 dark:bg-teal-500/20', tagText: 'text-teal-700 dark:text-teal-300', statusBg: 'bg-teal-100 dark:bg-teal-500/20', statusText: 'text-teal-700 dark:text-teal-400' }, /* ... add all other colors from your previous correct version */ 
            gray: { bg: 'bg-gray-100 dark:bg-gray-800', text: 'text-gray-600 dark:text-gray-400', iconContainer: 'bg-gray-100 dark:bg-gray-700/50', icon: 'text-gray-500 dark:text-gray-400', cta: 'text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300', border: 'border-gray-500', tagBg: 'bg-gray-200 dark:bg-gray-700', tagText: 'text-gray-700 dark:text-gray-300', statusBg: 'bg-gray-200 dark:bg-gray-600', statusText: 'text-gray-700 dark:text-gray-300' }};
            return colorMap[color] || colorMap.gray;
        }


        // Card Rendering (using the more detailed Tailwind versions)
        function renderArticleCard(article, sectionData) { /* Similar to previous detailed renderArticleCard_enhanced */ 
            const theme = getThemeColors(sectionData.themeColor);
            const cardIconClass = sectionData.icon || 'fas fa-file-alt';
            return `
            <div class="card card-animate border-t-4 ${theme.border}" data-item-id="${article.id}" data-item-type="article">
                <div class="flex items-center mb-3">
                    <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="${cardIconClass} text-xl ${theme.icon}"></i></div>
                    <h3 class="font-semibold text-lg leading-tight">${escapeHTML(article.title)}</h3>
                </div>
                <p class="text-sm mb-4 flex-grow text-gray-600 dark:text-gray-400">${escapeHTML(article.summary) || 'No summary.'}</p>
                ${article.tags && article.tags.length > 0 ? `<div class="mb-4">${article.tags.map(tag => `<span class="text-xs ${theme.tagBg} ${theme.tagText} px-2 py-1 rounded-full mr-1 mb-1 font-medium">${escapeHTML(tag)}</span>`).join('')}</div>` : ''}
                <div class="mt-auto flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                    <div><!-- Rating Placeholder --></div>
                    <a href="${escapeHTML(article.contentPath || '#')}" target="_blank" class="text-sm font-medium ${theme.cta}">Read More <i class="fas fa-arrow-right ml-1 text-xs"></i></a>
                </div>
            </div>`;
        }
        function renderCaseCard(caseItem, sectionData) { /* Similar to previous detailed renderCaseCard_enhanced */
             const theme = getThemeColors(sectionData.themeColor);
             return `
             <div class="card card-animate border-t-4 ${theme.border}" data-item-id="${caseItem.id}" data-item-type="case">
                <div class="flex items-center mb-3">
                    <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="fas fa-briefcase text-xl ${theme.icon}"></i></div>
                    <h3 class="font-semibold text-lg leading-tight">${escapeHTML(caseItem.title)}</h3>
                </div>
                <p class="text-sm mb-2 flex-grow text-gray-600 dark:text-gray-400">${escapeHTML(caseItem.summary) || 'No summary.'}</p>
                ${caseItem.resolutionStepsPreview ? `<p class="text-xs italic mb-3 text-gray-500 dark:text-gray-500">Preview: ${escapeHTML(truncateText(caseItem.resolutionStepsPreview,100))}</p>`:''}
                <div class="mt-auto flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                    <span class="text-sm font-medium px-3 py-1 rounded-full ${theme.statusBg} ${theme.statusText}">${escapeHTML(caseItem.status)}</span>
                    <a href="${escapeHTML(caseItem.contentPath || '#')}" target="_blank" class="text-sm font-medium ${theme.cta}">Details <i class="fas fa-arrow-right ml-1 text-xs"></i></a>
                </div>
            </div>`;
        }
        function renderItemCard(item, sectionData) { /* Similar to previous detailed renderItemCard_enhanced */
            const theme = getThemeColors(sectionData.themeColor);
            return `
            <div class="card card-animate border-t-4 ${theme.border}" data-item-id="${item.id}" data-item-type="item">
                <div class="flex items-center mb-3">
                    <div class="p-3 rounded-full ${theme.iconContainer} mr-4"><i class="${sectionData.icon || 'fas fa-archive'} text-xl ${theme.icon}"></i></div>
                    <h3 class="font-semibold text-lg leading-tight">${escapeHTML(item.title)}</h3>
                </div>
                <p class="text-sm mb-4 flex-grow text-gray-600 dark:text-gray-400">${escapeHTML(item.description) || 'No description.'}</p>
                <div class="mt-auto flex justify-between items-center pt-3 border-t border-gray-200 dark:border-gray-700">
                    <span class="text-xs ${theme.tagBg} ${theme.tagText} px-3 py-1 rounded-full uppercase font-semibold">${escapeHTML(item.type)}</span>
                    <a href="${escapeHTML(item.url)}" target="_blank" class="text-sm font-medium ${theme.cta}">Open <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>
                </div>
            </div>`;
        }

        // Content Display
        function displaySectionContent(sectionId, itemIdToFocus = null, subCategoryFilter = null) {
            dashboardOverviewContainer.classList.add('hidden');
            standardSectionContentPlaceholder.classList.remove('hidden'); // Show the placeholder for section content
            standardSectionContentPlaceholder.innerHTML = ''; // Clear previous content

            if (sectionId === 'home') {
                dashboardOverviewContainer.classList.remove('hidden');
                standardSectionContentPlaceholder.classList.add('hidden');
                if (currentSectionTitleEl) currentSectionTitleEl.textContent = 'Dashboard Overview';
                if (breadcrumbsContainer) breadcrumbsContainer.innerHTML = `<span class="font-medium">Home</span>`;
                initCharts(); // Pass actual data if available
                populateUserFilter();
                return;
            }

            const sectionData = kbSystemData.sections.find(s => s.id === sectionId);
            if (!sectionData) {
                standardSectionContentPlaceholder.innerHTML = `<div class="p-6 text-center"><h2 class="text-xl font-semibold">Section Not Found: ${escapeHTML(sectionId)}</h2></div>`;
                if(currentSectionTitleEl) currentSectionTitleEl.textContent = "Not Found";
                return;
            }

            if(currentSectionTitleEl) currentSectionTitleEl.textContent = sectionData.name;
            // Breadcrumbs logic (simplified, can be expanded)
            if (breadcrumbsContainer) {
                let bcHTML = `<a href="#" data-section="home" class="hover:underline">Home</a> <span class="mx-1">></span> <span class="font-medium">${escapeHTML(sectionData.name)}</span>`;
                if(subCategoryFilter) {
                    const subCatName = sectionData.subCategories?.find(sc => sc.id === subCategoryFilter)?.name || subCategoryFilter;
                    bcHTML = `<a href="#" data-section="home" class="hover:underline">Home</a> <span class="mx-1">></span> <a href="#" data-section="${sectionData.id}" class="hover:underline">${escapeHTML(sectionData.name)}</a> <span class="mx-1">></span> <span class="font-medium">${escapeHTML(subCatName)}</span>`;
                }
                breadcrumbsContainer.innerHTML = bcHTML;
            }
            
            let contentHTML = `<div class="space-y-8">`;
            const theme = getThemeColors(sectionData.themeColor);
            
            // Header for section (already in main header, but can add sub-header here if needed)
            // contentHTML += `<h2 class="text-3xl font-bold mb-6">${escapeHTML(sectionData.name)}</h2>`;
            // contentHTML += `<p class="text-lg text-gray-600 dark:text-gray-400 mb-8">${escapeHTML(sectionData.description)}</p>`;

            const articles = (sectionData.articles || []).filter(a => !subCategoryFilter || a.tags?.includes(subCategoryFilter));
            const cases = (sectionData.cases || []).filter(c => !subCategoryFilter || c.tags?.includes(subCategoryFilter));
            const items = (sectionData.items || []).filter(i => !subCategoryFilter || i.type === subCategoryFilter);

            if(articles.length) {
                contentHTML += `<h3 class="text-2xl font-semibold mb-4 border-b pb-2 border-gray-300 dark:border-gray-700">Articles</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">`;
                articles.forEach(article => contentHTML += renderArticleCard(article, sectionData));
                contentHTML += `</div>`;
            }
            if(cases.length) {
                contentHTML += `<h3 class="text-2xl font-semibold mt-8 mb-4 border-b pb-2 border-gray-300 dark:border-gray-700">Cases</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">`;
                cases.forEach(caseItem => contentHTML += renderCaseCard(caseItem, sectionData));
                contentHTML += `</div>`;
            }
            if(items.length) {
                contentHTML += `<h3 class="text-2xl font-semibold mt-8 mb-4 border-b pb-2 border-gray-300 dark:border-gray-700">Items</h3><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">`;
                items.forEach(item => contentHTML += renderItemCard(item, sectionData));
                contentHTML += `</div>`;
            }
            // Sub-categories (if not filtering by one)
            if (!subCategoryFilter && sectionData.subCategories && sectionData.subCategories.length > 0) {
                contentHTML += `<h3 class="text-2xl font-semibold mt-8 mb-4 border-b pb-2 border-gray-300 dark:border-gray-700">Sub-Categories</h3><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">`;
                sectionData.subCategories.forEach(subCat => {
                    contentHTML += `<a href="#" data-section="${sectionData.id}" data-subcat-filter="${subCat.id}" class="card card-animate text-center hover:border-indigo-500 border-transparent border-2">
                        <i class="${sectionData.icon || 'fas fa-folder-open'} text-3xl mb-2 ${theme.icon}"></i>
                        <h4 class="font-medium">${escapeHTML(subCat.name)}</h4>
                    </a>`;
                });
                contentHTML += `</div>`;
            }

            if (!articles.length && !cases.length && !items.length && (!sectionData.subCategories || sectionData.subCategories.length === 0 || subCategoryFilter)) {
                 contentHTML += `<div class="text-center py-10"><p class="text-xl text-gray-500">No content found for this section/filter.</p></div>`;
            }

            contentHTML += `</div>`;
            standardSectionContentPlaceholder.innerHTML = contentHTML;

            // Animate cards
            standardSectionContentPlaceholder.querySelectorAll('.card-animate').forEach((card, index) => {
                card.style.opacity = '0'; card.style.transform = 'translateY(20px)';
                setTimeout(() => { card.style.opacity = '1'; card.style.transform = 'translateY(0)'; card.style.transition = 'opacity 0.5s ease, transform 0.5s ease'; card.style.transitionDelay = `${index * 0.07}s`; }, 50);
            });

             if (itemIdToFocus) { // Scroll to focused item
                setTimeout(() => {
                    const targetCard = standardSectionContentPlaceholder.querySelector(`[data-item-id="${itemIdToFocus}"]`);
                    if (targetCard) {
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetCard.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.5)'; // Focus ring
                        setTimeout(() => targetCard.style.boxShadow = '', 3000);
                    }
                }, 300);
            }
        }

        // Navigation and Routing
        function highlightSidebarLink(sectionId) {
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active', 'bg-gray-700', 'dark:bg-gray-600', 'text-white'));
            const activeLink = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`);
            if (activeLink) activeLink.classList.add('active', 'bg-gray-700', 'dark:bg-gray-600', 'text-white');
        }

        function handleNavigation() {
            const hash = window.location.hash.substring(1);
            const parts = hash.split('/');
            const sectionId = parts[0] || 'home';
            const subCategoryFilter = (parts.length > 1 && kbSystemData.sections.find(s=>s.id===sectionId)?.subCategories?.find(sc=>sc.id===parts[1])) ? parts[1] : null;
            const itemIdToFocus = subCategoryFilter ? (parts[2] || null) : (parts[1] || null) ;
            
            highlightSidebarLink(sectionId);
            displaySectionContent(sectionId, itemIdToFocus, subCategoryFilter);
            logUserView(sectionId, 'navigation', subCategoryFilter || itemIdToFocus);
        }
        
        document.querySelectorAll('.sidebar-link, [data-section], [data-subcat-filter]').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const section = link.dataset.section;
                const subcat = link.dataset.subcatFilter;
                let newHash = section;
                if(subcat) newHash += `/${subcat}`;
                window.location.hash = newHash;
                // handleNavigation will be called by 'hashchange' listener
            });
        });
         // Global search
        const globalSearchInput = document.getElementById('globalSearchInput');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        globalSearchInput?.addEventListener('input', () => {
            const query = globalSearchInput.value.trim().toLowerCase();
            if (query.length < 2) { searchResultsContainer.classList.add('hidden'); return; }
            // Simplified search (implement your searchKb logic if it's more complex)
            const results = [];
            kbSystemData.sections.forEach(s => {
                s.articles?.forEach(a => { if(a.title.toLowerCase().includes(query) || a.summary?.toLowerCase().includes(query)) results.push({...a, type:'article', sectionId:s.id, sectionName:s.name});});
                s.cases?.forEach(c => { if(c.title.toLowerCase().includes(query) || c.summary?.toLowerCase().includes(query)) results.push({...c, type:'case', sectionId:s.id, sectionName:s.name});});
            });
            searchResultsContainer.innerHTML = '';
            if(results.length) {
                results.slice(0,5).forEach(r => {
                    const li = document.createElement('a');
                    li.href = `#${r.sectionId}/${r.id}`;
                    li.className = 'block p-3 hover:bg-gray-100 dark:hover:bg-gray-600';
                    li.innerHTML = `<div class="font-medium">${highlightText(r.title, query)} <span class="text-xs text-gray-500">(${r.type} in ${r.sectionName})</span></div><p class="text-sm text-gray-600 dark:text-gray-400">${highlightText(truncateText(r.summary, 50),query)}</p>`;
                    searchResultsContainer.appendChild(li);
                });
                searchResultsContainer.classList.remove('hidden');
            } else {
                searchResultsContainer.innerHTML = `<div class="p-3 text-sm text-gray-500">No results.</div>`;
                searchResultsContainer.classList.remove('hidden');
            }
        });
        document.addEventListener('click', e => { // Hide search on outside click
            if (!globalSearchInput.contains(e.target) && !searchResultsContainer.contains(e.target)) {
                searchResultsContainer.classList.add('hidden');
            }
        });


        async function logUserView(itemId, itemType, details) {
            const user = Auth.getCurrentUser();
            const viewData = { item_id: itemId, item_type: itemType, user_identifier: user.email, details_text: details, viewed_at: new Date().toISOString() };
            await supabase.from(TABLES.VIEWS_LOG).insert([viewData]);
        }

        window.addEventListener('hashchange', handleNavigation);
        handleNavigation(); // Initial load

        console.log("InfiniBase App Initialized (Single File Version)");
        // --- END OF APP LOGIC ---
    </script>
</body>
</html>
