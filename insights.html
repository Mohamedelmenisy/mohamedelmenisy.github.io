<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Tracking Dashboard</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
        /* --- 1. Global Styles & Theme Variables --- */
        :root {
            --bg-dark: #0F1015;
            --bg-card: #1A1C23;
            --bg-header: #21242D;
            --primary-accent: #6C5DD3;
            --primary-accent-light: #8A7EFF;
            --secondary-accent: #3F8CFF;
            --text-light: #F5F5F5;
            --text-muted: #9CA3B3;
            --border-color: #2A2D38;
            --success: #00B69B;
            --warning: #FFC454;
            --danger: #FF6A55;
            --font-family: 'Inter', sans-serif;
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.25);
            --gradient-primary: linear-gradient(135deg, #6C5DD3 0%, #8374FF 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; font-size: 100%; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(108, 93, 211, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 90% 80%, rgba(63, 140, 255, 0.08) 0%, transparent 25%);
        }
        
        /* --- 2. Main Dashboard Layout --- */
        .insights-dashboard {
            padding: 2rem;
            display: grid;
            gap: 1.5rem;
            width: 100%;
            margin: 0 auto;
            visibility: hidden; /* Hide until access is verified */
        }

        .dashboard-header {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            gap: 1rem; background: var(--bg-card); padding: 1.5rem 2rem; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); box-shadow: var(--shadow); position: relative; overflow: hidden;
        }

        .dashboard-header::before {
            content: ''; position: absolute; top: -20px; left: -20px; width: 150px; height: 150px;
            background: var(--gradient-primary); opacity: 0.1; filter: blur(20px); border-radius: 0 0 100% 0;
        }

        .header-title h1 {
            font-size: clamp(1.75rem, 2.5vw, 2rem); font-weight: 800; background: var(--gradient-primary);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;
        }
        .header-title p { color: var(--text-muted); font-size: 1rem; font-weight: 500; }
        .header-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        
        .action-btn {
            background-color: var(--bg-header); color: var(--text-light); border: 1px solid var(--border-color);
            padding: 12px 20px; border-radius: 12px; font-family: var(--font-family); cursor: pointer;
            transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: 600; font-size: 14px; text-decoration: none;
        }
        .action-btn.primary { background: var(--gradient-primary); border: none; color: white; }
        .action-btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); border-color: var(--primary-accent); }
        .action-btn.primary:hover { filter: brightness(1.15); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .back-to-dashboard-btn { order: -1; }

        /* --- 3. KPI Cards & Charts --- */
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; }
        .kpi-card {
            background-color: var(--bg-card); padding: 1.5rem; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); animation: fadeInUp 0.5s ease-out forwards; opacity: 0;
            transition: var(--transition); box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); border-color: var(--primary-accent); }
        .kpi-card .card-title { color: var(--text-muted); font-size: 14px; font-weight: 600; margin-bottom: 1rem; }
        .kpi-card .card-value { font-size: clamp(1.75rem, 3vw, 2.25rem); font-weight: 800; color: var(--text-light); line-height: 1.2; }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .chart-card {
            background-color: var(--bg-card); padding: 1.5rem; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); animation: fadeInUp 0.7s ease-out forwards; opacity: 0;
            transition: var(--transition); box-shadow: var(--shadow); display: flex; flex-direction: column; min-height: 400px;
        }
        .chart-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .chart-card h3 { font-size: 18px; margin-bottom: 1.5rem; font-weight: 700; }
        .chart-placeholder { flex-grow: 1; position: relative; }
        
        /* --- 4. Filters Section --- */
        .filters-container {
            background-color: var(--bg-card); padding: 1.5rem 2rem; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            align-items: end; gap: 1.5rem; box-shadow: var(--shadow);
        }
        .filter-group { display: flex; flex-direction: column; gap: 8px; position: relative; }
        .filter-group label { font-size: 14px; color: var(--text-muted); font-weight: 600; }
        .filter-group input, .filter-group select {
            background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-light);
            padding: 12px 14px; border-radius: 12px; font-family: var(--font-family);
            transition: var(--transition); font-size: 14px;
        }
        .filter-group input[type="date"] { padding-right: 3rem; }
        .filter-group.date-filter::after {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            content: "\f073"; /* Calendar Icon */
            color: var(--text-muted);
            position: absolute;
            right: 16px;
            bottom: 14px;
            pointer-events: none;
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none; border-color: var(--primary-accent);
            box-shadow: 0 0 0 4px rgba(108, 93, 211, 0.25);
        }
        .filter-actions { grid-column: 1 / -1; display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1rem; }
        
        /* --- 5. Activity Log Table --- */
        .activity-log-card {
            background-color: var(--bg-card); padding: 1.5rem; border-radius: var(--border-radius);
            border: 1px solid var(--border-color); animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0; transition: var(--transition); box-shadow: var(--shadow);
        }
        .activity-log-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .activity-log-header { display:flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .activity-log-header h3 { font-size: 18px; font-weight: 700; margin: 0; }
        #totalRecords { color: var(--text-muted); font-size: 14px; }
        .activity-table { width: 100%; border-collapse: collapse; }
        .activity-table th {
            background-color: var(--bg-header); color: var(--text-muted); font-weight: 600; font-size: 13px;
            text-align: left; padding: 14px 18px; border-bottom: 2px solid var(--border-color);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .activity-table th:first-child { border-radius: 12px 0 0 12px; }
        .activity-table th:last-child { border-radius: 0 12px 12px 0; }
        .activity-table td { padding: 16px 18px; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .activity-table tr:last-child td { border-bottom: none; }
        .activity-table tbody tr:hover { background-color: rgba(42, 45, 56, 0.5); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        .user-name { font-weight: 600; }
        .user-email { font-size: 12px; color: var(--text-muted); word-break: break-all; }
        .role-badge { padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .role-admin { background: rgba(108, 93, 211, 0.2); color: var(--primary-accent); }
        .role-manager { background: rgba(63, 140, 255, 0.2); color: var(--secondary-accent); }
        .role-user { background: rgba(0, 182, 155, 0.2); color: var(--success); }
        .status-badge { padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; text-transform: capitalize; }
        .status-viewed { background: rgba(0, 182, 155, 0.2); color: var(--success); }
        .status-downloaded { background: rgba(63, 140, 255, 0.2); color: var(--secondary-accent); }
        .status-searched { background: rgba(255, 196, 84, 0.2); color: var(--warning); }
        .view-count-badge { 
            background: var(--gradient-primary); 
            color: white; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 700;
        }
        .table-container { overflow-x: auto; }
        .skeleton-loader .skeleton-bar { width: 90%; height: 20px; background-color: var(--border-color); border-radius: 4px; opacity: 0.5; animation: shimmer 1.5s infinite linear; }
        @keyframes shimmer { 0% { background-color: var(--border-color); } 50% { background-color: #3f4452; } 100% { background-color: var(--border-color); } }

        /* --- 6. Timeline & Pagination --- */
        .timeline-container { max-height: 450px; overflow-y: auto; padding-right: 10px; }
        .timeline-item { display: flex; gap: 1rem; padding: 1rem 0; border-left: 2px solid var(--border-color); position: relative; margin-left: 5px;}
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-dot { position: absolute; left: -6.5px; top: 1.4rem; width: 10px; height: 10px; border-radius: 50%; background: var(--primary-accent); flex-shrink: 0; z-index: 1; }
        .timeline-content { padding-left: 1.5rem; flex-grow: 1; }
        .timeline-time { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
        .timeline-text { font-size: 14px; }
        .timeline-user { font-weight: 600; color: var(--primary-accent-light); }
        
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 2rem; padding: 1rem; }
        .pagination-btn { background: var(--bg-header); border: 1px solid var(--border-color); color: var(--text-light); padding: 10px 16px; border-radius: 10px; cursor: pointer; transition: var(--transition); }
        .pagination-btn:hover:not(:disabled) { background: var(--primary-accent); border-color: var(--primary-accent); }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-info { color: var(--text-muted); font-size: 14px; margin: 0 1rem; }

        /* --- 7. Utility & Animations --- */
        .access-restricted-container { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 100vh; }
        .access-restricted-container .card { max-width: 450px; padding: 3rem; background: var(--bg-card); border-radius: var(--border-radius); border: 1px solid var(--border-color); }
        .access-restricted-container .icon { font-size: 3rem; color: var(--primary-accent); margin-bottom: 1rem; }
        .toast { position: fixed; bottom: 20px; right: 20px; z-index: 1100; display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem; border-radius: 12px; color: #fff; box-shadow: var(--shadow-hover); opacity: 0; transform: translateY(20px); transition: all .4s cubic-bezier(.25, .46, .45, .94); }
        .toast.show { opacity: 1; transform: translateY(0); }
        @keyframes fadeInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .kpi-card:nth-child(1) { animation-delay: 0.1s; } .kpi-card:nth-child(2) { animation-delay: 0.2s; }
        .kpi-card:nth-child(3) { animation-delay: 0.3s; } .kpi-card:nth-child(4) { animation-delay: 0.4s; }
        .chart-card:nth-child(1) { animation-delay: 0.5s; } .chart-card:nth-child(2) { animation-delay: 0.6s; }
        .chart-card:nth-child(3) { animation-delay: 0.7s; }
        
        /* Custom Scrollbar Styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; border: 2px solid var(--bg-dark); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--primary-accent); }

        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- 8. Responsive Design --- */
        @media (max-width: 1200px) { .charts-container { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); } }
        @media (max-width: 992px) { .insights-dashboard { padding: 1.5rem; } }
        @media (max-width: 768px) {
            .insights-dashboard { padding: 1rem; gap: 1rem; }
            .dashboard-header { flex-direction: column; align-items: flex-start; }
            .header-actions { width: 100%; }
            .kpi-container { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .filters-container { gap: 1rem; }
        }
        @media (max-width: 576px) { .kpi-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="dashboard-container" class="insights-dashboard">
        
        <header class="dashboard-header">
            <div class="header-title">
                <h1><i class="fas fa-chart-line"></i> Employee Tracking Dashboard</h1>
                <p>Monitor and analyze employee activity</p>
            </div>
            <div class="header-actions">
                <a href="dashboard.html" class="action-btn back-to-dashboard-btn">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <button class="action-btn" id="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button class="action-btn primary" id="export-btn"><i class="fas fa-download"></i> Export CSV</button>
            </div>
        </header>

        <div class="kpi-container" id="kpi-section">
            <div class="kpi-card"><div class="card-title">Total Actions</div><div class="card-value" id="kpi-total-actions">---</div></div>
            <div class="kpi-card"><div class="card-title">Unique Cases</div><div class="card-value" id="kpi-total-docs">---</div></div>
            <div class="kpi-card"><div class="card-title">Most Active Dept</div><div class="card-value" id="kpi-active-dept">---</div></div>
            <div class="kpi-card"><div class="card-title">Active Users (Today)</div><div class="card-value" id="kpi-active-users">---</div></div>
        </div>

        <div class="filters-container" id="filters-section">
            <div class="filter-group date-filter"><label for="from-date">From Date</label><input type="date" id="from-date"></div>
            <div class="filter-group date-filter"><label for="to-date">To Date</label><input type="date" id="to-date"></div>
            <div class="filter-group"><label for="department">Department</label><select id="department"><option value="">All Departments</option></select></div>
            <div class="filter-group"><label for="search-user">Search User</label><input type="text" id="search-user" placeholder="Name or email..."></div>
            <div class="filter-actions">
                <button class="action-btn" id="clear-filters-btn"><i class="fas fa-times"></i> Clear All</button>
            </div>
        </div>

        <div class="charts-container" id="charts-section">
            <div class="chart-card"><h3 class="chart-title"><i class="fas fa-chart-pie"></i> Activity by Department</h3><div class="chart-placeholder"><canvas id="activityByCategoryChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title"><i class="fas fa-fire-alt"></i> Top Viewed Cases</h3><div class="chart-placeholder"><canvas id="topViewedArticlesChart"></canvas></div></div>
            <div class="chart-card"><h3 class="chart-title"><i class="fas fa-chart-bar"></i> Daily Activity</h3><div class="chart-placeholder"><canvas id="dailyActivityChart"></canvas></div></div>
        </div>

        <div class="activity-log-card">
            <div class="activity-log-header">
                <h3><i class="fas fa-history"></i> Recent Activity Timeline</h3>
                <div id="totalRecords">0 records found</div>
            </div>
            <div class="timeline-container" id="timeline-container"></div>
            <div class="table-container">
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Action</th>
                            <th>Department</th>
                            <th>Section</th>
                            <th>Case</th>
                            <th>First View</th>
                            <th>Last View</th>
                            <th>Views</th>
                        </tr>
                    </thead>
                    <tbody id="activity-table-body"></tbody>
                    <tbody id="skeleton-body" class="skeleton-loader">
                        <tr><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td></tr>
                        <tr><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td></tr>
                        <tr><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td><td><div class="skeleton-bar"></div></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="pagination-btn" id="prev-btn" disabled><i class="fas fa-arrow-left"></i></button>
                <span class="pagination-info" id="page-info">Page 1 of 1</span>
                <button class="pagination-btn" id="next-btn" disabled><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
    
    <div id="restricted-card" class="access-restricted-container">
        <div class="card">
            <div class="icon">ðŸ”’</div>
            <h2>Access Restricted</h2>
            <p>You do not have permission to view this page. Please contact an administrator.</p>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script type="module">
        import { supabase } from './supabase.js';

        let allActivity = [];
        let filteredActivity = [];
        let charts = {};
        let currentPage = 1;
        const PAGE_SIZE = 10;

        const UIElements = {
            kpiTotalActions: document.getElementById('kpi-total-actions'),
            kpiTotalDocs: document.getElementById('kpi-total-docs'),
            kpiActiveDept: document.getElementById('kpi-active-dept'),
            kpiActiveUsers: document.getElementById('kpi-active-users'),
            departmentFilter: document.getElementById('department'),
            activityTableBody: document.getElementById('activity-table-body'),
            timelineContainer: document.getElementById('timeline-container'),
            pageInfo: document.getElementById('page-info'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            totalRecords: document.getElementById('totalRecords'),
            skeletonBody: document.getElementById('skeleton-body'),
            dashboardContainer: document.getElementById('dashboard-container'),
            restrictedCard: document.getElementById('restricted-card')
        };
        
        const showSkeleton = (show = true) => {
            UIElements.skeletonBody.style.display = show ? 'table-row-group' : 'none';
            UIElements.activityTableBody.style.display = show ? 'none' : 'table-row-group';
        };

        const escapeHtml = (unsafe) => {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        };

        const showToast = (message, type = 'info') => {
            const toast = document.getElementById('toast');
            const colors = { success: 'var(--success)', danger: 'var(--danger)', info: 'var(--primary-accent)' };
            toast.textContent = message;
            toast.style.backgroundColor = colors[type] || colors.info;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        };

        /**
         * [REWRITTEN & FIXED] Fetches and reconstructs activity data from primary tables.
         */
        async function fetchData() {
            showSkeleton(true);
            try {
                // Fetch raw data from primary sources
                const [activityLogRes, usersRes] = await Promise.all([
                    supabase.from('activity_log').select('user_id, user_name, action, case_id, case_title, section, timestamp').order('timestamp', { ascending: false }),
                    supabase.from('users').select('id, name, email, role, department')
                ]);

                if (activityLogRes.error) throw activityLogRes.error;
                
                const activityLog = activityLogRes.data || [];
                const users = usersRes.data || [];
                const usersMap = new Map(users.map(u => [u.id, u]));

                // Group activity logs by user and case to calculate view counts
                const groupedActivity = activityLog
                    .filter(log => log.action === 'viewed' && log.user_id && log.case_id)
                    .reduce((acc, log) => {
                        const key = `${log.user_id}-${log.case_id}`;
                        if (!acc[key]) {
                            acc[key] = {
                                user_id: log.user_id,
                                case_id: log.case_id,
                                views: [],
                            };
                        }
                        acc[key].views.push(new Date(log.timestamp));
                        return acc;
                    }, {});

                // Reconstruct the `allActivity` array to match the expected format
                allActivity = Object.values(groupedActivity).map(group => {
                    const user = usersMap.get(group.user_id) || { name: 'Unknown', email: '', role: 'user', department: 'N/A' };
                    const firstLog = activityLog.find(log => log.user_id === group.user_id && log.case_id === group.case_id);
                    group.views.sort((a, b) => a - b); // Sort dates chronologically

                    return {
                        "User": user.name,
                        "Role": user.role || 'user',
                        "Action": 'viewed',
                        "Department": user.department || 'N/A',
                        "Section": firstLog?.section || 'N/A',
                        "Case": firstLog?.case_title || 'Unknown Case',
                        "First View": group.views[0],
                        "Last View": group.views[group.views.length - 1],
                        "View Count": group.views.length,
                        "User Email": user.email || '',
                    };
                }).sort((a, b) => b["Last View"] - a["Last View"]); // Sort final result by last view
                
                console.log("âœ… Data reconstructed from activity_log:", allActivity.length, "records");
                
                populateFilters();
                applyFiltersAndRender();
            } catch (error) {
                console.error("Error fetching data:", error);
                showToast(`Failed to load activity data: ${error.message}`, "danger");
                UIElements.activityTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 2rem;">Error loading data.</td></tr>`;
            } finally {
                showSkeleton(false);
            }
        }
        
        function populateFilters() {
            const departments = [...new Set(allActivity.map(item => item.Department).filter(Boolean))];
            const deptFilter = UIElements.departmentFilter;
            deptFilter.innerHTML = '<option value="">All Departments</option>';
            departments.sort().forEach(dept => {
                const option = new Option(dept, dept);
                deptFilter.add(option);
            });
        }
        
        function applyFiltersAndRender() {
            const fromDateVal = document.getElementById('from-date').value;
            const toDateVal = document.getElementById('to-date').value;
            const department = UIElements.departmentFilter.value;
            const searchTerm = document.getElementById('search-user').value.toLowerCase().trim();

            let fromDate = fromDateVal ? new Date(fromDateVal) : null;
            let toDate = toDateVal ? new Date(toDateVal) : null;
            if (fromDate) fromDate.setHours(0,0,0,0);
            if (toDate) toDate.setHours(23, 59, 59, 999);

            filteredActivity = allActivity.filter(item => {
                const itemDate = new Date(item["Last View"]);
                const userMatch = !searchTerm || 
                    (item.User || '').toLowerCase().includes(searchTerm) ||
                    (item["User Email"] || '').toLowerCase().includes(searchTerm);

                return (!fromDate || itemDate >= fromDate) &&
                       (!toDate || itemDate <= toDate) &&
                       (!department || item.Department === department) &&
                       userMatch;
            });

            currentPage = 1;
            renderAllComponents();
        }

        function renderAllComponents() {
            updateKpiCards();
            renderCharts();
            renderActivityTable();
            renderTimeline();
            renderPagination();
            UIElements.totalRecords.textContent = `${filteredActivity.length} records found`;
        }

        function updateKpiCards() {
            // âœ… FIX: "Total Actions" now counts unique user-case interactions, not the sum of all views.
            const totalActions = filteredActivity.length;
            UIElements.kpiTotalActions.textContent = totalActions.toLocaleString();
            
            UIElements.kpiTotalDocs.textContent = [...new Set(filteredActivity.map(i => i.Case))].length.toLocaleString();
            
            const deptCounts = filteredActivity.reduce((acc, item) => {
                if(item.Department) acc[item.Department] = (acc[item.Department] || 0) + (item["View Count"] || 1);
                return acc;
            }, {});
            const topDept = Object.entries(deptCounts).sort((a, b) => b[1] - a[1])[0];
            UIElements.kpiActiveDept.textContent = topDept ? topDept[0] : 'N/A';
            
            const today = new Date().toLocaleDateString();
            const activeToday = new Set(allActivity
                .filter(i => new Date(i["Last View"]).toLocaleDateString() === today)
                .map(i => i["User Email"])).size;
            UIElements.kpiActiveUsers.textContent = activeToday.toLocaleString();
        }

        function renderActivityTable() {
            const tableBody = UIElements.activityTableBody;
            tableBody.innerHTML = '';
            
            if (filteredActivity.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 2rem;">No matching records found.</td></tr>`;
                return;
            }

            const startIndex = (currentPage - 1) * PAGE_SIZE;
            const endIndex = startIndex + PAGE_SIZE;
            const pageData = filteredActivity.slice(startIndex, endIndex);

            pageData.forEach(item => {
                const tr = document.createElement('tr');
                const initials = (item.User || 'U').split(' ').map(n => n[0]).join('').substring(0, 2);
                const roleClass = `role-${(item.Role || 'user').toLowerCase()}`;
                const statusClass = `status-${(item.Action || 'viewed').toLowerCase()}`;
                
                tr.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${escapeHtml(initials)}</div>
                            <div>
                                <div class="user-name">${escapeHtml(item.User)}</div>
                                <div class="user-email">${escapeHtml(item["User Email"])}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="role-badge ${roleClass}">${escapeHtml(item.Role)}</span></td>
                    <td><span class="status-badge ${statusClass}">${escapeHtml(item.Action)}</span></td>
                    <td>${escapeHtml(item.Department)}</td>
                    <td>${escapeHtml(item.Section)}</td>
                    <td>${escapeHtml(item.Case)}</td>
                    <td>${new Date(item["First View"]).toLocaleString()}</td>
                    <td>${new Date(item["Last View"]).toLocaleString()}</td>
                    <td><span class="view-count-badge">${item["View Count"] || 1}</span></td>
                `;
                tableBody.appendChild(tr);
            });
        }
        
        function renderTimeline() {
            const container = UIElements.timelineContainer;
            container.innerHTML = '';
            const recentItems = filteredActivity.slice(0, 5); // Based on filtered data
            if (recentItems.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No recent activity to display.</p>';
                return;
            }
            recentItems.forEach(item => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                timelineItem.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <div class="timeline-time">${new Date(item["Last View"]).toLocaleString()}</div>
                        <div class="timeline-text">
                            <span class="timeline-user">${escapeHtml(item.User)}</span> 
                            viewed "${escapeHtml(item.Case)}"
                            ${item["View Count"] > 1 ? `<span style="color: var(--primary-accent-light); font-weight: 600;">(${item["View Count"]} total views)</span>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(timelineItem);
            });
        }
        
        function renderPagination() {
            const totalPages = Math.ceil(filteredActivity.length / PAGE_SIZE) || 1;
            UIElements.pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            UIElements.prevBtn.disabled = currentPage === 1;
            UIElements.nextBtn.disabled = currentPage >= totalPages;
        }

        async function renderCharts() {
            // This function now uses the filtered data in memory, no need for new DB calls
            const chartColors = {
                primary: 'rgba(108, 93, 211, 0.8)', primaryLight: 'rgba(108, 93, 211, 0.4)',
                secondary: 'rgba(63, 140, 255, 0.8)', success: 'rgba(0, 182, 155, 0.8)',
                warning: 'rgba(255, 196, 84, 0.8)', textMuted: '#9CA3B3', bgCard: '#1A1C23'
            };
            Chart.defaults.color = chartColors.textMuted;
            const baseOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: chartColors.textMuted } } } };

            // Chart 1: Activity by Department
            const deptData = filteredActivity.reduce((acc, item) => {
                const dept = item.Department || 'N/A';
                acc[dept] = (acc[dept] || 0) + item["View Count"];
                return acc;
            }, {});
            createChart('activityByCategoryChart', 'doughnut', {
                labels: Object.keys(deptData),
                datasets: [{ data: Object.values(deptData), backgroundColor: [chartColors.primary, chartColors.secondary, chartColors.success, chartColors.warning], borderColor: chartColors.bgCard, borderWidth: 4 }]
            }, { ...baseOptions, cutout: '70%', plugins: { legend: { position: 'bottom' } } });

            // Chart 2: Top Viewed Cases
            const topCasesData = filteredActivity.reduce((acc, item) => {
                const caseTitle = item.Case;
                acc[caseTitle] = (acc[caseTitle] || 0) + item["View Count"];
                return acc;
            }, {});
            const sortedTopCases = Object.entries(topCasesData).sort((a,b) => b[1] - a[1]).slice(0, 5);
            createChart('topViewedArticlesChart', 'bar', {
                labels: sortedTopCases.map(d => d[0]),
                datasets: [{ label: 'Views', data: sortedTopCases.map(d => d[1]), backgroundColor: chartColors.primaryLight, borderColor: chartColors.primary, borderWidth: 2, borderRadius: 8 }]
            }, { ...baseOptions, indexAxis: 'y', plugins: { legend: { display: false } } });
            
            // Chart 3: Daily Activity
            const dailyData = filteredActivity.reduce((acc, item) => {
                const date = new Date(item["Last View"]).toLocaleDateString();
                acc[date] = (acc[date] || 0) + 1; // Count one action per record in the filtered list
                return acc;
            }, {});
            createChart('dailyActivityChart', 'line', {
                labels: Object.keys(dailyData).reverse(),
                datasets: [{ label: 'Actions', data: Object.values(dailyData).reverse(), borderColor: chartColors.primary, backgroundColor: chartColors.primaryLight, tension: 0.4, fill: true }]
            }, baseOptions);
        }

        function createChart(id, type, data, options) {
            if (charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id)?.getContext('2d');
            if (ctx) charts[id] = new Chart(ctx, { type, data, options });
        }
        
        function exportToCsv() {
            if (filteredActivity.length === 0) return showToast("No data to export.", "warning");
            const headers = ["User", "Role", "Action", "Department", "Section", "Case", "First View", "Last View", "View Count"];
            const rows = filteredActivity.map(i => [ 
                `"${i.User}"`, `"${i.Role}"`, `"${i.Action}"`, `"${i.Department}"`, `"${i.Section}"`, `"${i.Case}"`, 
                `"${new Date(i["First View"]).toISOString()}"`, 
                `"${new Date(i["Last View"]).toISOString()}"`, 
                i["View Count"] 
            ]);
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "employee_activity_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Exported successfully!", "success");
        }
        
        async function checkAccess() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error("Not logged in");
                
                const { data: userData, error } = await supabase.from('users').select('role').eq('id', user.id).single();
                if (error || !['admin', 'manager'].includes(userData?.role)) {
                    throw new Error("Access denied");
                }
                
                UIElements.dashboardContainer.style.visibility = "visible";
                await fetchData();

            } catch (err) {
                console.error(err.message);
                UIElements.restrictedCard.style.display = "flex";
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAccess();

            ['from-date', 'to-date', 'department', 'search-user'].forEach(id => {
                document.getElementById(id).addEventListener('input', applyFiltersAndRender);
            });
            
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                document.getElementById('from-date').value = '';
                document.getElementById('to-date').value = '';
                document.getElementById('department').value = '';
                document.getElementById('search-user').value = '';
                applyFiltersAndRender();
                showToast("Filters cleared.", "info");
            });
            
            document.getElementById('refresh-btn').addEventListener('click', () => {
                showToast("Refreshing data...", "info");
                fetchData();
            });

            document.getElementById('export-btn').addEventListener('click', exportToCsv);

            UIElements.prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderActivityTable();
                    renderPagination();
                }
            });

            UIElements.nextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredActivity.length / PAGE_SIZE);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderActivityTable();
                    renderPagination();
                }
            });
        });
    </script>

</body>
</html>
