<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>InfiniBase - Knowledge Base Insights</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  
  <style>
    :root {
      --primary-color: #6366f1;
      --primary-color-hover: #4f46e5;
      --text-color: #d1d5db;
      --text-color-muted: #9ca3af;
      --bg-color: #111827;
      --bg-color-alt: #1f2937;
      --border-color: #374151;
      --border-radius: 0.5rem;
      --border-radius-lg: 0.75rem;
      --header-height: 65px;
    }
    html, body {
      height: 100%; margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--bg-color); color: var(--text-color);
      font-size: 15px;
    }
    .page-wrapper {
      padding: 1.25rem 1.5rem;
      padding-top: calc(var(--header-height) + 1.25rem);
    }
    .page-header {
        position: fixed; top: 0; left: 0; right: 0;
        height: var(--header-height);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 1.5rem;
        background-color: rgba(31, 41, 55, 0.8);
        border-bottom: 1px solid var(--border-color);
        backdrop-filter: blur(8px); z-index: 100;
    }
    .page-header .header-title { display: flex; align-items: center; gap: 0.8rem; }
    .page-header .logo-icon { font-size: 1.6rem; color: var(--primary-color); }
    .page-header h1 { font-size: 1.5rem; font-weight: 600; color: white; margin: 0; }
    
    .button, button {
        background-color: var(--primary-color); color: white; border: 1px solid transparent;
        padding: 0.65rem 1.1rem; border-radius: var(--border-radius);
        cursor: pointer; font-size: 0.9rem; font-weight: 500;
        transition: all 0.2s; text-decoration: none;
        display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .button:hover, button:hover { 
        background-color: var(--primary-color-hover); 
        transform: translateY(-2px); 
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    .button-secondary { background-color: var(--bg-color-alt); color: var(--text-color); border-color: var(--border-color); }
    .button-secondary:hover { background-color: var(--border-color); color: white; }
    
    .card {
      background-color: var(--bg-color-alt); border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg); padding: 1.25rem; margin-bottom: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }
    .card:hover {
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        border-color: rgba(99, 102, 241, 0.5);
    }
    .card-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
    }
    .card-header h2 {
        font-size: 1.25rem; font-weight: 600; margin: 0;
        display: flex; align-items: center; gap: 0.75rem;
    }
    .card-header h2 i { color: var(--primary-color); }

    .summary-metrics {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem; margin-bottom: 1.5rem;
    }
    .metric-card {
        background-color: var(--bg-color-alt); border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg); padding: 1rem;
        display: flex; align-items: center; gap: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .metric-card:hover { transform: translateY(-4px); }
    .metric-card .icon { font-size: 1.5rem; color: var(--primary-color); }
    .metric-card .value { font-size: 1.75rem; font-weight: 700; }
    .metric-card .label { color: var(--text-color-muted); font-size: 0.9rem; }
    
    .filters-container { 
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        gap: 1rem; align-items: flex-end; 
    }
    .filters-container .form-group { margin-bottom: 0; }
    .filters-container .form-group label { font-size: 0.85rem; font-weight: 500; color: var(--text-color-muted); margin-bottom: 0.4rem; display: block; }
    .filters-container input, .filters-container select {
        width: 100%; padding: 0.7rem; border: 1px solid var(--border-color);
        border-radius: var(--border-radius); background-color: var(--bg-color);
        color: var(--text-color); font-size: 0.9rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .filters-container input:focus, .filters-container select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        outline: none;
    }
    .filter-actions { 
        grid-column: 1 / -1; display: flex; gap: 0.75rem; 
        padding-top: 1rem; justify-content: flex-start; 
    }

    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
    .chart-wrapper { position: relative; height: 320px; }

    .table-wrap { overflow-x: auto; max-height: 500px; border-radius: var(--border-radius); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; text-align: left; white-space: nowrap; }
    thead th { 
        background-color: #111827; color: var(--text-color-muted); 
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; 
        position: sticky; top: 0; z-index: 1; 
    }
    tbody tr { transition: background-color 0.2s; }
    tbody tr:hover { background-color: #2a3546; }
    td.unassigned { color: var(--text-color-muted); font-style: italic; }

    .pagination-controls { 
        display: flex; justify-content: flex-end; align-items: center; 
        gap: 1rem; margin-top: 1rem; font-size: 0.9rem; color: var(--text-color-muted); 
    }
    .pagination-controls button { padding: 0.4rem 0.8rem; }
    .pagination-controls button:disabled { background-color: var(--border-color); cursor: not-allowed; opacity: 0.5; }

    .spinner-overlay{ 
        position:fixed; inset:0; background:rgba(17,24,39,0.8); 
        display:flex; align-items:center; justify-content:center; z-index:1000; 
    }
    .spinner { width:50px; height:50px; border-radius:50%; border:4px solid var(--border-color); border-top-color:var(--primary-color); animation:spin 1s linear infinite; }
    @keyframes spin{ to{transform:rotate(360deg);} }
    
    .toast{ 
        position:fixed; top:20px; right:20px; padding:12px 16px; border-radius: var(--border-radius); 
        color:white; background-color: #ef4444; z-index:1100; display:flex; align-items:center; 
        gap:10px; cursor:pointer; opacity:0; transform:translateY(-10px); transition: all .3s; 
    }
    .toast.show { opacity:1; transform:translateY(0); }
    
    .access-restricted-container { 
        display: none; flex-direction: column; align-items: center; 
        justify-content: center; text-align: center; height: 100vh; width: 100%; 
    }
    .access-restricted-container .card { max-width: 450px; padding: 3rem; }
    .access-restricted-container .icon { font-size: 4rem; color: var(--primary-color); margin-bottom: 1.5rem; }
    .access-restricted-container h2 { font-size: 1.75rem; margin-bottom: 0.5rem; color: white; }
    .access-restricted-container p { color: var(--text-color-muted); margin-bottom: 2rem; }

    /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© */
    .refresh-indicator { 
        display: flex; align-items: center; gap: 0.5rem; 
        color: var(--text-color-muted); font-size: 0.9rem; 
    }
    .refresh-indicator.active { color: #22c55e; }
    .refresh-indicator.active i { animation: spin 1s linear infinite; }
    
    .quick-stats { 
        display: flex; gap: 1rem; margin-bottom: 1.5rem; 
        flex-wrap: wrap; 
    }
    .stat-badge { 
        background: var(--bg-color-alt); padding: 0.5rem 1rem; 
        border-radius: var(--border-radius); display: flex; 
        align-items: center; gap: 0.5rem; font-size: 0.9rem; 
    }
    .stat-badge i { color: var(--primary-color); }
    
    .table-summary {
        background: var(--bg-color); padding: 0.75rem 1rem; 
        border-radius: var(--border-radius); margin-bottom: 1rem; 
        font-size: 0.9rem; color: var(--text-color-muted);
    }
    .table-summary strong { color: var(--text-color); }
    
    .chart-toolbar {
        display: flex; justify-content: flex-end; gap: 0.5rem; 
        margin-bottom: 1rem; 
    }
    .chart-toolbar button { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    
    .export-options { display: flex; gap: 0.5rem; margin-left: auto; }
  </style>
</head>
<body>

<div id="dashboard" style="visibility: hidden;">
  <header class="page-header">
    <div class="header-title">
        <i class="fas fa-chart-pie logo-icon"></i>
        <h1>Knowledge Base Insights</h1>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <div class="refresh-indicator" id="refreshIndicator">
            <i class="fas fa-sync-alt"></i>
            <span>Last updated: <span id="lastUpdateTime">Just now</span></span>
        </div>
        <a href="app.html" class="button button-secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>
  </header>
  
  <div class="page-wrapper">
    <div id="toast" class="toast"></div>
    <div id="spinner" class="spinner-overlay" style="display: none;"><div class="spinner"></div></div>
    
    <div class="summary-metrics">
        <div class="metric-card"><i class="fas fa-file-alt icon"></i><div><div id="metric-total-articles" class="value">-</div><div class="label">Total Articles</div></div></div>
        <div class="metric-card"><i class="fas fa-eye icon"></i><div><div id="metric-total-views" class="value">-</div><div class="label">Total Views</div></div></div>
        <div class="metric-card"><i class="fas fa-star-half-alt icon"></i><div><div id="metric-avg-rating" class="value">-</div><div class="label">Average Rating</div></div></div>
        <div class="metric-card"><i class="fas fa-users icon"></i><div><div id="metric-active-users" class="value">-</div><div class="label">Active Users (Week)</div></div></div>
    </div>

    <div class="card">
        <div class="filters-container">
            <div class="form-group"><label for="filterDateFrom">From Date</label><input id="filterDateFrom" type="date"></div>
            <div class="form-group"><label for="filterDateTo">To Date</label><input id="filterDateTo" type="date"></div>
            <div class="form-group"><label for="filterEmployee">Employee</label><select id="filterEmployee"><option value="">All Employees</option></select></div>
            <div class="form-group"><label for="filterCase">Case / Article Title</label><input id="filterCase" type="text" placeholder="Enter title to search..."></div>
            <div class="filter-actions">
                <button id="applyFiltersBtn" class="button"><i class="fas fa-filter"></i> Apply Filters</button>
                <button id="clearFiltersBtn" class="button-secondary"><i class="fas fa-times"></i> Clear</button>
                <div class="export-options">
                    <button id="exportBtn" class="button-secondary"><i class="fas fa-file-csv"></i> Export All Data</button>
                    <button id="exportPdfBtn" class="button-secondary"><i class="fas fa-file-pdf"></i> PDF Report</button>
                </div>
            </div>
        </div>
        <div id="filterSummary" class="table-summary" style="display: none;"></div>
    </div>
    
    <div class="insights-grid">
        <div class="card">
            <div class="card-header" style="border: none; padding-bottom: 0;">
                <h2><i class="fas fa-chart-bar"></i>Activity by Section</h2>
                <div class="chart-toolbar">
                    <button class="button-secondary chart-export" data-chart="activityBySectionChart"><i class="fas fa-download"></i></button>
                </div>
            </div>
            <div class="chart-wrapper"><canvas id="activityBySectionChart"></canvas></div>
        </div>
        <div class="card">
            <div class="card-header" style="border: none; padding-bottom: 0;">
                <h2><i class="fas fa-fire"></i>Top Viewed Articles</h2>
                <div class="chart-toolbar">
                    <button class="button-secondary chart-export" data-chart="topArticlesChart"><i class="fas fa-download"></i></button>
                </div>
            </div>
            <div class="chart-wrapper"><canvas id="topArticlesChart"></canvas></div>
        </div>
    </div>

    <div class="card">
      <div class="card-header">
          <h2><i class="fas fa-newspaper"></i>Article Performance</h2>
          <div class="quick-stats" id="articleStats"></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Article Title</th><th>Total Views</th><th>Avg Rating (1=Helpful)</th><th>Total Feedbacks</th><th>Last Viewed (Egypt Time)</th><th>Last Viewed By</th></tr></thead>
          <tbody id="articleInsightsTable"></tbody>
        </table>
      </div>
      <div class="pagination-controls" id="paginationArticles"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-users"></i>User Engagement</h2>
            <div class="quick-stats" id="userStats"></div>
        </div>
        <div class="table-wrap">
            <table>
            <thead><tr><th>User Name</th><th>Email</th><th>Total Articles Viewed</th><th>Unique Articles Viewed</th><th>Average Feedback Rating</th><th>Last Activity (Egypt Time)</th></tr></thead>
            <tbody id="userInsightsTable"></tbody>
            </table>
        </div>
        <div class="pagination-controls" id="paginationUsers"></div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-folder-tree"></i>Section Performance</h2>
            <div class="quick-stats" id="sectionStats"></div>
        </div>
        <div class="table-wrap">
            <table>
            <thead><tr><th>Section Name</th><th>Total Articles</th><th>Total Views</th><th>Average Rating</th><th>Total Feedbacks</th><th>Last Activity (Egypt Time)</th></tr></thead>
            <tbody id="sectionInsightsTable"></tbody>
            </table>
        </div>
        <div class="pagination-controls" id="paginationSections"></div>
    </div>

  </div>
</div>

<div id="restricted-card" class="access-restricted-container">
    <div class="card">
        <div class="icon">üîí</div><h2>Access Restricted</h2>
        <p>This page is available for administrators only.</p>
        <a href="app.html" class="button">Back to Dashboard</a>
    </div>
</div>

<footer style="padding: 1.5rem; text-align: center; color: var(--text-color-muted); font-size: 0.85rem;">
  <span>¬© <script>document.write(new Date().getFullYear())</script> InfiniBase.Elmenisy.</span>
</footer>

  <script type="module">
    import { supabase } from './supabase.js';

    let allInsights = { articles: [], users: [], sections: [], overall: {} };
    let filteredInsights = { articles: [], users: [], sections: [] };
    let paginationState = { articles: 1, users: 1, sections: 1 };
    const ROWS_PER_PAGE = 5;

    const toast = document.getElementById('toast');
    const spinner = document.getElementById('spinner');

    let activityBySectionChart, topArticlesChart = null;

    function showSpinner(show) { spinner.style.display = show ? 'flex' : 'none'; }
    function showToast(message, isError = true) {
      toast.textContent = message;
      toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }
    
    function formatToEgyptTime(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        return date.toLocaleString('en-EG', {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: 'numeric', minute: '2-digit', hour12: true,
            timeZone: 'Africa/Cairo'
        });
    }

    function updateLastUpdateTime() {
        const now = new Date();
        document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString('en-GB', {timeZone: 'Africa/Cairo', hour:'2-digit', minute:'2-digit'});
        const indicator = document.getElementById('refreshIndicator');
        indicator.classList.add('active');
        setTimeout(() => indicator.classList.remove('active'), 2000);
    }

    function updateQuickStats() {
        // Article Stats
        const articleStats = document.getElementById('articleStats');
        const totalArticles = filteredInsights.articles.length;
        const totalArticleViews = filteredInsights.articles.reduce((sum, a) => sum + (a.total_views || 0), 0);
        const avgArticleRating = filteredInsights.articles.reduce((sum, a) => sum + (a.avg_rating || 0), 0) / (totalArticles || 1);
        
        articleStats.innerHTML = `
            <div class="stat-badge"><i class="fas fa-file-alt"></i> ${totalArticles} Articles</div>
            <div class="stat-badge"><i class="fas fa-eye"></i> ${totalArticleViews} Total Views</div>
            <div class="stat-badge"><i class="fas fa-star"></i> ${avgArticleRating.toFixed(2)} Avg Rating</div>
        `;

        // User Stats
        const userStats = document.getElementById('userStats');
        const totalUsers = filteredInsights.users.length;
        const totalUserViews = filteredInsights.users.reduce((sum, u) => sum + (u.total_articles_viewed || 0), 0);
        
        userStats.innerHTML = `
            <div class="stat-badge"><i class="fas fa-users"></i> ${totalUsers} Users</div>
            <div class="stat-badge"><i class="fas fa-eye"></i> ${totalUserViews} Total Views</div>
        `;

        // Section Stats
        const sectionStats = document.getElementById('sectionStats');
        const totalSections = filteredInsights.sections.length;
        const totalSectionViews = filteredInsights.sections.reduce((sum, s) => sum + (s.total_views || 0), 0);
        
        sectionStats.innerHTML = `
            <div class="stat-badge"><i class="fas fa-folder"></i> ${totalSections} Sections</div>
            <div class="stat-badge"><i class="fas fa-eye"></i> ${totalSectionViews} Total Views</div>
        `;
    }

    function updateFilterSummary() {
        const summaryEl = document.getElementById('filterSummary');
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;
        const employee = document.getElementById('filterEmployee').value;
        const caseTitle = document.getElementById('filterCase').value;
        
        const activeFilters = [];
        if (dateFrom) activeFilters.push(`From: ${dateFrom}`);
        if (dateTo) activeFilters.push(`To: ${dateTo}`);
        if (employee) activeFilters.push(`Employee: ${employee}`);
        if (caseTitle) activeFilters.push(`Case: "${caseTitle}"`);
        
        if (activeFilters.length > 0) {
            summaryEl.innerHTML = `<strong>Active Filters:</strong> ${activeFilters.join(' ‚Ä¢ ')}`;
            summaryEl.style.display = 'block';
        } else {
            summaryEl.style.display = 'none';
        }
    }

    function createChart(ctx, type, labels, data, dataLabel, backgroundColors) {
        if (!ctx) return null;
        const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        const ticksColor = getComputedStyle(document.documentElement).getPropertyValue('--text-color-muted').trim();
        const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
        
        const defaultOptions = { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: type === 'doughnut' ? 'right' : 'top', 
                    labels: { 
                        color: legendColor, 
                        font: { size: 14 } 
                    } 
                },
                tooltip: { 
                    bodyFont: { size: 14 }, 
                    titleFont: { size: 16 },
                    backgroundColor: '#111827',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: gridColor,
                    borderWidth: 1
                }
            }
        };
        
        if (type === 'bar') {
            return new Chart(ctx, { 
                type, 
                data: { 
                    labels, 
                    datasets: [{ 
                        label: dataLabel, 
                        data, 
                        backgroundColor: backgroundColors,
                        borderRadius: 4
                    }] 
                }, 
                options: { 
                    ...defaultOptions, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: ticksColor }, 
                            grid: { color: gridColor } 
                        }, 
                        x: { 
                            ticks: { color: ticksColor }, 
                            grid: { display: false } 
                        } 
                    } 
                } 
            });
        }
        return new Chart(ctx, { 
            type, 
            data: { 
                labels, 
                datasets: [{ 
                    label: dataLabel, 
                    data, 
                    backgroundColor: backgroundColors,
                    borderColor: gridColor,
                    borderWidth: 2
                }] 
            }, 
            options: defaultOptions 
        });
    }
    
    function renderPaginatedTable(tableKey, data, containerId, paginationId) {
        const page = paginationState[tableKey];
        const totalPages = Math.ceil(data.length / ROWS_PER_PAGE);
        const start = (page - 1) * ROWS_PER_PAGE;
        const end = start + ROWS_PER_PAGE;
        const paginatedData = data.slice(start, end);

        const container = document.getElementById(containerId);
        let tableHtml;
        if (tableKey === 'articles') {
            tableHtml = paginatedData.map(item => `
                <tr>
                    <td>${escapeHtml(item.article_title)}</td>
                    <td>${item.total_views}</td>
                    <td>${item.avg_rating ? item.avg_rating.toFixed(2) : 'N/A'}</td>
                    <td>${item.total_feedbacks}</td>
                    <td>${escapeHtml(formatToEgyptTime(item.last_view_egypt))}</td>
                    <td>${escapeHtml(item.last_viewed_by)}</td>
                </tr>
            `).join('');
        } else if (tableKey === 'users') {
            tableHtml = paginatedData.map(item => `
                <tr>
                    <td>${escapeHtml(item.user_name)}</td>
                    <td>${escapeHtml(item.user_email)}</td>
                    <td>${item.total_articles_viewed}</td>
                    <td>${item.unique_articles_viewed}</td>
                    <td>${item.avg_feedback_rating ? item.avg_feedback_rating.toFixed(2) : 'N/A'}</td>
                    <td>${escapeHtml(formatToEgyptTime(item.last_activity_egypt))}</td>
                </tr>
            `).join('');
        } else { // sections
            tableHtml = paginatedData.map(item => `
                <tr class="${!item.section_name ? 'unassigned-row' : ''}">
                    <td class="${!item.section_name ? 'unassigned' : ''}">${escapeHtml(item.section_name || 'Unassigned')}</td>
                    <td>${item.total_articles}</td>
                    <td>${item.total_views}</td>
                    <td>${item.avg_rating ? item.avg_rating.toFixed(2) : 'N/A'}</td>
                    <td>${item.total_feedbacks}</td>
                    <td>${escapeHtml(formatToEgyptTime(item.last_activity_egypt))}</td>
                </tr>
            `).join('');
        }
        container.innerHTML = tableHtml || `<tr><td colspan="6" style="text-align:center;">No data to display.</td></tr>`;

        document.getElementById(paginationId).innerHTML = `
            <span>Page ${page} of ${totalPages || 1}</span>
            <button class="button-secondary" onclick="window.changePage('${tableKey}', -1)" ${page === 1 ? 'disabled' : ''}>Previous</button>
            <button class="button-secondary" onclick="window.changePage('${tableKey}', 1)" ${page === totalPages || totalPages === 0 ? 'disabled' : ''}>Next</button>
        `;
    }
    
    window.changePage = (tableKey, direction) => {
        const totalPages = Math.ceil(filteredInsights[tableKey].length / ROWS_PER_PAGE);
        let newPage = paginationState[tableKey] + direction;
        if (newPage >= 1 && newPage <= totalPages) {
            paginationState[tableKey] = newPage;
            renderAllTables();
        }
    }
    
    function renderAllTables() {
        renderPaginatedTable('articles', filteredInsights.articles, 'articleInsightsTable', 'paginationArticles');
        renderPaginatedTable('users', filteredInsights.users, 'userInsightsTable', 'paginationUsers');
        renderPaginatedTable('sections', filteredInsights.sections, 'sectionInsightsTable', 'paginationSections');
        updateQuickStats();
    }

    function renderSummaryMetrics(data) {
        document.getElementById('metric-total-articles').textContent = data.total_articles || 0;
        document.getElementById('metric-total-views').textContent = data.total_views_all || 0;
        document.getElementById('metric-avg-rating').textContent = data.avg_feedback_rating ? data.avg_feedback_rating.toFixed(2) : 'N/A';
        document.getElementById('metric-active-users').textContent = data.active_users_this_week || 0;
    }

    function renderCharts() {
        // Activity by Section Chart
        if (activityBySectionChart) activityBySectionChart.destroy();
        const sectionLabels = allInsights.sections.map(s => s.section_name || 'Unassigned');
        const sectionViews = allInsights.sections.map(s => s.total_views);
        const sectionCtx = document.getElementById('activityBySectionChart').getContext('2d');
        activityBySectionChart = createChart(
            sectionCtx, 
            'doughnut', 
            sectionLabels, 
            sectionViews, 
            'Total Views', 
            ['#6366F1', '#22C55E', '#FBBF24', '#EC4899', '#38BDF8', '#8B5CF6']
        );

        // Top Articles Chart
        if (topArticlesChart) topArticlesChart.destroy();
        const topArticles = [...allInsights.articles].sort((a,b) => b.total_views - a.total_views).slice(0, 5);
        const articleLabels = topArticles.map(a => a.article_title.length > 20 ? a.article_title.substring(0, 20) + '...' : a.article_title);
        const articleViews = topArticles.map(a => a.total_views);
        const articlesCtx = document.getElementById('topArticlesChart').getContext('2d');
        topArticlesChart = createChart(
            articlesCtx, 
            'bar', 
            articleLabels, 
            articleViews, 
            'Total Views', 
            '#6366F1'
        );
    }

    function applyFilters() {
        const dateFromStr = document.getElementById('filterDateFrom').value;
        const dateToStr = document.getElementById('filterDateTo').value;
        const employee = document.getElementById('filterEmployee').value;
        const caseTitle = document.getElementById('filterCase').value.trim().toLowerCase();

        const dateFrom = dateFromStr ? new Date(dateFromStr) : null;
        if(dateFrom) dateFrom.setHours(0, 0, 0, 0);
        const dateTo = dateToStr ? new Date(dateToStr) : null;
        if(dateTo) dateTo.setHours(23, 59, 59, 999);

        const dateFilter = (itemDateStr) => {
            if (!itemDateStr) return !dateFrom && !dateTo;
            const itemDate = new Date(itemDateStr);
            return (!dateFrom || itemDate >= dateFrom) && (!dateTo || itemDate <= dateTo);
        };

        filteredInsights.articles = allInsights.articles.filter(item => 
            (!caseTitle || item.article_title.toLowerCase().includes(caseTitle)) && dateFilter(item.last_view_egypt)
        );
        filteredInsights.users = allInsights.users.filter(item => 
            (!employee || item.user_name === employee) && dateFilter(item.last_activity_egypt)
        );
        filteredInsights.sections = allInsights.sections.filter(item => dateFilter(item.last_activity_egypt));

        paginationState = { articles: 1, users: 1, sections: 1 };
        renderAllTables();
        updateFilterSummary();
    }
    
    function clearFilters() {
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        document.getElementById('filterEmployee').value = '';
        document.getElementById('filterCase').value = '';
        filteredInsights = JSON.parse(JSON.stringify(allInsights)); // Deep copy
        paginationState = { articles: 1, users: 1, sections: 1 };
        renderAllTables();
        updateFilterSummary();
    }
    
    function exportCSV() {
        let csvContent = "data:text/csv;charset=utf-8,";
        const generateCsvSection = (title, headers, data) => {
            let sectionCsv = `${title}\n`;
            sectionCsv += headers.map(h => h.key).join(',') + '\n';
            data.forEach(item => {
                const row = headers.map(header => {
                    let value = item[header.key] || '';
                    if (header.formatter) value = header.formatter(value);
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                sectionCsv += row.join(',') + '\n';
            });
            return sectionCsv + '\n';
        };

        csvContent += generateCsvSection("Article Performance", [
            {key: 'article_title'}, {key: 'total_views'}, {key: 'avg_rating'}, {key: 'total_feedbacks'}, 
            {key: 'last_view_egypt', formatter: formatToEgyptTime}, {key: 'last_viewed_by'}
        ], filteredInsights.articles);
        csvContent += generateCsvSection("User Engagement", [
            {key: 'user_name'}, {key: 'user_email'}, {key: 'total_articles_viewed'}, {key: 'unique_articles_viewed'}, 
            {key: 'avg_feedback_rating'}, {key: 'last_activity_egypt', formatter: formatToEgyptTime}
        ], filteredInsights.users);
        csvContent += generateCsvSection("Section Performance", [
            {key: 'section_name'}, {key: 'total_articles'}, {key: 'total_views'}, {key: 'avg_rating'}, 
            {key: 'total_feedbacks'}, {key: 'last_activity_egypt', formatter: formatToEgyptTime}
        ], filteredInsights.sections);
        
        const link = document.createElement("a");
        link.href = encodeURI(csvContent);
        link.download = "infinibase_insights_report.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('CSV exported successfully', false);
    }
    
    function populateUserFilter(users) {
        const select = document.getElementById('filterEmployee');
        [...new Map(users.map(item => [item['user_name'], item])).values()].forEach(user => {
            if (user.user_name) {
                const option = document.createElement('option');
                option.value = user.user_name;
                option.textContent = user.user_name;
                select.appendChild(option);
            }
        });
    }

    async function fetchData() {
      showSpinner(true);
      try {
        const [articles, users, sections, overall] = await Promise.all([
            supabase.from('v_article_insights').select('*'),
            supabase.from('v_user_insights').select('*'),
            supabase.from('v_section_insights').select('*'),
            supabase.from('v_overall_insights').select('*').single()
        ]);

        if (articles.error) throw new Error(`Article Insights: ${articles.error.message}`);
        if (users.error) throw new Error(`User Insights: ${users.error.message}`);
        if (sections.error) throw new Error(`Section Insights: ${sections.error.message}`);
        if (overall.error) throw new Error(`Overall Insights: ${overall.error.message}`);
        
        allInsights = {
            articles: articles.data || [],
            users: users.data || [],
            sections: sections.data || [],
            overall: overall.data || {}
        };
        
        filteredInsights = JSON.parse(JSON.stringify(allInsights));
        
        populateUserFilter(allInsights.users);
        renderSummaryMetrics(allInsights.overall);
        renderAllTables();
        renderCharts();
        updateLastUpdateTime();

      } catch (e) {
        showToast(`Failed to load data: ${e.message}`);
      } finally {
        showSpinner(false);
      }
    }

    async function checkAdminAccess() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Not logged in');
        
        const { data, error } = await supabase.from('users').select('role').eq('id', user.id).single();
        if (error || data?.role !== 'admin') throw new Error('Access denied');
        
        document.getElementById('dashboard').style.visibility = 'visible';
        await fetchData();

        supabase.channel('public-insights-realtime')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'activity_log' }, (payload) => fetchData())
          .on('postgres_changes', { event: '*', schema: 'public', table: 'kb_feedback' }, (payload) => fetchData())
          .subscribe();
      } catch (e) {
        document.getElementById('restricted-card').style.display = 'flex';
      }
    }

    document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    document.getElementById('exportPdfBtn').addEventListener('click', () => {
        showToast('PDF export feature coming soon', true);
    });

    // Chart export buttons
    document.querySelectorAll('.chart-export').forEach(btn => {
        btn.addEventListener('click', () => {
            showToast('Chart export feature coming soon', true);
        });
    });

    document.addEventListener('DOMContentLoaded', checkAdminAccess);
  </script>

</body>
</html>
