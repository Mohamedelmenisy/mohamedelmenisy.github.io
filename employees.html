<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Employees ‚Äî InfiniBase</title>

  <!-- favicon / logo small preview -->
  <link rel="icon" href="favicon.png" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Basic fonts + reset -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;        /* dark page background */
      --card:#0f1724;      /* card background */
      --muted:#9ca3af;
      --accent:#6366f1;
      --surface-2: rgba(255,255,255,0.02);
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --text:#e5e7eb;
      --shadow: 0 8px 30px rgba(2,6,23,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    .full-height{min-height:100vh;display:flex;flex-direction:column}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:40px;height:40px;border-radius:8px;display:block}
    .brand h1{margin:0;font-size:18px;font-weight:800;color:var(--accent)}
    .header-actions{display:flex;gap:10px;align-items:center}

    .container{width:100%;max-width:1300px;margin:22px auto;padding:0 18px;flex:1 0 auto}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
    .btn.warn{background:#ef4444}
    .flex{display:flex}
    .gap-8{gap:8px}
    .gap-12{gap:12px}
    .cols-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .cols-2{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    input,select,textarea{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--text);outline:none}
    input::placeholder{color:rgba(255,255,255,0.25)}
    .table-wrap{overflow:auto;border-radius:8px}
    table{width:100%;min-width:1000px;border-collapse:collapse}
    th{background:transparent;color:var(--muted);font-size:12px;padding:12px 14px;text-align:left;letter-spacing:0.02em;text-transform:uppercase}
    td{padding:12px 14px;border-top:1px solid rgba(255,255,255,0.02);font-size:14px;color:#cbd5e1}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .role-admin{background:rgba(99,102,241,0.12);color:#6366f1;border:1px solid rgba(99,102,241,0.12)}
    .role-agent{background:rgba(16,185,129,0.06);color:#10b981;border:1px solid rgba(16,185,129,0.06)}
    .role-manager{background:rgba(250,204,21,0.06);color:#f59e0b;border:1px solid rgba(250,204,21,0.06)}
    .online{color:#34d399;font-weight:700}
    .offline{color:var(--muted)}
    .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;color:var(--text);cursor:pointer}
    .actions-col{display:flex;gap:8px;align-items:center}

    /* overlay + spinner + toast */
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:1200;visibility:hidden;opacity:0;transition:opacity .18s}
    .overlay.show{visibility:visible;opacity:1}
    .spinner{width:72px;height:72px;border-radius:50%;border:6px solid rgba(255,255,255,0.05);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed;top:18px;right:18px;z-index:1300;display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:12px;color:white;box-shadow:0 10px 40px rgba(0,0,0,0.6);background:rgba(20,20,20,0.9);transform-origin:right top;opacity:0;pointer-events:none;transition:opacity .18s,transform .18s}
    .toast.show{opacity:1;pointer-events:auto;transform:translateY(0)}
    .toast.hide{opacity:0;transform:translateY(-8px)}
    .legend-swatch{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:8px;vertical-align:middle}

    /* responsive table -> cards */
    @media (max-width:780px){
      .cols-3{grid-template-columns:1fr}
      .cols-2{grid-template-columns:1fr}
      table, thead, tbody, th, td, tr { display:block; }
      thead{display:none}
      tr{margin-bottom:10px;border-radius:8px;padding:12px;background:var(--surface-2)}
      td{padding:6px 0;border:none}
      td::before{font-weight:700;display:inline-block;width:110px;color:var(--muted);font-size:13px}
      td:nth-of-type(1)::before{content:"Name"}
      td:nth-of-type(2)::before{content:"Email"}
      td:nth-of-type(3)::before{content:"Role"}
      td:nth-of-type(4)::before{content:"Status"}
      td:nth-of-type(5)::before{content:"Last Seen"}
      td:nth-of-type(6)::before{content:"Last Activity"}
      td:nth-of-type(7)::before{content:"Action"}
    }

    footer{padding:10px 18px;text-align:center;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,0.02)}
    /* subtle focus */
    input:focus,select:focus,button:focus{box-shadow:0 4px 18px rgba(99,102,241,0.08);border-color:rgba(99,102,241,0.14)}
  </style>
</head>
<body class="full-height">

<header>
  <div class="brand">
    <img src="https://via.placeholder.com/56x56.png?text=IB" alt="IB logo" />
    <div>
      <h1>InfiniBase</h1>
      <div class="muted small">Employees Management</div>
    </div>
  </div>

  <div class="header-actions">
    <a id="backToDashboard" class="btn ghost" href="app.html">‚Üê Back to Dashboard</a>
    <button id="exportCsvTop" class="btn">Export CSV</button>
  </div>
</header>

<main class="container">
  <!-- Page title -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin:18px 0 12px 0;">
    <div>
      <h2 style="margin:0;font-size:20px;font-weight:800;color:var(--accent)">Employees Directory</h2>
      <div class="muted">Live roster, role management, online status and activity ‚Äî managed by admins.</div>
    </div>
  </div>

  <!-- Main card -->
  <div class="card" style="padding:18px;">
    <!-- Filters -->
    <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;align-items:end">
      <div style="flex:1;min-width:220px">
        <label class="muted small">Search</label>
        <input id="search" placeholder="Name, email, last activity..." />
      </div>

      <div style="min-width:160px">
        <label class="muted small">Role</label>
        <select id="roleFilter">
          <option value="all">All Roles</option>
          <option value="admin">Admin</option>
          <option value="agent">Agent</option>
          <option value="manager">Manager</option>
        </select>
      </div>

      <div style="min-width:140px">
        <label class="muted small">Status</label>
        <select id="statusFilter">
          <option value="all">All</option>
          <option value="online">Online</option>
          <option value="offline">Offline</option>
        </select>
      </div>

      <div style="min-width:160px">
        <label class="muted small">Last Seen</label>
        <select id="timeFilter">
          <option value="all">All time</option>
          <option value="1d">Last 24 hours</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
        </select>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;">
        <button id="clearFilters" class="btn ghost">Clear</button>
        <button id="applyFilters" class="btn">Apply</button>
      </div>
    </div>

    <!-- Stats & Charts -->
    <div class="cols-3" style="margin-bottom:14px;">
      <div class="card">
        <div class="muted">Total Employees</div>
        <div id="totalCount" style="font-weight:800;font-size:20px;margin-top:6px">0</div>
      </div>
      <div class="card">
        <div class="muted">Online Now</div>
        <div id="onlineCount" style="font-weight:800;font-size:20px;margin-top:6px">0</div>
      </div>
      <div class="card">
        <div class="muted">Admins</div>
        <div id="adminCount" style="font-weight:800;font-size:20px;margin-top:6px">0</div>
      </div>
    </div>

    <div class="cols-2" style="margin-bottom:10px;">
      <div class="card" style="min-height:280px;">
        <div class="muted">Roles Distribution</div>
        <canvas id="rolesChart" height="160" style="margin-top:8px"></canvas>
        <div style="margin-top:8px" class="muted small">
          <span class="legend-swatch" style="background:#60a5fa"></span> Admin
          <span style="margin-left:10px" class="legend-swatch" style="background:#f97316"></span> Manager
          <span style="margin-left:10px" class="legend-swatch" style="background:#f472b6"></span> Agent
        </div>
      </div>
      <div class="card" style="min-height:280px;">
        <div class="muted">Active (last 7 days)</div>
        <canvas id="activeChart" height="160" style="margin-top:8px"></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrap card" style="margin-top:12px">
      <table role="table" aria-label="Employees table">
        <thead>
          <tr>
            <th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Last Seen</th><th>Last Activity</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="employeesBody">
          <tr><td colspan="7" class="muted" style="text-align:center;padding:20px 0">Loading employees...</td></tr>
        </tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div style="color:var(--muted);font-size:13px">Showing <span id="showingCount">0</span> results</div>
      <div style="display:flex;gap:8px">
        <button id="loadMore" class="btn ghost">Load More</button>
      </div>
    </div>

  </div>

  <!-- Admin-only restricted card (shows when not admin) -->
  <div id="restrictedCard" class="card" style="margin-top:22px;display:none;align-items:center;justify-content:center;text-align:center;padding:28px">
    <div style="font-size:48px;margin-bottom:8px">üîí</div>
    <div style="font-weight:800;font-size:18px">Access Restricted</div>
    <div class="muted" style="margin-top:6px">This page is visible to administrators only.</div>
    <div style="margin-top:12px"><a href="app.html" class="btn ghost">Go Back</a></div>
  </div>

</main>

<footer>
  ¬© <span id="year"></span> InfiniBase ‚Äî Employees
</footer>

<!-- overlay spinner & toast -->
<div id="overlay" class="overlay"><div class="spinner" aria-hidden="true"></div></div>
<div id="toast" class="toast hide"></div>

<!-- ----- SCRIPT ----- -->
<script type="module">
  // import your supabase client (you already have supabase.js)
  import { supabase } from './supabase.js';

  // --- state ---
  let employees = [];
  let filtered = [];
  let pageSize = 25;
  let currentPage = 1;
  let isAdmin = false;
  let rolesChart = null, activeChart = null;

  // DOM refs
  const employeesBody = document.getElementById('employeesBody');
  const totalCountEl = document.getElementById('totalCount');
  const onlineCountEl = document.getElementById('onlineCount');
  const adminCountEl = document.getElementById('adminCount');
  const overlay = document.getElementById('overlay');
  const toastEl = document.getElementById('toast');
  const rolesChartCtx = document.getElementById('rolesChart').getContext('2d');
  const activeChartCtx = document.getElementById('activeChart').getContext('2d');
  const showingCount = document.getElementById('showingCount');
  const restrictedCard = document.getElementById('restrictedCard');

  // filters
  const searchInput = document.getElementById('search');
  const roleFilter = document.getElementById('roleFilter');
  const statusFilter = document.getElementById('statusFilter');
  const timeFilter = document.getElementById('timeFilter');
  const applyBtn = document.getElementById('applyFilters');
  const clearBtn = document.getElementById('clearFilters');
  const exportBtnTop = document.getElementById('exportCsvTop');
  const loadMoreBtn = document.getElementById('loadMore');

  // UI helpers
  function showOverlay(show=true){ overlay.classList.toggle('show', !!show); }
  function showToast(msg, type='info', time=3500){
    toastEl.classList.remove('hide'); toastEl.classList.add('show');
    toastEl.innerHTML = `<strong style="margin-right:8px">${type==='success'?'‚úÖ':type==='warn'?'‚ö†Ô∏è':'‚ÑπÔ∏è'}</strong><div>${msg}</div>`;
    setTimeout(()=>{ toastEl.classList.remove('show'); toastEl.classList.add('hide'); }, time);
  }
  function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function formatDateTime(v){ if(!v) return '-'; try{ const d = new Date(v); return d.toLocaleString(); }catch(e){ return v; } }
  function isOnline(lastSeen){ if(!lastSeen) return false; const diff = (Date.now() - new Date(lastSeen).getTime())/1000; return diff < 120; }
  function roleBadge(role){ role = (role||'').toLowerCase(); if(role==='admin') return `<span class="badge role-admin">Admin</span>`; if(role==='manager') return `<span class="badge role-manager">Manager</span>`; return `<span class="badge role-agent">Agent</span>`; }

  // fetch employees from 'users' table and attach last activity
  async function fetchEmployees(){
    showOverlay(true);
    try{
      const { data, error } = await supabase.from('users').select('id,name,email,role,last_seen').order('name',{ascending:true});
      if(error){ console.error('fetch users', error); employees = []; showToast('Failed to load users','warn'); return; }
      const ids = data.map(d=>d.id);
      let acts = [];
      if(ids.length){
        const res = await supabase.from('activity_log').select('user_id,action,timestamp').in('user_id', ids).order('timestamp',{ascending:false});
        acts = res.data || [];
      }
      const lastMap = {};
      for(const a of acts){
        if(!lastMap[a.user_id]) lastMap[a.user_id] = a;
      }
      const enriched = data.map(u => {
        const last = lastMap[u.id];
        return { ...u, last_activity: last ? `${last.action} @ ${formatDateTime(last.timestamp)}` : '-' };
      });
      employees = enriched;
      applyFilters();
      updateStats();
      updateCharts();
    }catch(e){ console.error(e); showToast('Error fetching employees','error'); }
    finally{ showOverlay(false); }
  }

  function updateStats(){
    totalCountEl.textContent = employees.length;
    onlineCountEl.textContent = employees.filter(e=>isOnline(e.last_seen)).length;
    adminCountEl.textContent = employees.filter(e=> (e.role||'').toLowerCase() === 'admin').length;
  }

  // charts
  function updateCharts(){
    // roles
    const counts = { admin:0, manager:0, agent:0, other:0 };
    for(const u of employees){ const r=(u.role||'').toLowerCase(); if(counts[r]!==undefined) counts[r]++; else counts.other++; }
    const labels = ['Admin','Manager','Agent','Other'];
    const values = [counts.admin, counts.manager, counts.agent, counts.other];
    if(rolesChart) rolesChart.destroy();
    rolesChart = new Chart(rolesChartCtx, {
      type:'doughnut',
      data:{ labels, datasets:[{ data: values, backgroundColor:['#60a5fa','#f97316','#f472b6','#fbbf24'] }] },
      options:{ plugins:{legend:{position:'bottom'}}, maintainAspectRatio:false }
    });

    // active last 7 days (simple count: last_activity includes date string)
    const days = [];
    for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); days.push(d.toISOString().slice(0,10)); }
    const dayCounts = days.map(day => employees.filter(u => (u.last_activity||'').includes(day)).length);
    if(activeChart) activeChart.destroy();
    activeChart = new Chart(activeChartCtx, {
      type:'line',
      data:{ labels: days, datasets:[{ label:'Active users', data: dayCounts, borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.08)', fill:true }]},
      options:{ scales:{ y:{ beginAtZero:true, precision:0 } }, plugins:{legend:{display:false}} , maintainAspectRatio:false }
    });
  }

  // render table (paginated)
  function renderTable(list){
    employeesBody.innerHTML = '';
    const totalToShow = Math.min(list.length, currentPage * pageSize);
    showingCount.textContent = totalToShow + ' of ' + list.length;
    if(!list.length){ employeesBody.innerHTML = `<tr><td colspan="7" class="muted" style="text-align:center;padding:18px 0">No results</td></tr>`; return; }
    for(let i=0;i<totalToShow;i++){
      const u = list[i];
      const online = isOnline(u.last_seen);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(u.name||'-')}</td>
        <td class="muted">${escapeHtml(u.email||'-')}</td>
        <td>${roleBadge(u.role)}</td>
        <td>${online?'<span class="online">Online</span>':'<span class="offline">Offline</span>'}</td>
        <td class="muted">${formatDateTime(u.last_seen)}</td>
        <td class="muted">${escapeHtml(u.last_activity||'-')}</td>
        <td class="actions-col">${isAdmin ? `<select data-id="${u.id}" class="small role-select"><option value="agent">Agent</option><option value="manager">Manager</option><option value="admin">Admin</option></select>` : '-'}</td>
      `;
      employeesBody.appendChild(tr);
      if(isAdmin){
        const sel = tr.querySelector('select.role-select');
        if(sel) sel.value = u.role || 'agent';
      }
    }
  }

  function applyFilters(){
    const q = (searchInput.value||'').toLowerCase().trim();
    const role = (roleFilter.value||'all').toLowerCase();
    const status = (statusFilter.value||'all').toLowerCase();
    const timeRange = timeFilter.value;
    let start = null;
    if(timeRange==='1d'){ start = new Date(); start.setDate(start.getDate()-1); }
    if(timeRange==='7d'){ start = new Date(); start.setDate(start.getDate()-7); }
    if(timeRange==='30d'){ start = new Date(); start.setDate(start.getDate()-30); }

    filtered = employees.filter(u=>{
      if(role!=='all' && ((u.role||'').toLowerCase() !== role)) return false;
      if(status!=='all'){
        const on = isOnline(u.last_seen);
        if(status==='online' && !on) return false;
        if(status==='offline' && on) return false;
      }
      if(start){
        const ls = u.last_seen ? new Date(u.last_seen) : null;
        if(!ls || ls < start) return false;
      }
      if(q){
        const hay = `${u.name||''} ${u.email||''} ${u.last_activity||''}`.toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });
    currentPage = 1;
    renderTable(filtered);
    updateStats();
    updateCharts();
  }

  // CSV export
  function exportCSV(){
    const list = (filtered && filtered.length) ? filtered : employees;
    if(!list.length){ showToast('No data to export','warn'); return; }
    const headers = ['name','email','role','status','last_seen','last_activity'];
    const rows = [headers.join(',')];
    for(const u of list){
      const row = [
        `"${(u.name||'').replaceAll('"','""')}"`,
        `"${(u.email||'').replaceAll('"','""')}"`,
        `"${(u.role||'').replaceAll('"','""')}"`,
        `"${isOnline(u.last_seen)?'online':'offline'}"`,
        `"${(u.last_seen||'')}"`,
        `"${(u.last_activity||'')}"`,
      ];
      rows.push(row.join(','));
    }
    const csv = rows.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `employees_export_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Realtime: subscribe to users & activity_log
  function setupRealtime(){
    try{
      // channel for users
      supabase.channel('employees_channel')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, payload=>{
          const t = payload.eventType;
          if(t === 'INSERT'){ employees.unshift(payload.new); showToast(`${payload.new.name || payload.new.email} added`,'success'); }
          else if(t === 'UPDATE'){ const idx = employees.findIndex(x=>String(x.id)===String(payload.new.id)); if(idx>-1) employees[idx] = {...employees[idx], ...payload.new}; else employees.unshift(payload.new); showToast(`${payload.new.name || payload.new.email} updated`,'info'); }
          else if(t === 'DELETE'){ employees = employees.filter(x=>String(x.id)!==String(payload.old.id)); showToast(`${payload.old.name || payload.old.email} removed`,'warn'); }
          // refresh
          applyFilters();
          updateStats();
          updateCharts();
        }).subscribe();

      // activity log updates
      supabase.channel('activity_channel')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'activity_log' }, payload=>{
          const userId = payload.new ? payload.new.user_id : (payload.old ? payload.old.user_id : null);
          if(userId) refreshLastActivityFor(userId);
        }).subscribe();
    }catch(e){ console.error('realtime err', e); }
  }

  // refresh last activity for specific user (single query)
  async function refreshLastActivityFor(userId){
    if(!userId) return;
    try{
      const { data: act } = await supabase.from('activity_log').select('action,timestamp').eq('user_id', userId).order('timestamp',{ascending:false}).limit(1).maybeSingle();
      const idx = employees.findIndex(e=>String(e.id)===String(userId));
      if(idx>-1){ employees[idx].last_activity = act ? `${act.action} @ ${formatDateTime(act.timestamp)}` : '-'; applyFilters(); updateCharts(); }
    }catch(e){ console.error('refreshLastActivityFor', e); }
  }

  // update last_seen for current user (heartbeat)
  let heartbeatTimer = null;
  async function updateLastSeen(userId){
    if(!userId) return;
    try{
      await supabase.from('users').update({ last_seen: new Date().toISOString() }).eq('id', userId);
    }catch(e){ console.error('updateLastSeen', e); }
  }
  function resetHeartbeat(userId){
    updateLastSeen(userId);
    if(heartbeatTimer){ clearInterval(heartbeatTimer); }
    heartbeatTimer = setInterval(()=> updateLastSeen(userId), 60000);
  }

  // change role (admin only)
  async function changeUserRole(userId, newRole){
    try{
      const { error } = await supabase.from('users').update({ role: newRole }).eq('id', userId);
      if(error){ showToast('Role update failed','warn'); console.error(error); return; }
      const idx = employees.findIndex(e=>String(e.id)===String(userId));
      if(idx>-1){ employees[idx].role = newRole; applyFilters(); updateCharts(); }
      showToast('Role updated','success');
    }catch(e){ console.error('changeUserRole', e); showToast('Role update failed','error'); }
  }

  // admin guard: check current user and role
  async function checkAdminAndBoot(){
    showOverlay(true);
    try{
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if(userErr || !user){ // not logged in (or no user) -> restrict
        document.querySelector('.card').style.display = 'none';
        restrictedCard.style.display = 'flex';
        showOverlay(false);
        return null;
      }
      const { data, error } = await supabase.from('users').select('role,id').eq('id', user.id).single();
      if(error || !data || data.role !== 'admin'){ // not admin
        document.querySelector('.card').style.display = 'none';
        restrictedCard.style.display = 'flex';
        showOverlay(false);
        return null;
      }
      isAdmin = true;
      // start heartbeat and events
      updateLastSeen(data.id);
      document.addEventListener('mousemove', ()=> resetHeartbeat(data.id));
      document.addEventListener('keydown', ()=> resetHeartbeat(data.id));
      document.addEventListener('click', ()=> resetHeartbeat(data.id));
      heartbeatTimer = setInterval(()=> updateLastSeen(data.id), 60000);
      return data.id;
    }catch(e){ console.error('checkAdmin', e); showOverlay(false); return null; }
  }

  // delegated change handler for role selects
  document.addEventListener('change', (ev)=>{
    const target = ev.target;
    if(target && target.matches && target.matches('select.role-select')){
      const userId = target.getAttribute('data-id');
      const newRole = target.value;
      if(confirm(`Change role for this user to "${newRole}"?`)) changeUserRole(userId, newRole);
      else { applyFilters(); }
    }
  });

  // UI events
  applyBtn.addEventListener('click', ()=> applyFilters());
  clearBtn.addEventListener('click', ()=> { searchInput.value=''; roleFilter.value='all'; statusFilter.value='all'; timeFilter.value='all'; applyFilters(); });
  exportBtnTop.addEventListener('click', ()=> exportCSV());
  loadMoreBtn.addEventListener('click', ()=> { currentPage++; renderTable(filtered); });

  // boot
  (async function init(){
    document.getElementById('year').textContent = new Date().getFullYear();
    showOverlay(true);
    const adminId = await checkAdminAndBoot();
    if(!adminId){ showOverlay(false); return; }
    await fetchEmployees();
    setupRealtime();
    showOverlay(false);
  })();

  // small UX: show overlay spinner for initial load if long
  // (already used in fetchEmployees / admin check)

</script>

</body>
</html>
